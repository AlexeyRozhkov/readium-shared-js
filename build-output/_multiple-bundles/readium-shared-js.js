define("readium_shared_js/globals",["underscore","eventEmitter"],function(e,t){var i={version:function(){return"0.8.0"},Views:{ORIENTATION_LANDSCAPE:"orientation_landscape",ORIENTATION_PORTRAIT:"orientation_portrait"},Events:{READER_INITIALIZED:"ReaderInitialized",PAGINATION_CHANGED:"PaginationChanged",SETTINGS_APPLIED:"SettingsApplied",FXL_VIEW_RESIZED:"FXLViewResized",READER_VIEW_CREATED:"ReaderViewCreated",READER_VIEW_DESTROYED:"ReaderViewDestroyed",CONTENT_DOCUMENT_LOAD_START:"ContentDocumentLoadStart",CONTENT_DOCUMENT_LOADED:"ContentDocumentLoaded",MEDIA_OVERLAY_STATUS_CHANGED:"MediaOverlayStatusChanged",MEDIA_OVERLAY_TTS_SPEAK:"MediaOverlayTTSSpeak",MEDIA_OVERLAY_TTS_STOP:"MediaOverlayTTSStop",PLUGINS_LOADED:"PluginsLoaded"},InternalEvents:{CURRENT_VIEW_PAGINATION_CHANGED:"CurrentViewPaginationChanged"}};return e.extend(i,new t),i}),navigator.epubReadingSystem={name:"",version:"0.0.0",layoutStyle:"paginated",hasFeature:function(e,t){return t&&"1.0"!==t?!1:"dom-manipulation"===e?!0:"layout-changes"===e?!0:"touch-events"===e?!1:"mouse-events"===e?!0:"keyboard-events"===e?!0:"spine-scripting"===e?!0:!1}},define("readium_shared_js/globalsSetup",["console_shim","eventEmitter","URIjs","readium_cfi_js","./globals"],function(e,t,i,n,r){if(console.log("Globals..."),window.ReadiumSDK?(console.log("ReadiumSDK extend."),_.extend(window.ReadiumSDK,r)):(console.log("ReadiumSDK set."),window.ReadiumSDK=r),t.prototype.trigger=t.prototype.emit,window.EventEmitter=t,window.URI=i,"URL"in window==!1){if("webkitURL"in window==!1)throw Error("Browser does not support window.URL");window.URL=window.webkitURL}}),define("readium_shared_js",["readium_shared_js/globalsSetup"],function(e){return e}),define("readium_shared_js/plugins_controller",["jquery","underscore","eventEmitter","readium_shared_js/globals"],function(e,t,i,n){function r(e,n){this.reader=e,this.plugin=n,this.extendReader=function(r){if(e.plugins){var o={};o[n.name]=t.extend(r,new i),t(e.plugins).extend(o)}}}function o(e){this.create=function(t){return new r(e,t)}}function a(e,t,i){this.name=e,this.dependencies=t,this.initialized=!1,this.supported=!1,this.initializer=i}var s=function(){function e(e){var i=new o(e);if(e.plugins)throw new Error("Already initialized on reader!");e.plugins={},t.each(r,function(e){e().init(i)})}function i(e){return e.message||e.description||String(e)}var r={};this.register=function(e,t,n){if(r[e])throw new Error("Duplicate registration for plugin with name: "+e);r[e]=function(){var r;return"function"==typeof t?n=t:r=t,new a(e,r,function(e,t){if(!e.initialized){e.initialized=!0;try{n.call({},t),e.supported=!0}catch(r){e.fail(i(r))}}})}},n.on(n.Events.READER_INITIALIZED,function(r){try{e(r)}catch(o){console.error("Plugins failed to initialize:"+i(o))}t.defer(function(){n.emit(n.Events.PLUGINS_LOADED,r)})})};a.prototype={init:function(e){for(var t,i,n=this.dependencies||[],r=0,o=n.length;o>r;++r){if(i=n[r],t=Plugins[i],!(t&&t instanceof a))throw new Error("required Plugin '"+i+"' not found");if(t.init(e),!t.supported)throw new Error("required Plugin '"+i+"' not supported")}this.initializer(this,e.create(this))},fail:function(e){throw this.initialized=!0,this.supported=!1,new Error("Plugin '"+this.name+"' failed to load: "+e)},warn:function(e){console.warn("Plugin "+this.name+": "+e)},deprecationNotice:function(e,t){console.warn("DEPRECATED: "+e+" in Plugin "+this.name+"is deprecated. Please use "+t+" instead")},createError:function(e){return new Error("Error in "+this.name+" Plugin: "+e)}};var l=new s;return n.Plugins=l,l}),define("readium_shared_js/models/bookmark_data",[],function(){var e=function(e,t){this.idref=e,this.contentCFI=t,this.toString=function(){return JSON.stringify(this)}};return e}),define("readium_shared_js/models/current_pages_info",[],function(){var e=function(e,t){this.isRightToLeft=e.isRightToLeft(),this.isFixedLayout=t,this.spineItemCount=e.items.length,this.openPages=[],this.addOpenPage=function(e,t,i,n){this.openPages.push({spineItemPageIndex:e,spineItemPageCount:t,idref:i,spineItemIndex:n}),this.sort()},this.canGoLeft=function(){return this.isRightToLeft?this.canGoNext():this.canGoPrev()},this.canGoRight=function(){return this.isRightToLeft?this.canGoPrev():this.canGoNext()},this.canGoNext=function(){if(0==this.openPages.length)return!1;var t=this.openPages[this.openPages.length-1];return t.spineItemIndex<e.last().index||t.spineItemPageIndex<t.spineItemPageCount-1},this.canGoPrev=function(){if(0==this.openPages.length)return!1;var t=this.openPages[0];return e.first().index<t.spineItemIndex||0<t.spineItemPageIndex},this.sort=function(){this.openPages.sort(function(e,t){return e.spineItemIndex!=t.spineItemIndex?e.spineItemIndex-t.spineItemIndex:e.pageIndex-t.pageIndex})}};return e}),define("readium_shared_js/models/fixed_page_spread",[],function(){var e=function(t,i){function n(){s.leftItem=void 0,s.rightItem=void 0,s.centerItem=void 0}function r(t,i){i==e.POSITION_LEFT?s.leftItem=t:i==e.POSITION_RIGHT?s.rightItem=t:(i!=e.POSITION_CENTER&&console.error("Unrecognized position value"),s.centerItem=t)}function o(t){return l?t.isLeftPage()?e.POSITION_LEFT:t.isRightPage()?e.POSITION_RIGHT:e.POSITION_CENTER:e.POSITION_CENTER}function a(e){return e.isLeftPage()?s.spine.isRightToLeft()?s.spine.prevItem(e):s.spine.nextItem(e):e.isRightPage()?s.spine.isRightToLeft()?s.spine.nextItem(e):s.spine.prevItem(e):void 0}var s=this;this.spine=t,this.leftItem=void 0,this.rightItem=void 0,this.centerItem=void 0;var l=i;this.setSyntheticSpread=function(e){l=e},this.isSyntheticSpread=function(){return l},this.openFirst=function(){0==this.spine.items.length?n():this.openItem(this.spine.first())},this.openLast=function(){0==this.spine.items.length?n():this.openItem(this.spine.last())},this.openItem=function(t){n();var i=o(t);if(r(t,i),i!=e.POSITION_CENTER&&this.spine.isValidLinearItem(t.index)){var s=a(t);if(s){var l=o(s);l!=i&&l!=e.POSITION_CENTER&&!s.isReflowable()&&s.isRenditionSpreadAllowed()&&r(s,l)}}},this.openNext=function(){var e=this.validItems();if(0==e.length)this.openFirst();else{var t=this.spine.nextItem(e[e.length-1]);t&&this.openItem(t)}},this.openPrev=function(){var e=this.validItems();if(0==e.length)this.openLast();else{var t=this.spine.prevItem(e[0]);t&&this.openItem(t)}},this.validItems=function(){var e=[];return this.leftItem&&e.push(this.leftItem),this.rightItem&&e.push(this.rightItem),this.centerItem&&e.push(this.centerItem),e.sort(function(e,t){return e.index-t.index}),e}};return e.POSITION_LEFT="left",e.POSITION_RIGHT="right",e.POSITION_CENTER="center",e}),define("readium_shared_js/models/spine_item",[],function(){var e=function(t,i,n){function r(){a.page_spread&&a.page_spread!=e.SPREAD_LEFT&&a.page_spread!=e.SPREAD_RIGHT&&a.page_spread!=e.SPREAD_CENTER&&console.error(a.page_spread+" is not a recognized spread type")}function o(e,t){return a[e]?a[e]===t:a.spine["package"][e]?a.spine["package"][e]===t:!1}var a=this;this.idref=t.idref,this.href=t.href,this.linear=t.linear?t.linear.toLowerCase():t.linear,this.page_spread=t.page_spread,this.rendition_viewport=t.rendition_viewport,this.rendition_spread=t.rendition_spread,this.rendition_orientation=t.rendition_orientation,this.rendition_layout=t.rendition_layout,this.rendition_flow=t.rendition_flow,this.media_overlay_id=t.media_overlay_id,this.media_type=t.media_type,this.index=i,this.spine=n,r(),this.setSpread=function(e){this.page_spread=e,r()},this.isRenditionSpreadAllowed=function(){var t=a.getRenditionSpread();return!t||t!=e.RENDITION_SPREAD_NONE},this.isLeftPage=function(){return a.page_spread==e.SPREAD_LEFT},this.isRightPage=function(){return a.page_spread==e.SPREAD_RIGHT},this.isCenterPage=function(){return a.page_spread==e.SPREAD_CENTER},this.isReflowable=function(){return!a.isFixedLayout()},this.isFixedLayout=function(){var t=a.getRenditionLayout();if(t){if(a.rendition_layout){if(a.rendition_layout===e.RENDITION_LAYOUT_PREPAGINATED)return!0;if(a.rendition_layout===e.RENDITION_LAYOUT_REFLOWABLE)return!1}return a.spine["package"].isFixedLayout()}return a.media_type.indexOf("image/")>=0},this.getRenditionFlow=function(){return a.rendition_flow?a.rendition_flow:a.spine["package"].rendition_flow},this.getRenditionViewport=function(){return a.rendition_viewport?a.rendition_viewport:a.spine["package"].rendition_viewport},this.getRenditionSpread=function(){return a.rendition_spread?a.rendition_spread:a.spine["package"].rendition_spread},this.getRenditionOrientation=function(){return a.rendition_orientation?a.rendition_orientation:a.spine["package"].rendition_orientation},this.getRenditionLayout=function(){return a.rendition_layout?a.rendition_layout:a.spine["package"].rendition_layout},this.isFlowScrolledContinuous=function(){return o("rendition_flow",e.RENDITION_FLOW_SCROLLED_CONTINUOUS)},this.isFlowScrolledDoc=function(){return o("rendition_flow",e.RENDITION_FLOW_SCROLLED_DOC)}};return e.RENDITION_LAYOUT_REFLOWABLE="reflowable",e.RENDITION_LAYOUT_PREPAGINATED="pre-paginated",e.RENDITION_ORIENTATION_LANDSCAPE="landscape",e.RENDITION_ORIENTATION_PORTRAIT="portrait",e.RENDITION_ORIENTATION_AUTO="auto",e.SPREAD_LEFT="page-spread-left",e.SPREAD_RIGHT="page-spread-right",e.SPREAD_CENTER="page-spread-center",e.RENDITION_SPREAD_NONE="none",e.RENDITION_SPREAD_LANDSCAPE="landscape",e.RENDITION_SPREAD_PORTRAIT="portrait",e.RENDITION_SPREAD_BOTH="both",e.RENDITION_SPREAD_AUTO="auto",e.RENDITION_FLOW_PAGINATED="paginated",e.RENDITION_FLOW_SCROLLED_CONTINUOUS="scrolled-continuous",e.RENDITION_FLOW_SCROLLED_DOC="scrolled-doc",e.RENDITION_FLOW_AUTO="auto",e.alternateSpread=function(t){return t===e.SPREAD_LEFT?e.SPREAD_RIGHT:t===e.SPREAD_RIGHT?e.SPREAD_LEFT:t},e}),define("readium_shared_js/helpers",["underscore","jquery","jquerySizes","./models/spine_item","./globals"],function(e,t,i,n,r){var o={};return o.getURLQueryParams=function(){var e={},t=window.location.search;if(t&&t.length){t=t.substring(1);for(var i=t.split("&"),n=0;n<i.length;n++){var r=i[n].split("=");r.length>1&&(e[r[0]]=decodeURIComponent(r[1]))}}return e},o.Rect=function(e,t,i,n){this.left=e,this.top=t,this.width=i,this.height=n,this.right=function(){return this.left+this.width},this.bottom=function(){return this.top+this.height},this.isOverlap=function(e,t){return void 0==t&&(t=0),!(e.right()<this.left+t||e.left>this.right()-t||e.bottom()<this.top+t||e.top>this.bottom()-t)}},o.Rect.fromElement=function(t){var i;i=e.isArray(t)||t instanceof jQuery?t[0]:t,3===i.nodeType&&(i=t.parent()[0]);for(var n=i.offsetLeft,r=i.offsetTop,a=i.offsetWidth,s=i.offsetHeight;i=i.offsetParent;)n+=i.offsetLeft,r+=i.offsetTop;return new o.Rect(n,r,a,s)},o.UpdateHtmlFontSize=function(e,i){for(var n,r=i/100,o=e[0].ownerDocument.defaultView,a=t("p, div, span, h1, h2, h3, h4, h5, h6, li, blockquote, td, pre",e),s=0;s<a.length;s++){var l=a[s],d=l.getAttribute("data-original-font-size");if(!d){var u=o.getComputedStyle(l),c=parseInt(u.fontSize);n=parseInt(u.lineHeight),l.setAttribute("data-original-font-size",c),n&&l.setAttribute("data-original-line-height",n)}}n=0;for(var s=0;s<a.length;s++){var l=a[s],d=l.getAttribute("data-original-font-size"),f=l.getAttribute("data-original-line-height"),c=Number(d);n=f?Number(f):0,l.style.fontSize=c*r+"px",n&&(l.style.lineHeight=n*r+"px")}e.css("font-size",i+"%")},o.ResolveContentRef=function(e,t){if(!t)return e;var i=t.split("/");i.pop();for(var n=e.split("/");i.length>0&&".."===n[0];)i.pop(),n.splice(0,1);var r=i.concat(n);return r.join("/")},o.EndsWith=function(e,t){return-1!==e.indexOf(t,e.length-t.length)},o.BeginsWith=function(e,t){return 0===e.indexOf(t)},o.RemoveFromString=function(e,t){var i=e.indexOf(t);return-1==i?e:e.substring(0,i)+e.substring(i+t.length)},o.Margins=function(e,t,i){this.margin=e,this.border=t,this.padding=i,this.left=this.margin.left+this.border.left+this.padding.left,this.right=this.margin.right+this.border.right+this.padding.right,this.top=this.margin.top+this.border.top+this.padding.top,this.bottom=this.margin.bottom+this.border.bottom+this.padding.bottom,this.width=function(){return this.left+this.right},this.height=function(){return this.top+this.bottom}},o.triggerLayout=function(e){var t=e[0].contentDocument;if(t){var i=void 0;try{if(i=t.styleSheets&&t.styleSheets.length?t.styleSheets[0]:void 0,!i){var n=t.createElement("style");t.head.appendChild(n),n.appendChild(t.createTextNode("")),i=n.sheet}if(i){var r="body:first-child::before {content:'READIUM';color: red;font-weight: bold;}";i.cssRules?i.insertRule(r,i.cssRules.length):i.insertRule(r,0)}}catch(o){console.error(o)}try{var a=t.createElementNS("http://www.w3.org/1999/xhtml","style");a.appendChild(t.createTextNode("*{}")),t.body.appendChild(a),t.body.removeChild(a),i&&i.deleteRule(i.cssRules?i.cssRules.length-1:0)}catch(o){console.error(o)}if(t.body){t.body.offsetTop}}},o.deduceSyntheticSpread=function(e,t,i){if(!e||0==e.length)return 0;var a=t?t.getRenditionSpread():void 0;if(a===n.RENDITION_SPREAD_NONE)return!1;if("double"==i.syntheticSpread)return!0;if("single"==i.syntheticSpread)return!1;if(!t)return 0;if(a===n.RENDITION_SPREAD_BOTH)return!0;var s=o.getOrientation(e);if(a===n.RENDITION_SPREAD_LANDSCAPE)return s===r.Views.ORIENTATION_LANDSCAPE;if(a===n.RENDITION_SPREAD_PORTRAIT)return s===r.Views.ORIENTATION_PORTRAIT;if(!a||a===n.RENDITION_SPREAD_AUTO){var l=s===r.Views.ORIENTATION_LANDSCAPE;return l?1:0}return console.warn("Helpers.deduceSyntheticSpread: spread properties?!"),0},o.Margins.fromElement=function(e){return new this(e.margin(),e.border(),e.padding())},o.Margins.empty=function(){return new this({left:0,right:0,top:0,bottom:0},{left:0,right:0,top:0,bottom:0},{left:0,right:0,top:0,bottom:0})},o.loadTemplate=function(e){return o.loadTemplate.cache[e]},o.loadTemplate.cache={fixed_book_frame:'<div id="fixed-book-frame" class="clearfix book-frame fixed-book-frame"></div>',single_page_frame:'<div><div id="scaler"><iframe scrolling="no" class="iframe-fixed"></iframe></div></div>',scrolled_book_frame:'<div id="reflowable-book-frame" class="clearfix book-frame reflowable-book-frame"><div id="scrolled-content-frame"></div></div>',reflowable_book_frame:'<div id="reflowable-book-frame" class="clearfix book-frame reflowable-book-frame"></div>',reflowable_book_page_frame:'<div id="reflowable-content-frame" class="reflowable-content-frame"><iframe scrolling="no" id="epubContentIframe"></iframe></div>'},o.setStyles=function(e,i){var n=e.length;if(n)for(var r=0;n>r;r++){var o=e[r];o.selector?t(o.selector,i).css(o.declarations):i.css(o.declarations)}},o.isIframeAlive=function(e){var t=void 0,i=void 0;try{t=e.contentWindow,i=e.contentDocument}catch(n){return console.error(n),!1}return t&&i},o.getOrientation=function(e){var t=e.width(),i=e.height();return t&&i?t>=i?r.Views.ORIENTATION_LANDSCAPE:r.Views.ORIENTATION_PORTRAIT:void 0},o.isRenditionSpreadPermittedForItem=function(e,t){var i=e.getRenditionSpread();return!i||i==n.RENDITION_SPREAD_BOTH||i==n.RENDITION_SPREAD_AUTO||i==n.RENDITION_SPREAD_LANDSCAPE&&t==r.Views.ORIENTATION_LANDSCAPE||i==n.RENDITION_SPREAD_PORTRAIT&&t==r.Views.ORIENTATION_PORTRAIT},o.CSSTransition=function(t,i){var n={};e.each(["","-webkit-","-moz-","-ms-"],function(e){n[e+"transition"]=e+i}),t.css(n)},o.CSSTransformString=function(e){var t,i,n,r=e.enable3D?!0:!1,o=e.origin;if(e.left||e.top){var a=e.left||0,s=e.top||0;t=r?"translate3D("+a+"px, "+s+"px, 0)":"translate("+a+"px, "+s+"px)"}if(e.scale&&(i=r?"scale3D("+e.scale+", "+e.scale+", 0)":"scale("+e.scale+")"),e.angle&&(n=r?"rotate3D(0,0,"+e.angle+"deg)":"rotate("+e.angle+"deg)"),!(t||i||n))return{};var l=t&&i?t+" "+i:t?t:i;n&&(l=l+" "+n);var d={};return d.transform=l,d["transform-origin"]=o?o:r?"0 0 0":"0 0",d},o.extendedThrottle=function(e,t,i,n,r,o){n||(n=250),r||(r=n);var a,s,l=!0;return function(){var d=o||this,u=Date.now&&Date.now()||(new Date).getTime(),c=arguments;a&&a+n>u||(a=u,l?(e.apply(d,c),l=!1):t.apply(d,c)),clearTimeout(s),s=setTimeout(function(){a=u,l=!0,i.apply(d,c)},r)}},o.escapeJQuerySelector=function(e){if(!e)return void 0;var t=e.replace(/([;&,\.\+\*\~\?':"\!\^#$%@\[\]\(\)<=>\|\/\\{}`])/g,"\\$1");return t},o}),define("readium_shared_js/views/cfi_navigation_logic",["jquery","underscore","../helpers","readium_cfi_js"],function(e,t,i){var n=function(n,r,o){function a(){return o.paginationInfo&&!!o.paginationInfo.rightToLeft}function s(){return o.paginationInfo&&!!o.paginationInfo.isVerticalWritingMode}function l(e,t,i){return i?e.top>=0&&e.top<t.height:e.left>=0&&e.left<t.width}function d(){return!o.paginationInfo||s()?r.width():o.paginationInfo.columnWidth+o.paginationInfo.columnGap}function u(){return s()?{top:o.paginationInfo?o.paginationInfo.pageOffset:0}:{left:(o.paginationInfo?o.paginationInfo.pageOffset:0)*(a()?-1:1)}}function c(e,n,r){var o=i.Rect.fromElement(e);t.isNaN(o.left)&&(o=new i.Rect(e.position().top,e.position().left,0,0));var a=n.top||0,s=o.bottom()>a,l=void 0!==n.bottom?o.top<n.bottom:!0,d=0;return s&&l?r?(o.top<=a&&(d=Math.ceil(100*(a-o.top)/o.height)),100-d):100:0}function f(e,t,i){var n=p(e),o=n.clientRectangles;if(0===o.length)return null;var u=a(),c=s(),f=d(),h={width:r.width(),height:r.height()};1===o.length&&I(o[0],h,f,u,c,!0);for(var g=0,v=0,y=o.length;y>v;++v)if(l(o[v],h,c)){g=i?m(o,v):100;break}return g}function h(e,i){var n=u(),l=p(e,n),c=l.clientRectangles;if(0===c.length)return null;var f=a(),h=s(),m=d(),g=r.height(),v=r.width();i&&y(c,i,g,m,f,h);var E=t.first(c);1===c.length&&I(E,{height:g,width:v},m,f,h);var _;if(h){var S=E.top;_=Math.floor(S/g)}else{var P=E.left;f&&(P=m*(o.paginationInfo?o.paginationInfo.visibleColumnCount:1)-P),_=Math.floor(P/m)}return 0>_?_=0:_>=(o.paginationInfo?o.paginationInfo.columnCount:1)&&(_=o.paginationInfo?o.paginationInfo.columnCount-1:0),_}function m(e,i){var n=0,r=0;return e.length>1?t.each(e,function(e,t){n+=e.height,t>=i&&(r+=e.height)}):(n=e[0].height,r=e[0].height-Math.max(0,-e[0].top)),r===n?100:Math.floor(100*r/n)}function p(e,t){t=t||{};for(var i=t.left||0,n=t.top||0,r=g(e[0].getBoundingClientRect(),i,n),o=[],a=e[0].getClientRects(),s=0,l=a.length;l>s;++s)a[s].height>0&&o.push(g(a[s],i,n));return 0===o.length&&(e=e.next(),e.length)?p(e,t):{wrapperRectangle:r,clientRectangles:o}}function g(e,t,i){var n={left:e.left,right:e.right,top:e.top,bottom:e.bottom,width:e.right-e.left,height:e.bottom-e.top};return v(n,t,i),n}function v(e,t,i){e.left+=t,e.right+=t,e.top+=i,e.bottom+=i}function I(e,t,i,n,r,o){if(!r){for(n&&(i*=-1);e.top<0;)v(e,-i,t.height);if(o)for(;e.bottom>=t.height&&!l(e,t,r);)v(e,i,-t.height)}}function y(e,i,n,r,o,a){if(!a){var s=t.reduce(e,function(e,t){return e+t.height},0),l=s*i/100;if(e.length>1){var d=0;do{if(d+=e[0].height,d>l)break;e.shift()}while(e.length>1)}else{for(o&&(r*=-1);e[0].bottom>=n;)v(e[0],r,-n);e[0].top+=l,e[0].height-=l}}}function E(e,t,i,n){var o=r[0].contentDocument,a="epubcfi("+e+")",s=EPUBcfi.getTargetElementWithPartialCFI(a,o,t,i,n);return s&&0!=s.length?s:void console.log("Can't find element for CFI: "+e)}function _(e){var t={cfi:"",x:0,y:0},i=e.indexOf("@");if(-1!=i){var n=e.substring(i+1),r=n.indexOf(":");-1!=r?(t.x=parseInt(n.substr(0,r)),t.y=parseInt(n.substr(r+1))):console.log("Unexpected terminating step format"),t.cfi=e.substring(0,i)}else t.cfi=e;return t}function S(e){if(e.nodeType===Node.TEXT_NODE){var t=e.nodeValue.replace(/\n/g,"");return t=t.replace(/ /g,""),t.length>0}return!1}o=o||{},this.getRootElement=function(){return r[0].contentDocument.documentElement};var P=o.rectangleBased?f:c;this.findFirstVisibleElement=function(t){"object"!=typeof t&&(t={top:t});var i,n=null,r=0;return i=e("body",this.getRootElement()).find(":not(iframe)").contents().filter(function(){return S(this)||"img"===this.nodeName.toLowerCase()}),e.each(i,function(){var i;i=this.nodeType===Node.TEXT_NODE?e(this).parent():e(this);var o=P(i,t,!0);return o?(n=i,r=100-o,!1):!0}),{$element:n,percentY:r}},this.getFirstVisibleElementCfi=function(e){var t=this.findFirstVisibleElement(e);if(!t.$element)return void console.log("Could not generate CFI no visible element on page");var i=EPUBcfi.Generator.generateElementCFIComponent(t.$element[0]);return"!"==i[0]&&(i=i.substring(1)),i+"@0:"+t.percentY},this.getPageForElementCfi=function(e,t,i,n){var r=_(e),o=E(r.cfi,t,i,n);return o?this.getPageForPointOnElement(o,r.x,r.y):-1},this.getElementByCfi=function(e,t,i,n){var r=_(e);return E(r.cfi,t,i,n)},this.getPageForElement=function(e){return this.getPageForPointOnElement(e,0,0)},this.getPageForPointOnElement=function(e,t,i){var r;if(o.rectangleBased)return r=h(e,i),null===r?(console.warn("Impossible to locate a hidden element: ",e),0):r;var a=this.getVerticalOffsetForPointOnElement(e,t,i);return Math.floor(a/n.height())},this.getVerticalOffsetForElement=function(e){return this.getVerticalOffsetForPointOnElement(e,0,0)},this.getVerticalOffsetForPointOnElement=function(e,t,n){var r=i.Rect.fromElement(e);return Math.ceil(r.top+n*r.height/100)},this.getElementById=function(t){var i=r[0].contentDocument,n=e(i.getElementById(t));return 0==n.length?void 0:n},this.getPageForElementId=function(e){var t=this.getElementById(e);return t?this.getPageForElement(t):-1},this.getFirstVisibleMediaOverlayElement=function(t){function i(n){if(!n||!n.length)return void 0;for(var r=0,s=n.length;s>r;r++){var l=n[r];if(l){var d=e(l);if(d.data("mediaOverlayData")){var u=o.getElementVisibility(d,t);if(u&&(a||(a=l),100==u))return l}else{var c=i(l.children);if(c)return c}}}return void 0}var n=this.getRootElement();if(!n)return void 0;var r=e("body",n);if(!r||!r.length||!r[0])return void 0;var o=this,a=void 0,s=i([r[0]]);return s||(s=a),s},this.getElementVisibility=function(e,t){return P(e,t,!0)},this.isElementVisible=P,this.getElement=function(t){var i=e(t,this.getRootElement());return i.length>0?i:void 0}};return n}),define("readium_shared_js/models/viewer_settings",[],function(){var e=function(e){function t(e){for(var t=[],i=e.split(/[\s,;]+/),n=0;n<i.length;n++){var r=i[n].trim();""!==r&&t.push(r)}return t}function i(e,t,i){void 0!==t[e]&&(n[e]=i?i(t[e]):t[e])}var n=this;this.syntheticSpread="auto",this.fontSize=100,this.columnGap=20,this.mediaOverlaysPreservePlaybackWhenScroll=!1,this.mediaOverlaysSkipSkippables=!1,this.mediaOverlaysEscapeEscapables=!0,this.mediaOverlaysSkippables=[],this.mediaOverlaysEscapables=[],this.mediaOverlaysEnableClick=!0,this.mediaOverlaysRate=1,this.mediaOverlaysVolume=100,this.mediaOverlaysSynchronizationGranularity="",this.mediaOverlaysAutomaticPageTurn=!0,this.enableGPUHardwareAccelerationCSS3D=!1,this.pageTransition=-1,this.scroll="auto",this.update=function(e){i("columnGap",e),i("fontSize",e),i("mediaOverlaysPreservePlaybackWhenScroll",e),i("mediaOverlaysSkipSkippables",e),i("mediaOverlaysEscapeEscapables",e),i("mediaOverlaysSkippables",e,t),i("mediaOverlaysEscapables",e,t),i("mediaOverlaysEnableClick",e),i("mediaOverlaysRate",e),i("mediaOverlaysVolume",e),i("mediaOverlaysSynchronizationGranularity",e),i("mediaOverlaysAutomaticPageTurn",e),i("scroll",e),i("syntheticSpread",e),i("pageTransition",e),i("enableGPUHardwareAccelerationCSS3D",e)},this.update(e)};return e}),define("readium_shared_js/views/one_page_view",["jquery","underscore","eventEmitter","./cfi_navigation_logic","../helpers","../models/viewer_settings"],function(e,t,i,n,r,o){var a=function(s,l,d,u){function c(t){if(t){b=!0;var i=I[0].contentDocument;g=e("html",i),g&&0!=g.length||(g=e("svg",i)),x&&_.applyBookStyles(),m(),C.onIFrameLoad()}}function f(){x&&g&&D&&r.UpdateHtmlFontSize(g,D.fontSize)}function h(){if(!I||!I.length)return 0;if(r.isIframeAlive(I[0])){var e=I[0].contentWindow,t=I[0].contentDocument,i=Math.round(parseFloat(e.getComputedStyle(t.documentElement).height));return i}if(g){console.error("getContentDocHeight ??");var n=g.height();return n}return 0}function m(){R.width=0,R.height=0;var t=void 0,i=!1,n=void 0,r=void 0,o=I[0].contentDocument,a=e("meta[name=viewport]",o).attr("content");if(a||(a=e("meta[name=viewbox]",o).attr("content")),a&&(t=p(a)),!t&&o&&o.documentElement&&o.documentElement.nodeName&&"svg"==o.documentElement.nodeName.toLowerCase()){var s=void 0,l=void 0,d=o.documentElement.getAttribute("width"),u=d&&d.length>=1&&"%"==d[d.length-1];if(d)try{s=parseInt(d,10)}catch(c){}s&&u&&(n=s,s=void 0);var f=o.documentElement.getAttribute("height"),h=f&&f.length>=1&&"%"==f[f.length-1];if(f)try{l=parseInt(f,10)}catch(c){}l&&h&&(r=l,l=void 0),s&&l&&(t={width:s,height:l})}if(!t&&y&&(a=y.getRenditionViewport(),a&&(t=p(a),t&&console.log("Viewport: using rendition:viewport dimensions"))),!t){var m=e(o).find("img");if(m.length>0){t={width:m.width(),height:m.height()};var g=y&&y.media_type&&y.media_type.length&&0==y.media_type.indexOf("image/");g||console.warn("Viewport: using img dimensions!")}else if(m=e(o).find("image"),m.length>0){var s=void 0,l=void 0,d=m[0].getAttribute("width");if(d)try{s=parseInt(d,10)}catch(c){}var f=m[0].getAttribute("height");if(f)try{l=parseInt(f,10)}catch(c){}s&&l&&(t={width:s,height:l},i=!0,console.warn("Viewport: using image dimensions!"))}}if(!t){s=w.width(),l=w.height();var v=e("iframe.iframe-fixed",w).length>1;v&&(s*=.5),n&&(s*=n/100),r&&(l*=r/100),t={width:s,height:l},i=!0,console.warn("Viewport: using browser / e-reader viewport dimensions!")}t&&(R.width=t.width,R.height=t.height)}function p(e){for(var t=e.replace(/\s/g,"").split(","),i={},n=0;n<t.length;n++){var r=t[n].split("=");2==r.length&&(i[r[0]]=r[1])}var o=Number.NaN,a=Number.NaN;return i.width&&(o=parseInt(i.width)),i.height&&(a=parseInt(i.height)),isNaN(o)||isNaN(a)?void 0:{width:o,height:a}}t.extend(this,new i);var g,v,I,y,E,_=this,S=s.spine,P=s.iframeLoader,T=s.bookStyles,w=s.$viewport,b=!1,O=function(e){var t=function(e,t){this.begin=e,this.end=t},i=new t(function(e,t,i,n){n.css("opacity","0")},function(e,t,i,n){n.css("transform","none"),r.CSSTransition(n,"opacity 150ms ease-out"),n.css("opacity","1")}),n=new t(function(e,t,i,n,o,a,s){n.css("opacity","0");var l=Math.ceil(o*e),d=.8*l*(2===s?1:-1),u=r.CSSTransformString({left:Math.round(d),origin:"50% 50% 0",enable3D:f});n.css(u)},function(e,t,i,n){n.css("opacity","1"),r.CSSTransition(n,"transform 150ms ease-out"),n.css("transform","none")}),a=new t(function(e,t,i,n,o,a,s){n.css("opacity","0");var l=Math.ceil(o*e),d=1.7*l*(2===s?1:-1),u=r.CSSTransformString({left:Math.round(d),angle:30*(2===s?-1:1),origin:"50% 50% 0",enable3D:f});n.css(u)},function(e,t,i,n){n.css("opacity","1"),r.CSSTransition(n,"transform 300ms ease-in-out"),n.css("transform","none")}),s=new t(function(e,t,i,n,o,a,s){n.css("opacity","0");for(var d=!1,u=!1,c=!1,h=0;h<l.length;h++){var m=l[h].toLowerCase();if(m.indexOf("left")>=0){d=!0;break}if(m.indexOf("right")>=0){c=!0;break}if(m.indexOf("center")>=0){u=!0;break}}var p=Math.ceil(o*e),g=.5*p*(d||u&&1===s?1:-1),v=r.CSSTransformString({scale:.2,left:Math.round(g),angle:30*(d||u&&1===s?1:-1),origin:"50% 50% 0",enable3D:f});n.css(v)},function(e,t,i,n){n.css("opacity","1"),r.CSSTransition(n,"transform 400ms ease-out"),n.css("transform","none")}),d=[];d.push(i),d.push(n),d.push(a),d.push(s);var u=e.disablePageTransitions||!1,c=-1,f=new o({}).enableGPUHardwareAccelerationCSS3D,h=void 0;this.updateOptions=function(e){h=e;var t=h;t&&"undefined"!=typeof t.enableGPUHardwareAccelerationCSS3D||(t=new o({})),t.enableGPUHardwareAccelerationCSS3D&&(f=!0),null!==e.pageTransition&&"undefined"!=typeof e.pageTransition&&(c=e.pageTransition)},this.updateOptions(e);var m=0,p=!1,g=!1;this.updatePageSwitchDir=function(e,t){g||(m=e,p=t)},this.onIFrameLoad=function(){g=!0},this.transformContentImmediate_BEGIN=function(e,t,i,n){var o=p||g;if(g=!1,!u&&-1!==c&&(r.CSSTransition(e,"all 0 ease 0"),o)){var a=c>=0&&c<d.length?d[c]:void 0;0!==m&&a?a.begin(t,i,n,e,_.meta_width(),_.meta_height(),m):e.css("opacity","0")}},this.transformContentImmediate_END=function(e,t,i,n){return u||-1===c?void e.css("transform","none"):void setTimeout(function(){var o=c>=0&&c<d.length?d[c]:void 0;0!==m&&o?o.end(t,i,n,e,_.meta_width(),_.meta_height(),m):(e.css("transform","none"),r.CSSTransition(e,"opacity 250ms linear"),e.css("opacity","1"))},10)}},C=new O(s),x=d||!1,R={width:0,height:0};this.element=function(){return v},this.meta_height=function(){return R.height},this.meta_width=function(){return R.width},this.isDisplaying=function(){return b},this.render=function(){var t=r.loadTemplate("single_page_frame",{});v=e(t),E=e("#scaler",v),r.CSSTransition(v,"all 0 ease 0"),v.css("transform","none");var i=u.viewerSettings();i&&"undefined"!=typeof i.enableGPUHardwareAccelerationCSS3D||(i=new o({})),i.enableGPUHardwareAccelerationCSS3D&&v.css("transform","translateZ(0)"),v.css("height","100%"),v.css("width","100%");for(var n=0,a=l.length;a>n;n++)v.addClass(l[n]);return I=e("iframe",v),this},this.decorateIframe=function(){I&&I.length&&(I.css("border-bottom","1px dashed silver"),I.css("border-top","1px dashed silver"))},this.remove=function(){b=!1,y=void 0,v.remove()},this.clear=function(){b=!1,I[0].src=""},this.currentSpineItem=function(){return y};var D=void 0;this.setViewSettings=function(e){D=e,x&&_.applyBookStyles(),m(),C.updateOptions(e)},this.applyBookStyles=function(){x&&g&&(r.setStyles(T.getStyles(),g),f())},this.scaleToWidth=function(e){if(!(R.width<=0)){var t=e/R.width;_.transformContentImmediate(t,0,0)}},this.resizeIFrameToContent=function(){var e=h();_.setHeight(e),_.showIFrame()},this.setHeight=function(e){E.css("height",e+"px"),v.css("height",e+"px")};var N=!0;this.showIFrame=function(){if(I.css("visibility","visible"),N){I.css("transform","none");var e=!1,t=D;t&&"undefined"!=typeof t.enableGPUHardwareAccelerationCSS3D||(t=new o({})),t.enableGPUHardwareAccelerationCSS3D&&(e=!0,I.css("transform","translateZ(0)"))}else I.css({left:"0px",top:"0px"})},this.hideIFrame=function(){if(I.css("visibility","hidden"),N){var e=!1,t=D;t&&"undefined"!=typeof t.enableGPUHardwareAccelerationCSS3D||(t=new o({})),t.enableGPUHardwareAccelerationCSS3D&&(e=!0);var i=r.CSSTransformString({left:"10000",top:"10000",enable3D:e});I.css(i)}else I.css({left:"10000px",top:"10000px"})},this.updatePageSwitchDir=function(e,t){C.updatePageSwitchDir(e,t)},this.transformContentImmediate=function(e,t,i){var n=Math.ceil(R.width*e),a=Math.floor(R.height*e);if(C.transformContentImmediate_BEGIN(v,e,t,i),v.css("left",t+"px"),v.css("top",i+"px"),v.css("width",n+"px"),v.css("height",a+"px"),g){var s=!1,l=D;if(l&&"undefined"!=typeof l.enableGPUHardwareAccelerationCSS3D||(l=new o({})),l.enableGPUHardwareAccelerationCSS3D&&(s=!0),u.needsFixedLayoutScalerWorkAround()){var d=r.CSSTransformString({scale:e,enable3D:s});g.css(d);var c=r.CSSTransformString({scale:1,enable3D:s});c.width=R.width*e,c.height=R.height*e,E.css(c)}else{var f=r.CSSTransformString({scale:e,enable3D:s});f.width=R.width,f.height=R.height,E.css(f)}g.css("opacity","0.999"),_.showIFrame(),setTimeout(function(){g.css("opacity","1")},0),C.transformContentImmediate_END(v,e,t,i)}},this.getCalculatedPageHeight=function(){return v.height()},this.transformContent=t.bind(t.debounce(this.transformContentImmediate,50),_),this.loadSpineItem=function(e,t,i){if(y!=e){y=e;var n=S["package"].resolveRelativeUrl(e.href);_.hideIFrame(),_.emit(a.SPINE_ITEM_OPEN_START,I,y),P.loadIframe(I[0],n,function(n){if(n&&t){var o=function(){t(n,I,y,!0,i)};r.isIframeAlive(I[0])?(c(n),o()):(console.error("onIFrameLoad !! doc && win + TIMEOUT"),console.debug(e.href),c(n),setTimeout(o,500))}else c(n)},_,{spineItem:y})}else t&&t(!0,I,y,!1,i)},this.getFirstVisibleElementCfi=function(){var e=new n(v,I);return e.getFirstVisibleElementCfi(0)},this.getNavigator=function(){return new n(v,I)},this.getElementByCfi=function(e,t,i,r,o){if(e!=y)return void console.error("spine item is not loaded");var a=new n(v,I);return a.getElementByCfi(t,i,r,o)},this.getElementById=function(e,t){if(e!=y)return void console.error("spine item is not loaded");var i=new n(v,I);return i.getElementById(t)},this.getElement=function(e,t){if(e!=y)return void console.error("spine item is not loaded");var i=new n(v,I);return i.getElement(t)},this.getFirstVisibleMediaOverlayElement=function(){var e=new n(v,I);
return e.getFirstVisibleMediaOverlayElement({top:0,bottom:I.height()})},this.offset=function(){return I?I.offset():void 0}};return a.SPINE_ITEM_OPEN_START="SpineItemOpenStart",a}),define("readium_shared_js/models/page_open_request",[],function(){var e=function(e,t){this.spineItem=e,this.spineItemPageIndex=void 0,this.elementId=void 0,this.elementCfi=void 0,this.firstPage=!1,this.lastPage=!1,this.initiator=t,this.reset=function(){this.spineItemPageIndex=void 0,this.elementId=void 0,this.elementCfi=void 0,this.firstPage=!1,this.lastPage=!1},this.setFirstPage=function(){this.reset(),this.firstPage=!0},this.setLastPage=function(){this.reset(),this.lastPage=!0},this.setPageIndex=function(e){this.reset(),this.spineItemPageIndex=e},this.setElementId=function(e){this.reset(),this.elementId=e},this.setElementCfi=function(e){this.reset(),this.elementCfi=e}};return e}),define("readium_shared_js/views/fixed_view",["jquery","underscore","eventEmitter","../models/bookmark_data","../models/current_pages_info","../models/fixed_page_spread","./one_page_view","../models/page_open_request","../helpers","../globals"],function(e,t,i,n,r,o,a,s,l,d){var u=function(u,c){function f(e){var t=new a(u,[e],!1,c);return t.on(a.SPINE_ITEM_OPEN_START,function(e,t){O.emit(d.Events.CONTENT_DOCUMENT_LOAD_START,e,t)}),t}function h(){var e=V.validItems();return e[0]}function m(t,i){if(B)return void(G={initiator:t,paginationRequest:i});B=!0;var n={isElementAdded:!1},r=p([{pageView:A,spineItem:V.leftItem,context:n},{pageView:M,spineItem:V.rightItem,context:n},{pageView:L,spineItem:V.centerItem,context:n}]);e.when.apply(e,r).done(function(){if(B=!1,G){var e=G.initiator,r=G.paginationRequest;G=void 0,m(e,r)}else n.isElementAdded&&O.applyStyles(),i?g(t,i.spineItem,i.elementId):g(t)})}function p(e){for(var t=[],i=0;i<e.length;i++){var n=P(e[i].pageView,e[i].spineItem,e[i].context);t.push(n)}return t}function g(e,t,i){_(),y(),O.emit(d.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:O.getPaginationInfo(),initiator:e,spineItem:t,elementId:i})}function v(e,t){var i=new o(x,t);return i.openItem(e),V.leftItem!=i.leftItem||V.rightItem!=i.rightItem||V.centerItem!=i.centerItem}function I(){if(!U||!F)return!1;var e=C.width(),t=C.height();return e&&t}function y(e){if(W(0,!1),I()){var t=C.width(),i=C.height(),n=A.isDisplaying()?l.Margins.fromElement(A.element()):l.Margins.empty(),r=M.isDisplaying()?l.Margins.fromElement(M.element()):l.Margins.empty(),o=L.isDisplaying()?l.Margins.fromElement(L.element()):l.Margins.empty(),a=E(n,r,o),s={width:t-F.width(),height:i-F.height()},u={width:s.width-a.width(),height:s.height-a.height()};if(!(s.width<=0||s.height<=0)){var c=u.width/U.width,f=u.height/U.height;C.css("overflow","auto");var h;"fit-width"==D.style?h=c:"fit-height"==D.style?h=f:"user"==D.style?h=D.scale:(h=Math.min(c,f),C.css("overflow","hidden")),b=h;var m={width:U.width*h,height:U.height*h},p={width:m.width+a.width(),height:m.height+a.height()},g={width:p.width+F.width(),height:p.height+F.height()},v=Math.floor((t-g.width)/2),y=Math.floor((i-g.height)/2);0>v&&(v=0),0>y&&(y=0),w.css("left",v+"px"),w.css("top",y+"px"),w.css("width",p.width+"px"),w.css("height",p.height+"px");var _=F.padding.left,S=F.padding.top,P=e?"transformContentImmediate":"transformContent";A.isDisplaying()&&A[P](h,_,S),M.isDisplaying()&&(_+=U.separatorPosition*h,A.isDisplaying()&&(_+=n.left),M[P](h,_,S)),L.isDisplaying()&&L[P](h,_,S),O.emit(d.Events.FXL_VIEW_RESIZED)}}}function E(e,t,i){var n={left:Math.max(e.margin.left,t.margin.left,i.margin.left),right:Math.max(e.margin.right,t.margin.right,i.margin.right),top:Math.max(e.margin.top,t.margin.top,i.margin.top),bottom:Math.max(e.margin.bottom,t.margin.bottom,i.margin.bottom)},r={left:Math.max(e.border.left,t.border.left,i.border.left),right:Math.max(e.border.right,t.border.right,i.border.right),top:Math.max(e.border.top,t.border.top,i.border.top),bottom:Math.max(e.border.bottom,t.border.bottom,i.border.bottom)},o={left:Math.max(e.padding.left,t.padding.left,i.padding.left),right:Math.max(e.padding.right,t.padding.right,i.padding.right),top:Math.max(e.padding.top,t.padding.top,i.padding.top),bottom:Math.max(e.padding.bottom,t.padding.bottom,i.padding.bottom)};return new l.Margins(n,r,o)}function _(){U={},L.isDisplaying()?(U.width=L.meta_width(),U.height=L.meta_height(),U.separatorPosition=0):A.isDisplaying()&&M.isDisplaying()?A.meta_height()==M.meta_height()?(U.width=A.meta_width()+M.meta_width(),U.height=A.meta_height(),U.separatorPosition=A.meta_width()):(U.width=A.meta_width()+M.meta_width()*(A.meta_height()/M.meta_height()),U.height=A.meta_height(),U.separatorPosition=A.meta_width()):A.isDisplaying()?(U.width=2*A.meta_width(),U.height=A.meta_height(),U.separatorPosition=A.meta_width()):M.isDisplaying()?(U.width=2*M.meta_width(),U.height=M.meta_height(),U.separatorPosition=M.meta_width()):U=void 0}function S(){F=l.Margins.fromElement(w)}function P(t,i,n){var r=e.Deferred();return i?(t.isDisplaying()||(w.append(t.render().element()),n.isElementAdded=!0),t.loadSpineItem(i,function(e,i,n,o){e&&o&&(t.meta_height()&&t.meta_width()||console.error("Invalid document "+n.href+": viewport is not specified!"),O.emit(d.Events.CONTENT_DOCUMENT_LOADED,i,n)),r.resolve()},n)):(t.isDisplaying()&&t.remove(),r.resolve()),r.promise()}function T(){var e=[];e=x.isLeftToRight()?[A,L,M]:[M,L,A];for(var t=[],i=0,n=e.length;n>i;i++)e[i].isDisplaying()&&t.push(e[i]);return t}t.extend(this,new i);var w,b,O=this,C=u.$viewport,x=u.spine,R=u.userStyles,D=(u.bookStyles,u.zoom||{style:"default"}),N=(u.iframeLoader,void 0),A=f("fixed-page-frame-left"),M=f("fixed-page-frame-right"),L=f("fixed-page-frame-center"),k=[];k.push(A),k.push(M),k.push(L);var F,U,V=new o(x,!1),B=!1,G=!1;this.isReflowable=function(){return!1},this.setZoom=function(e){D=e,y(!1)},this.render=function(){var t=l.loadTemplate("fixed_book_frame",{});return w=e(t),l.CSSTransition(w,"all 0 ease 0"),w.css("overflow","hidden"),C.append(w),O.applyStyles(),this},this.remove=function(){w.remove()},this.setViewSettings=function(e){N=e,V.setSyntheticSpread(1==l.deduceSyntheticSpread(C,h(),N));for(var t=T(),i=0,n=t.length;n>i;i++)t[i].setViewSettings(e)};var W=function(e,t){A&&A.updatePageSwitchDir(e,t),M&&M.updatePageSwitchDir(e,t),L&&L.updatePageSwitchDir(e,t)};this.applyStyles=function(){l.setStyles(R.getStyles(),w.parent()),S(),_(),y()},this.applyBookStyles=function(){for(var e=T(),t=0,i=e.length;i>t;t++)e[t].applyBookStyles()},this.onViewportResize=function(){var e=h();if(e){var t=1==l.deduceSyntheticSpread(C,e,N);if(v(e,t)){V.setSyntheticSpread(t);var i=new s(e,O);O.openPage(i)}else y(!0)}},this.getViewScale=function(){return b},this.openPage=function(e,t){if(e.spineItem){var i=V.leftItem,n=V.rightItem,r=V.centerItem,o=1==l.deduceSyntheticSpread(C,e.spineItem,N);V.setSyntheticSpread(o),V.openItem(e.spineItem);var a=i!==V.leftItem||n!==V.rightItem||r!==V.centerItem;(null===t||"undefined"==typeof t)&&(t=0),W(0===t?0:V.spine.isRightToLeft()?1===t?2:1:t,a),m(e.initiator,e)}},this.openPagePrev=function(e){V.openPrev(),W(V.spine.isRightToLeft()?2:1,!0),m(e,void 0)},this.openPageNext=function(e){V.openNext(),W(V.spine.isRightToLeft()?1:2,!0),m(e,void 0)},this.getPaginationInfo=function(){for(var e=new r(x,!0),t=[V.leftItem,V.rightItem,V.centerItem],i=0;i<t.length;i++){var n=t[i];n&&e.addOpenPage(0,1,n.idref,n.index)}return e},this.bookmarkCurrentPage=function(){var e=T();if(e.length>0){var t=e[0].currentSpineItem().idref,i=e[0].getFirstVisibleElementCfi();return void 0==i&&(i=""),new n(t,i)}return new n("","")},this.getLoadedSpineItems=function(){return V.validItems()},this.getElement=function(e,t){for(var i=T(),n=0,r=i.length;r>n;n++){var o=i[n];if(o.currentSpineItem()==e)return o.getElement(e,t)}return void console.error("spine item is not loaded")},this.getElementById=function(e,t){for(var i=T(),n=0,r=i.length;r>n;n++){var o=i[n];if(o.currentSpineItem()==e)return o.getElementById(e,t)}return void console.error("spine item is not loaded")},this.getElementByCfi=function(e,t,i,n,r){for(var o=T(),a=0,s=o.length;s>a;a++){var l=o[a];if(l.currentSpineItem()==e)return l.getElementByCfi(e,t,i,n,r)}return void console.error("spine item is not loaded")},this.getFirstVisibleMediaOverlayElement=function(){for(var e=T(),t=0,i=e.length;i>t;t++){var n=e[t].getFirstVisibleMediaOverlayElement();if(n)return n}return void 0},this.insureElementVisibility=function(){}};return u}),define("readium_shared_js/views/iframe_loader",["jquery","underscore"],function(e,t){var i=function(){var i=this,n={};this.addIFrameEventListener=function(e,t,i){void 0==n[e]&&(n[e]=[]),n[e].push({callback:t,context:i})},this.updateIframeEvents=function(i){t.each(n,function(t,n){for(var r=0,o=t.length;o>r;r++)e(i.contentWindow).off(n),e(i.contentWindow).on(n,t[r].callback,t[r].context)})},this.loadIframe=function(t,n,r,o,a){t.baseURI||("undefined"!=typeof location&&(t.baseURI=location.href+""),console.log("!iframe.baseURI => "+t.baseURI)),t.setAttribute("data-baseUri",t.baseURI),t.setAttribute("data-src",n);var s=new URI(n).absoluteTo(t.baseURI).search("").hash("").toString();i._loadIframeWithUri(t,a,s,function(){var i=t.contentDocument||t.contentWindow.document;e("svg",i).load(function(){console.log("loaded")}),r.call(o,!0,a)})},this._loadIframeWithUri=function(e,n,r,o){e.onload=function(){i.updateIframeEvents(e);var n=e.contentWindow.MathJax;if(n){var r=t.once(o);try{n.Hub.Queue(r)}catch(a){console.error("MathJax fail!"),o()}}else o()},e.setAttribute("src",r)}};return i}),define("readium_shared_js/views/internal_links_support",["jquery","../helpers","readium_cfi_js"],function(e,t){var i=function(i){function n(e){var t=e.indexOf("("),i=e.indexOf("!"),n=e.indexOf(")");return-1==i?void 0:(-1==n&&(n=e.length),{spineItemCfi:e.substring(t+1,i),elementCfi:e.substring(i+1,n)})}function r(e,t){var n=i["package"]().resolveRelativeUrl(t.href),r=e.absoluteTo(n);return r}function o(e,o){var s=r(e,o);if(!s)return void console.error("Unable to resolve "+e.href());var l=e.fragment(),u=s.toString();u=t.RemoveFromString(u,"#"+l),a(u,function(e){if(e){var t=new window.DOMParser,r=t.parseFromString(e,"text/xml"),o=n(l);if(!o)return void console.warn("Unable to split cfi:"+l);var a=EPUBcfi.Interpreter.getContentDocHref("epubcfi("+o.spineItemCfi+")",r);if(a){var s=i.spine().getItemByHref(a);s?i.openSpineItemElementCfi(s.idref,o.elementCfi,d):console.warn("Unable to find spineItem with href="+a)}else console.warn("Unable to find document ref from "+l+" cfi")}})}function a(t,i){e.ajax({isLocal:0===t.indexOf("http")?!1:!0,url:t,dataType:"text",async:!0,success:function(e){i(e)},error:function(e,n,r){console.error("Error when AJAX fetching "+t),console.error(n),console.error(r),i()}})}function s(e){var i=e.filename();return i&&t.EndsWith(i,".opf")}function l(e,t){var n,r=e.filename();if(r){var o=new URI(e,t.href),a=decodeURIComponent(o.pathname()),s=i.spine().getItemByHref(a);if(!s)return void console.error("spine item with href="+a+" not found");n=s.idref}else n=t.idref;var l=e.fragment();i.openSpineItemElementId(n,l,d)}var d=this;this.processLinkElements=function(t,i){var n=t[0].contentDocument;e("a",n).click(function(e){var t;t=e.currentTarget.attributes["xlink:href"]?e.currentTarget.attributes["xlink:href"].value:e.currentTarget.attributes.href.value;var n=!1,r=new URI(t),a=r.is("relative");a?s(r)?(o(r,i),n=!0):(l(r,i),n=!0):(window.open(t,"_blank"),n=!0),n&&(e.preventDefault(),e.stopPropagation())})}};return i}),define("readium_shared_js/models/smil_iterator",["jquery","../helpers"],function(e,t){var i=function(i){function n(e,t,i){for(var r=e,o=t.children.length;r>=0&&o>r;r+=i?-1:1){var a=t.children[r];if("par"==a.nodeType)return a;if(a=n(i?a.children.length-1:0,a,i))return a}return t.parent?n(t.index+(i?-1:1),t.parent,i):void 0}this.smil=i,this.currentPar=void 0,this.reset=function(){this.currentPar=n(0,this.smil,!1)},this.findTextId=function(i){if(!this.currentPar)return void console.debug("Par iterator is out of range");if(!i)return!1;for(;this.currentPar;){if(this.currentPar.element){if(i===this.currentPar.text.srcFragmentId)return!0;for(var n=this.currentPar.element.parentNode;n;){if(n.id&&n.id==i)return!0;n=n.parentNode}var r=e("#"+t.escapeJQuerySelector(i),this.currentPar.element);if(r&&r.length&&r[0])return!0}this.next()}return!1},this.next=function(){return this.currentPar?void(this.currentPar=n(this.currentPar.index+1,this.currentPar.parent,!1)):void console.debug("Par iterator is out of range")},this.previous=function(){return this.currentPar?void(this.currentPar=n(this.currentPar.index-1,this.currentPar.parent,!0)):void console.debug("Par iterator is out of range")},this.isLast=function(){return this.currentPar?n(this.currentPar.index+1,this.currentPar.parent,!1)?!1:!0:void console.debug("Par iterator is out of range")},this.goToPar=function(e){for(;this.currentPar&&this.currentPar!=e;)this.next()},this.reset()};return i}),define("readium_shared_js/views/media_overlay_data_injector",["jquery","underscore","../helpers","../models/smil_iterator","rangy","readium_cfi_js"],function(e,t,i,n,r){var o=function(o,a){this.attachMediaOverlayData=function(s,l,d){var u=s[0].contentDocument.documentElement;if(l.media_overlay_id||0!==o.smil_models.length){var c=e("body",u);if(0==c.length)console.error("! BODY ???");else{var f=c.data("mediaOverlayClick");if(f)console.error("[WARN] already mediaOverlayClick");else{c.data("mediaOverlayClick",{ping:"pong"});var h=function(t){var i=e(this)[0];if(i=t.target,!i)return a.touchInit(),!0;var n=void 0,o=i,s=!1;for("a"===o.nodeName.toLowerCase()&&(s=!0);!(n=e(o).data("mediaOverlayData"))&&("a"===o.nodeName.toLowerCase()&&(s=!0),o=o.parentNode););if(n&&(n.par||n.pars)){if(!d.mediaOverlaysEnableClick)return console.log("MO CLICK DISABLED"),a.touchInit(),!0;if(s)return console.log("MO CLICKED LINK"),a.touchInit(),!0;var l=n.par?n.par:n.pars[0];if(n.pars&&"undefined"!=typeof r){var u=!1;a.isPlayingCfi()&&(u=!0,a.pause());try{var c=r.positionFromPoint(t.pageX,t.pageY,i.ownerDocument);l=void 0;for(var f=0;f<n.pars.length;f++){var h=n.pars[f],m="epubcfi("+h.cfi.partialStartCfi+")",p=EPUBcfi.getTextTerminusInfoWithPartialCFI(m,i.ownerDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),g="epubcfi("+h.cfi.partialEndCfi+")",v=EPUBcfi.getTextTerminusInfoWithPartialCFI(g,i.ownerDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),I=r.createRange(i.ownerDocument);if(I.setStartAndEnd(p.textNode[0],p.textOffset,v.textNode[0],v.textOffset),I.isPointInRange(c.node,c.offset)){l=h;break}}}catch(y){console.error(y)}if(!l)return u&&a.toggleMediaOverlay(),!0}return o&&o!=i&&"body"===o.nodeName.toLowerCase()&&l&&!l.getSmil().id?(a.touchInit(),!0):(a.playUserPar(l),!0)}var E=e(i).attr("ibooks:readaloud");if(E||(E=e(i).attr("epub:readaloud")),E){console.debug("MO readaloud attr: "+E);var _=a.isPlaying();if("start"===E&&!_||"stop"===E&&_||"startstop"===E)return a.toggleMediaOverlay(),!0}return a.touchInit(),!0},m=t.debounce(h,200);"ontouchstart"in document.documentElement&&c[0].addEventListener("touchstart",m,!1),c[0].addEventListener("mousedown",m,!1)}}var p=o.getSmilBySpineItem(l);if(!p)return void console.error("NO SMIL?? "+l.idref+" /// "+l.media_overlay_id);var g=function(e){if(e){if(e.nodeType&&"seq"===e.nodeType&&e.textref){var t=e.textref.split("#"),n=t[0],r=2===t.length?t[1]:"";if(n&&r){var o=i.ResolveContentRef(n,p.href),a=o===l.href;a&&(e.element=s[0].contentDocument.getElementById(r),e.element||console.error("seq.textref !element? "+e.textref))}}if(e.children&&e.children.length)for(var d=0;d<e.children.length;d++){var u=e.children[d];g(u)}}};g(p);for(var v=new n(p),I="/99!",y="epubcfi";v.currentPar;){v.currentPar.element=void 0,v.currentPar.cfi=void 0;var E=i.ResolveContentRef(v.currentPar.text.srcFile,v.smil.href),_=E===l.href;if(_){var S=!v.currentPar.text.srcFragmentId||0==v.currentPar.text.srcFragmentId.length,P=0==v.currentPar.text.srcFragmentId.indexOf(y)?void 0:v.currentPar.text.srcFragmentId,T=void 0,w=!1;if(S||P)T=S?c:e(s[0].contentDocument.getElementById(P));else if(0===v.currentPar.text.srcFragmentId.indexOf(y)){var b=v.currentPar.text.srcFragmentId.substr(y.length+1,v.currentPar.text.srcFragmentId.length-y.length-2);0===b.indexOf(I)&&(b=b.substr(I.length,b.length-I.length));var O=b.split(",");if(O&&3===O.length)try{var C=O[0]+O[1],x="epubcfi("+C+")",R=EPUBcfi.getTextTerminusInfoWithPartialCFI(x,s[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),D=O[0]+O[2],N="epubcfi("+D+")",A=(EPUBcfi.getTextTerminusInfoWithPartialCFI(N,s[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),R.textNode[0].parentNode);v.currentPar.cfi={smilTextSrcCfi:v.currentPar.text.srcFragmentId,partialRangeCfi:b,partialStartCfi:C,partialEndCfi:D,cfiTextParent:A},w=!0,T=e(A);var M=T.data("mediaOverlayData");if(M){M.par&&(console.error("[WARN] non-CFI MO DATA already exists!"),M.par=void 0);var L=!1;if(M.pars)for(var k=0;k<M.pars.length;k++){var F=M.pars[k];F===v.currentPar&&(L=!0,console.error("[WARN] mediaOverlayData CFI PAR already registered!"))}else M.pars=[];L||M.pars.push(v.currentPar)}else M={pars:[v.currentPar]},T.data("mediaOverlayData",M)}catch(U){console.error(U)}else try{var V="epubcfi("+b+")";T=EPUBcfi.getTargetElementWithPartialCFI(V,s[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"])}catch(U){console.error(U)}}else console.error("SMIL text@src CFI fragment identifier scheme not supported: "+v.currentPar.text.srcFragmentId);if(T&&T.length>0){if(!w){v.currentPar.element&&v.currentPar.element!==T[0]&&console.error("DIFFERENT ELEMENTS??! "+v.currentPar.text.srcFragmentId+" /// "+v.currentPar.element.id);var B=T[0].nodeName?T[0].nodeName.toLowerCase():void 0;("audio"===B||"video"===B)&&T.attr("preload","auto"),v.currentPar.element=T[0];var M=T.data("mediaOverlayData");M&&(console.error("[WARN] MO DATA already exists."),M.par&&M.par!==v.currentPar&&console.error("DIFFERENT PARS??!")),T.data("mediaOverlayData",{par:v.currentPar})}}else console.error("!! CANNOT FIND ELEMENT: "+v.currentPar.text.srcFragmentId+" == "+v.currentPar.text.srcFile+" /// "+l.href)}v.next()}}}};return o}),define("readium_shared_js/views/audio_player",["jquery"],function(e){var t=navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?!0:!1,i=navigator.userAgent.toLowerCase().indexOf("android")>-1,n=!1,r=new Audio;n&&(r.addEventListener("load",function(){console.debug("0) load")}),r.addEventListener("loadstart",function(){console.debug("1) loadstart")}),r.addEventListener("durationchange",function(){console.debug("2) durationchange")}),r.addEventListener("loadedmetadata",function(){console.debug("3) loadedmetadata")}),r.addEventListener("loadeddata",function(){console.debug("4) loadeddata")}),r.addEventListener("progress",function(){console.debug("5) progress")}),r.addEventListener("canplay",function(){console.debug("6) canplay")}),r.addEventListener("canplaythrough",function(){console.debug("7) canplaythrough")}),r.addEventListener("play",function(){console.debug("8) play")}),r.addEventListener("pause",function(){console.debug("9) pause")}),r.addEventListener("ended",function(){console.debug("10) ended")}),r.addEventListener("seeked",function(){console.debug("X) seeked")}),r.addEventListener("timeupdate",function(){console.debug("Y) timeupdate")}),r.addEventListener("seeking",function(){console.debug("Z) seeking")}));var o=function(o,a,s,l,d){function u(){o({isPlaying:!0}),l()}function c(){d(),o({isPlaying:!1})}function f(){return r.moSeeking?void(n&&console.debug("onEnded() skipped (still seeking...)")):(m(),s(),void o({isPlaying:!1}))}function h(){w||(w=setInterval(function(){if(r.moSeeking)return T++,void(T>1e3&&(T=0,m()));var e=void 0;try{e=r.currentTime}catch(t){console.error(t.message)}e&&a(e,1)},20))}function m(){w&&clearInterval(w),w=void 0}function p(e){n&&console.debug("onReadyToSeek #"+e.data.playId),v(e.data.seekBegin,e.data.playId,!0)}function g(t){e(r).off(D,g),i?(n&&console.debug("onReadyToSeek ANDROID ... waiting a bit ... #"+t.data.playId),x(),setTimeout(function(){p(t)},1e3)):p(t)}function v(t,i,o){if(n&&console.debug("playSeekCurrentTime() #"+i),0==t&&(t=.01),Math.abs(t-r.currentTime)<.3)return n&&console.debug("playSeekCurrentTime() CONTINUE"),r.moSeeking=void 0,void y.play();var a=o?A:M;n&&console.debug("playSeekCurrentTime() NEED SEEK, EV: "+a),y.pause(),e(r).on(a,{newCurrentTime:t,playId:i,isNewSrc:o},I);try{r.currentTime=t}catch(s){console.error(s.message),setTimeout(function(){try{r.currentTime=t}catch(e){console.error(e.message)}},5)}}function I(t){var o=t.data.isNewSrc?A:M,a=void 0==t.data.seekRetries;(a||t.data.seekRetries==N)&&e(r).off(o,I),n&&console.debug("onSeeked() #"+t.data.playId+" FIRST? "+a+" EV: "+o);var s=r.currentTime,l=Math.abs(t.data.newCurrentTime-s);if((a||t.data.seekRetries>=0)&&l>=1)n&&console.debug("onSeeked() time diff: "+t.data.newCurrentTime+" vs. "+s+" ("+l+")"),a&&(t.data.seekRetries=N,t.data.isNewSrc=!1),t.data.seekRetries--,n&&console.debug("onSeeked() FAIL => retry again (timeout)"),setTimeout(function(){I(t)},i?1e3:200),setTimeout(function(){r.pause();try{r.currentTime=t.data.newCurrentTime}catch(e){console.error(e.message),setTimeout(function(){try{r.currentTime=t.data.newCurrentTime}catch(e){console.error(e.message)}},4)}},5);else{if(n&&(console.debug("onSeeked() STATE:"),console.debug(a),console.debug(t.data.seekRetries),console.debug(l)),l>=1){n&&console.debug("onSeeked() ABORT, TRY AGAIN FROM SCRATCH!");var d=_,u=E,c=t.data.newCurrentTime;return y.reset(),void setTimeout(function(){y.playFile(d,u,c)},10)}n&&console.debug("onSeeked() OKAY => play!"),t.data.seekRetries=void 0,y.play(),r.moSeeking=void 0}}var y=this,E=void 0,_=void 0;this.currentSmilSrc=function(){return _};var S=1;this.setRate=function(e){S=e,.5>S&&(S=.5),S>4&&(S=4),r.playbackRate=S},y.setRate(S),this.getRate=function(){return S};var P=100;this.setVolume=function(e){P=e,0>P&&(P=0),P>1&&(P=1),r.volume=P},y.setVolume(P),this.getVolume=function(){return P},this.play=function(){return n&&console.error("this.play()"),E?(h(),y.setVolume(P),y.setRate(S),r.play(),!0):!1},this.pause=function(){n&&console.error("this.pause()"),m(),r.pause()},r.addEventListener("play",u,!1),r.addEventListener("pause",c,!1),r.addEventListener("ended",f,!1);var T=0,w=void 0;this.isPlaying=function(){return void 0!==w},this.reset=function(){n&&console.error("this.reset()"),this.pause(),r.moSeeking=void 0,_=void 0,E=void 0,setTimeout(function(){r.setAttribute("src","")},1)},r.addEventListener("loadstart",function(){b=!0});var b=!1;this.touchInit=function(){return t?b?!1:(b=!0,r.setAttribute("src","touch/init/html5/audio.mp3"),r.load(),!0):!1};var O=0,C=0;this.playFile=function(t,o,a){O++,O>99999&&(O=0);var s=O;if(r.moSeeking)return C++,C>N?void(C=0):(n&&console.debug("this.playFile("+o+") @"+a+" (POSTPONE, SEEKING...)"),void setTimeout(function(){y.playFile(t,o,a)},20));r.moSeeking={},n&&console.debug("this.playFile("+o+") @"+a+" #"+s);var l=!E||E!==o;return l?(n&&(console.debug("this.playFile() NEW SRC"),console.debug("_currentEpubSrc: "+E),console.debug("epubSrc: "+o)),this.reset(),r.moSeeking={},_=t,E=o,i||r.addEventListener("play",R,!1),e(r).on(D,{seekBegin:a,playId:s},g),void setTimeout(function(){r.setAttribute("src",E),r.load(),i||x()},1)):(n&&console.debug("this.playFile() SAME SRC"),this.pause(),_=t,E=o,void v(a,s,!1))};var x=function(){n&&console.debug("playToForcePreload");var e=P;P=0,y.play(),P=e},R=function(){r.removeEventListener("play",R,!1),n&&console.debug("onPlayToForcePreload"),r.pause()},D=i?"canplaythrough":"canplay",N=10,A=t?"canplaythrough":"seeked",M=t?"timeupdate":"seeked"};return o}),define("readium_shared_js/views/media_overlay_element_highlighter",["jquery","rangy","readium_cfi_js"],function(e,t){var i=function(i){function n(t,i,n){if(p)try{if(p[0].ownerDocument===t[0].ownerDocument)return}catch(o){}$head=e("head",t[0].ownerDocument.documentElement),p=e("<style type='text/css'> </style>"),p.append("."+r+" {");var a="background-color: yellow !important; color: black !important; border-radius: 0.4em;",s=n;if(s){var l=!1;for(var d in s.declarations)s.declarations.hasOwnProperty(d)&&(l=!0,p.append(d+": "+s.declarations[d]+"; "));l||i||p.append(a)}else i||p.append(a);p.append("}"),p.appendTo($head)}this.includeParWhenAdjustingToSeqSyncGranularity=!0;var r="mo-active-default",o="mo-sub-sync",a=void 0;this.isElementHighlighted=function(e){return a&&e===a};var s=void 0;this.isCfiHighlighted=function(e){return s&&e===s};var l="",d="",u=i,c=!0&&"undefined"!=typeof t,f=void 0,h=void 0,m="MO_SPEAK",p=void 0;this.reDo=function(){p&&p.remove(),p=void 0;var e=a,t=s,i=l,n=d;a?(this.reset(),this.highlightElement(e,i,n)):s&&(this.reset(),this.highlightCfi(t,i,n))},this.highlightElement=function(t,i,c){if(t&&t!==a){this.reset(),a=t,s=void 0,l=i,d=c;var f=this.adjustParToSeqSyncGranularity(a),h=f.element;d&&""!==d&&e(h.ownerDocument.documentElement).addClass(d);var m=e(h),p=l&&""!==l,g=u.userStyles().findStyle("."+r);n(m,p,g),g||!p?(p&&m.addClass(l),m.addClass(r)):m.addClass(l),(this.includeParWhenAdjustingToSeqSyncGranularity||a!==f)&&e(a.element).addClass(o)}},this.highlightCfi=function(i,o,p){if(i&&i!==s){this.reset(),a=void 0,s=i,l=o,d=p;var g=e(s.cfi.cfiTextParent),v=l&&""!==l,I=u.userStyles().findStyle("."+r);n(g,v,I);var y=I||!v?(v?l+" ":"")+r:l;if(c){var E=s.cfi.cfiTextParent.ownerDocument;h=t.createRange(E);var _="epubcfi("+s.cfi.partialStartCfi+")",S=EPUBcfi.getTextTerminusInfoWithPartialCFI(_,E,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),P="epubcfi("+s.cfi.partialEndCfi+")",T=EPUBcfi.getTextTerminusInfoWithPartialCFI(P,E,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);h.setStartAndEnd(S.textNode[0],S.textOffset,T.textNode[0],T.textOffset);h.MO_createCssClassApplier=!0,f&&f.cssClass===y||(f=t.createCssClassApplier(y,{elementTagName:"span",elementProperties:{className:"mo-cfi-highlight"},ignoreWhiteSpace:!0,applyToEditableOnly:!1,normalize:!0},["span"])),f.applyToRange(h)}else if(u.plugins.annotations)try{var w=i.getSmil().spineItemId;u.plugins.annotations.addHighlight(w,i.cfi.partialRangeCfi,m,"highlight",void 0)}catch(b){console.error(b)}}},this.reset=function(){if(s){var t=s.cfi.cfiTextParent.ownerDocument;if(c){if(f&&h.MO_createCssClassApplier)f.undoToRange(h);else for(var i=void 0;null!==(i=t.getElementById(m));){var n=i.textContent,p=t.createTextNode(n);i.parentNode.replaceChild(p,i),p.parentNode.normalize()}h=void 0}else if(u.plugins.annotations)try{u.plugins.annotations.removeHighlight(m);for(var i=void 0;null!==(i=t.getElementById("start-"+m));)console.log("toRemove START"),console.log(i),i.parentNode.removeChild(i);for(;null!==(i=t.getElementById("end-"+m));)console.log("toRemove END"),console.log(i),i.parentNode.removeChild(i)}catch(g){console.error(g)}s=void 0}if(a){var v=this.adjustParToSeqSyncGranularity(a),I=v.element;(this.includeParWhenAdjustingToSeqSyncGranularity||a!==v)&&e(a.element).removeClass(o),d&&""!==d&&e(I.ownerDocument.documentElement).removeClass(d),l&&""!==l&&e(I).removeClass(l),e(I).removeClass(r),a=void 0}l="",d=""},this.adjustParToSeqSyncGranularity=function(e){if(!e)return void 0;var t=u.viewerSettings().mediaOverlaysSynchronizationGranularity;if(t&&t.length>0){var i=e.element||(e.cfi?e.cfi.cfiTextParent:void 0);if(!i)return console.error("adjustParToSeqSyncGranularity !element ???"),e;var n=e.getFirstSeqAncestorWithEpubType(t,this.includeParWhenAdjustingToSeqSyncGranularity);if(n&&n.element)return n}return e}};return i}),define("readium_shared_js/views/scroll_view",["jquery","underscore","eventEmitter","../models/bookmark_data","../models/current_pages_info","../helpers","./one_page_view","../models/page_open_request","../globals","../models/viewer_settings"],function(e,t,i,n,r,o,a,s,l,d){var u=function(u,c,f){function h(e,t){if(lt)return void e();var i=R();if(!i)return void e();var n=q(0),r=j(i);if(n.top-r.bottom>it){var o=F();w(i),I(o-(r.bottom-r.top),void 0),t("updateLoadedViewsTop 1"),h(e,t)}else n.top-r.top<it?_(i,function(i){i?(t("updateLoadedViewsTop 2"),h(e,t)):e()}):e()}function m(e,t){if(lt)return void e();var i=D();if(!i)return void e();var n=q(0),r=j(i);r.top-n.bottom>it?(w(i),t("updateLoadedViewsBottom 1"),m(e,t)):r.bottom-n.bottom<it?P(i,function(i){t("updateLoadedViewsBottom 2"),i?m(e,t):e()}):e()}function p(e){if(c){var t=void 0;if(K&&e){var i=e.offset();i&&(t=i.top)}var n=function(i){if(K){if(!t)return;var n=void 0,r=e.offset();if(r&&(n=r.top),!n)return;var o=n-t;Math.abs(o)>1&&console.debug("@@@@@@@@@@@@@@@ SCROLL ADJUST ("+i+") "+o+" -- "+e.currentSpineItem().href)}};dt=!0,m(function(){h(function(){setTimeout(function(){dt=!1},nt+100)},n)},n)}}function g(){var e=f.viewerSettings();e.mediaOverlaysPreservePlaybackWhenScroll||!ft&&f.isMediaOverlayAvailable()&&(ft=f.isPlayingMediaOverlay(),ft&&f.pauseMediaOverlay())}function v(){if(!dt&&!ut&&!ct){p(),k(rt);var e=f.viewerSettings();e.mediaOverlaysPreservePlaybackWhenScroll||ft&&setTimeout(function(){f.playMediaOverlay(),ft=!1},100)}}function I(e,t){Q[0].scrollTop=e,t&&k(t.initiator,t.spineItem,t.elementId)}function y(e){var t=F(),i=j(e);S(e);var n=j(e),r=n.bottom-n.top,o=i.bottom-i.top,a=r-o;Math.abs(a)>0&&(K&&console.debug("IMMEDIATE SCROLL ADJUST: "+e.currentSpineItem().href+" == "+a),I(t+a))}function E(e,t,i,n,r,a,s,l){if(!o.isIframeAlive(i))return K&&console.log("reachStableContentHeight ! win && doc (iFrame disposed?)"),void(l&&l(!1));var d=10,u=300,c=i.contentWindow,f=i.contentDocument,h=parseInt(Math.round(parseFloat(c.getComputedStyle(f.documentElement).height))),m=h;0===e?y(t):S(t);var p=function(r){return K&&r!==d&&console.log("tryAgainFunc - "+r+": "+n+"  <"+m+" -- "+h+">"),r--,0>r?(K&&console.error("tryAgainFunc abort: "+n),void(l&&l(!0))):void setTimeout(function(){try{if(!o.isIframeAlive(i))return K&&console.log("tryAgainFunc ! win && doc (iFrame disposed?)"),void(l&&l(!1));var a=i.contentWindow,d=i.contentDocument,u=parseInt(Math.round(parseFloat(window.getComputedStyle(i).height))),c=parseInt(Math.round(parseFloat(a.getComputedStyle(d.documentElement).height)));if(h!==c)return h=c,void p(r);var f=u-c;if(Math.abs(f)>4){if(K&&(console.log("$$$ IFRAME HEIGHT ADJUST: "+n+"  ["+f+"]<"+m+" -- "+h+">"),console.log(s)),0===e?y(t):S(t),!o.isIframeAlive(i))return K&&console.log("tryAgainFunc ! win && doc (iFrame disposed?)"),void(l&&l(!1));var a=i.contentWindow,d=i.contentDocument,g=parseInt(Math.round(parseFloat(a.getComputedStyle(d.documentElement).height))),v=parseInt(Math.round(parseFloat(window.getComputedStyle(i).height))),I=v-g;if(Math.abs(I)>4)return K&&(console.error("## IFRAME HEIGHT ADJUST: "+n+"  ["+I+"]<"+m+" -- "+h+">"),console.log(s)),void p(r);K&&console.log(">> IFRAME HEIGHT ADJUSTED OKAY: "+n+"  ["+f+"]<"+m+" -- "+h+">")}}catch(E){return console.error(E),void(l&&l(!1))}l&&l(!0)},u)};p(d)}function _(e,t){var i=at.prevItem(e.currentSpineItem(),!0);if(!i)return void t(!1);var n=O(!0),r=D();n.element().insertAfter(r.element()),n.loadSpineItem(i,function(r){if(r){S(n);var o=j(n);w(n);var a=F(),s=O(),l=o.bottom-o.top;s.setHeight(l),s.element().insertBefore(e.element()),a+=l,I(a,void 0),s.loadSpineItem(i,function(e,n,r,o,a){if(e){var l=function(i){N(s,e,n,r,o,a),t(i)};E(0,s,n[0],r.href,r.isFixedLayout(),r.isFixedLayout()?s.meta_width():0,"addToTopOf",l)}else console.error("Unable to open 2 "+i.href),w(s),t(!1)})}else console.error("Unable to open 1 "+i.href),w(n),t(!1)})}function S(e){e.currentSpineItem().isFixedLayout()?e.scaleToWidth(Q.width()):e.resizeIFrameToContent()}function P(e,t){var i=at.nextItem(e.currentSpineItem(),!0);if(!i)return void t(!1);var n=(F(),O());n.element().insertAfter(e.element()),n.loadSpineItem(i,function(e,r,o,a,s){if(e){var l=function(i){N(n,e,r,o,a,s),t(i)};E(2,n,r[0],o.href,o.isFixedLayout(),o.isFixedLayout()?n.meta_width():0,"addToBottomOf",l)}else console.error("Unable to load "+i.href),t(!1)})}function T(){var e=[];x(function(t){e.push(t)},!1);for(var t=0,i=e.length;i>t;t++)w(e[t])
}function w(e){e.element().remove()}function b(e){Q.css("left",e.left),Q.css("top",e.top),Q.css("right",e.right),Q.css("bottom",e.bottom)}function O(e){u.disablePageTransitions=!0;var t=new a(u,["content-doc-frame"],!0,f);return t.render(),ht&&t.setViewSettings(ht),e||t.element().data("pageView",t),c&&t.decorateIframe(),t}function C(e,t){var i=void 0;return x(function(t){return t.currentSpineItem()==e?(i=t,!1):!0},t),i}function x(e,t){for(var i=Q.children(),n=i.length,r=t?function(e){return e-1}:function(e){return e+1},o=t?function(e){return e>=0}:function(e){return n>e},a=t?n-1:0,s=a;o(s);s=r(s)){var l=i.eq(s),d=l.data("pageView");if(d&&e(d)===!1)return}}function R(){var e=void 0;return x(function(t){return e=t,!1},!1),e}function D(){var e=void 0;return x(function(t){return e=t,!1},!0),e}function N(e,t,i,n,r){t&&r&&rt.emit(l.Events.CONTENT_DOCUMENT_LOADED,i,n)}function A(e,t){T();var i=(F(),O());Q.append(i.element()),i.loadSpineItem(e,function(e,n,r,o,a){if(e){var s=function(){N(i,e,n,r,o,a),t(i)};E(1,i,n[0],r.href,r.isFixedLayout(),r.isFixedLayout()?i.meta_width():0,"openPage",s)}else console.error("Unable to load "+r.href),w(i),i=void 0;t(i)})}function M(e,t){var i,n,r,o,a=0;if(void 0!==t.scrollTop)a=t.scrollTop;else if(void 0!==t.spineItemPageIndex){var s;i=L(),s=t.spineItemPageIndex<0?0:t.spineItemPageIndex>=i?i-1:t.spineItemPageIndex,a=s*V()}else if(e&&t.elementId){if(o=j(e),r=e.getNavigator(),n=r.getElementById(t.elementId),!n||!n.length)return void console.warn("Element id="+t.elementId+" not found!");if(J(e,n,60))return void k(t.initiator,t.spineItem,t.elementId);a=r.getVerticalOffsetForElement(n)+o.top}else if(e&&t.elementCfi){if(o=j(e),r=e.getNavigator(),n=r.getElementByCfi(t.elementCfi),!n||!n.length)return void console.warn("Element cfi="+t.elementCfi+" not found!");if(J(e,n,60))return void k(t.initiator,t.spineItem,t.elementId);a=r.getVerticalOffsetForElement(n)+o.top}else if(t.firstPage)a=0;else if(t.lastPage){if(i=L(),0===i)return;a=B()-V()-5}else e?(o=j(e),a=o.top):a=0;F()!=a?(ut=!0,I(a,t),setTimeout(function(){ut=!1},nt+100)):k(t.initiator,t.spineItem,t.elementId)}function L(){return Math.ceil(B()/V())}function k(e,t,i){rt.emit(l.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:rt.getPaginationInfo(),initiator:e,spineItem:t,elementId:i})}function F(){return Q[0].scrollTop}function U(){return B()-(F()+V())}function V(){return Q.height()}function B(){return Q[0].scrollHeight}function G(){var e=[],t=q(-tt);return x(function(i){if(H(i,t))e.push(i);else if(e.length>0)return!1;return!0},!1),e}function W(){var e=G();return e[0]}function H(e,t){var i=j(e);return Y(z(i,t))>0}function j(e){var t={top:0,bottom:0};return t.top=e.element().position().top+F(),t.bottom=t.top+e.getCalculatedPageHeight(),t}function q(e){0===e||e||(e=0);var t={top:F()-e,bottom:F()+V()+e};return t.top<0&&(t.top=0),t.bottom>B()&&(t.bottom=B()),t}function z(e,t){return{top:Math.max(e.top,t.top),bottom:Math.min(e.bottom,t.bottom)}}function Y(e){return e.bottom<e.top?0:e.bottom-e.top}function J(e,t,i){var n=$(e,t);return X(n,i)}function X(e,t){var i=q(),n=Math.min(Y(i),Y(e));0===n&&(n=5);var r=z(i,e),o=Y(r)/n*100;return o>=t}function $(e,t){var i=j(e),n={top:0,bottom:0};return n.top=t.offset().top+i.top,n.bottom=n.top+t.height(),n}var K=!1;t.extend(this,new i);var Z,Q,et,tt=5,it=2e3,nt=300,rt=this,ot=u.$viewport,at=u.spine,st=u.userStyles,lt=!1,dt=!1,ut=!1,ct=!1;this.isContinuousScroll=function(){return c},this.render=function(){var i=o.loadTemplate("scrolled_book_frame",{});et=e(i),ot.append(et),Q=e("#scrolled-content-frame",et),Q.css("overflow",""),Q.css("overflow-y","auto"),Q.css("overflow-x","hidden"),Q.css("-webkit-overflow-scrolling","touch"),Q.css("width","100%"),Q.css("height","100%"),Q.css("position","relative");var n=f.viewerSettings();n&&"undefined"!=typeof n.enableGPUHardwareAccelerationCSS3D||(n=new d({})),n.enableGPUHardwareAccelerationCSS3D&&Q.css("transform","translateZ(0)"),rt.applyStyles();var r=t.debounce(v,nt);return Q.on("scroll",function(e){r(e),g()}),rt};var ft=!1;this.remove=function(){et.remove()},this.onViewportResize=function(){Q&&(x(function(e){S(e)},!1),k(rt),p())};var ht=void 0;this.setViewSettings=function(e){ht=e,x(function(t){t.setViewSettings(e)},!1)},this.applyStyles=function(){o.setStyles(st.getStyles(),et.parent());var e=o.Margins.fromElement(et);b(e.padding)},this.applyBookStyles=function(){x(function(e){e.applyBookStyles()},!1)},this.openPage=function(e){lt=!0;var t=function(e,t){Z=void 0,M(e,t),lt=!1,p(e)};if(e.spineItem){var i=C(e.spineItem);i?t(i,e):(Z=e,ct=!0,A(e.spineItem,function(i){setTimeout(function(){ct=!1},nt+100),i&&Z?i.currentSpineItem()===Z.spineItem?t(i,Z):rt.openPage(Z):k(e.initiator,e.spineItem,e.elementId)}))}else t(void 0,e)},this.openPageNext=function(e){var t;U()>0&&(t=new s(void 0,e),t.scrollTop=F()+Math.min(U(),V()-tt),M(void 0,t))},this.openPagePrev=function(e){var t;F()>0&&(t=new s(void 0,e),t.scrollTop=F()-(V()-tt),t.scrollTop<0&&(t.scrollTop=0),M(void 0,t))},this.getFirstVisibleElementCfi=function(){var e=W();return e?e.getNavigator().getFirstVisibleElementCfi(F()):void 0},this.getPaginationInfo=function(){for(var e,t,i,n,o,a,s,l,d=q(),u=d.bottom-d.top,c=new r(at,!1),f=G(),h=0,m=f.length;m>h;h++)i=f[h],e=i.currentSpineItem(),n=j(i),o=Math.max(d.top-n.top,0),a=Math.max(n.bottom-d.bottom,0),s=Math.ceil(o/u),l=Math.ceil(a/u),t=s+l+1,c.addOpenPage(s,t,e.idref,e.index);return c},this.bookmarkCurrentPage=function(){var e=W();return e?new n(e.currentSpineItem().idref,rt.getFirstVisibleElementCfi()):new n("","")},this.getLoadedSpineItems=function(){var e=[];return x(function(t){e.push(t.currentSpineItem())},!1),e},this.getElement=function(e,t){var i=void 0;return x(function(n){return n.currentSpineItem()==e?(i=n.getNavigator().getElement(t),!1):!0},!1),i},this.getElementByCfi=function(e,t,i,n,r){var o=void 0;return x(function(a){return a.currentSpineItem()==e?(o=a.getElementByCfi(e,t,i,n,r),!1):!0},!1),o?o:void console.error("spine item is not loaded")},this.getElementById=function(e,t){var i=void 0;return x(function(n){return n.currentSpineItem()==e?(i=n.getNavigator().getElementById(t),!1):!0},!1),i?i:void console.error("spine item is not loaded")},this.getFirstVisibleMediaOverlayElement=function(){var e,t=q(),i=void 0,n={top:0,bottom:0},r=!1;return x(function(o){if(e=j(o),n.top=Math.max(e.top,t.top)-e.top,n.bottom=Math.min(e.bottom,t.bottom)-e.top,Y(n)>0){if(r=!0,i=o.getNavigator().getFirstVisibleMediaOverlayElement(n))return!1}else if(r)return!1;return!0},!1),i},this.insureElementVisibility=function(t,i,n){var r=void 0;if(x(function(e){return e.currentSpineItem().idref===t?(r=e,!1):!0},!1),!r)return void console.warn("Page for element "+i+" not found");var o=e(i),a=$(r,o);if(!X(a,60)){var l=at.getItemById(t),d=new s(l,n);d.scrollTop=a.top,rt.openPage(d)}}};return u}),define("readium_shared_js/views/media_overlay_player",["jquery","../helpers","./audio_player","./media_overlay_element_highlighter","../globals","../models/smil_iterator","rangy","readium_cfi_js","./scroll_view"],function(e,t,i,n,r,o,a,s,l){var d=function(s,d){function u(e){var t=e.getSmil();return E&&E.smil==t?E.reset():E=new o(t),E.goToPar(e),E.currentPar?void f():void console.error("playPar !_smilIterator.currentPar")}function c(){D.resetBlankPage(),k=setTimeout(function(){if(k){if(D.resetBlankPage(),!E||!E.currentPar)return void D.reset();U=0,m(E.currentPar.audio.clipEnd+.1,2)}},2e3),d({isPlaying:!0})}function f(){if(q=!1,!E||!E.currentPar)return void console.error("playCurrentPar !_smilIterator || !_smilIterator.currentPar ???");if(!E.smil.id)return _.reset(),D.resetTTS(),D.resetEmbedded(),void setTimeout(function(){c()},100);if(E.currentPar.audio.src){D.resetTTS(),D.resetEmbedded(),D.resetBlankPage();var i=E.currentPar.audio.clipEnd-E.currentPar.audio.clipBegin;(0>=i||L>i)&&(console.error("### MO XXX PAR OFFSET: "+L+" / "+i),L=0);var n=t.ResolveContentRef(E.currentPar.audio.src,E.smil.href),r=x.resolveRelativeUrlMO(n),o=E.currentPar.audio.clipBegin+L;_.playFile(E.currentPar.audio.src,r,o)}else{L=0,_.reset();var s=E.currentPar.element;if(s){U=0;var l=s.nodeName?s.nodeName.toLowerCase():void 0;"audio"===l||"video"===l?(D.resetTTS(),D.resetBlankPage(),C&&D.resetEmbedded(),C=s,C.pause(),C.currentTime=0,C.play(),e(C).on("ended",D.onEmbeddedEnd),O=!0,setTimeout(function(){d({isPlaying:!0})},80)):(D.resetEmbedded(),D.resetBlankPage(),P=s.textContent,P&&""!=P?W(P):P=void 0)}var u=E.currentPar.cfi;if(u){U=0,D.resetEmbedded(),D.resetBlankPage(),N.reset();var f=u.cfiTextParent.ownerDocument,h="epubcfi("+u.partialStartCfi+")",m=EPUBcfi.getTextTerminusInfoWithPartialCFI(h,f,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),p="epubcfi("+u.partialEndCfi+")",g=EPUBcfi.getTextTerminusInfoWithPartialCFI(p,f,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);if(a){var v=a.createRange(f);v.setStartAndEnd(m.textNode[0],m.textOffset,g.textNode[0],g.textOffset),P=v.toString()}else P=void 0;P&&""!=P?W(P):P=void 0}}L=0,y()}function h(e){D.pause();var t=e?x.media_overlay.getNextSmil(E.smil):x.media_overlay.getPreviousSmil(E.smil);if(t){if(E=new o(t),E.currentPar){if(!e)for(;!E.isLast();)E.next();s.openContentUrl(E.currentPar.text.src,E.smil.href,D)}}else console.log("No more SMIL"),D.reset()}function m(e,t){if(U=e,F=!1,E&&E.currentPar){var i=E.currentPar,n=E.currentPar.audio;if(!(e>V&&e<=n.clipEnd)){F=!0;var r=_.isPlaying();r&&6===t&&console.debug("from userNav _audioPlayer.isPlaying() ???");var o=e>n.clipEnd,a=!Y&&6!==t&&o,s=E&&E.smil&&E.smil.spineItemId?E.smil.spineItemId:M&&M.spineItem&&M.spineItem.idref?M.spineItem.idref:void 0;if(a&&s&&M&&M.paginationInfo&&M.paginationInfo.openPages&&M.paginationInfo.openPages.length>1){var l=0,d=M.paginationInfo.openPages[l];s===d.idref&&(a=!1)}if(o?E.next():E.previous(),!E.currentPar)return void(a?(z=!0,D.reset()):h(o));if(!E.currentPar.audio)return void D.pause();if(R.mediaOverlaysSkipSkippables){for(var u=!1,c=E.currentPar;c;){if(c.isSkippable&&c.isSkippable(R.mediaOverlaysSkippables)){u=!0;break}c=c.parent}if(u){console.log("MO SKIP: "+c.epubtype),D.pause();var p=o?E.currentPar.audio.clipEnd+.1:V-1;return void m(p,t,!0)}}if(!r&&(E.currentPar.element||E.currentPar.cfi&&E.currentPar.cfi.cfiTextParent)){var g=N.adjustParToSeqSyncGranularity(E.currentPar);if(g&&g!==E.currentPar){var v=N.adjustParToSeqSyncGranularity(i);if(v&&(v===g||!o)){if(v===g){do o?E.next():E.previous();while(E.currentPar&&E.currentPar.hasAncestor(v));if(!E.currentPar)return void(a?(z=!0,D.reset()):h(o))}if(!o){var I=N.adjustParToSeqSyncGranularity(E.currentPar);if(I&&I!==E.currentPar){var S=E.currentPar,P=void 0;do P=E.currentPar,E.previous();while(E.currentPar&&E.currentPar.hasAncestor(I));E.currentPar?(E.next(),E.currentPar.hasAncestor(I)||console.error("adjustParToSeqSyncGranularity !_smilIterator.currentPar.hasAncestor(landed) ???")):(E.reset(),E.currentPar!==P&&console.error("adjustParToSeqSyncGranularity _smilIterator.currentPar !=== innerPar???")),E.currentPar||(console.error("adjustParToSeqSyncGranularity !_smilIterator.currentPar ?????"),E.goToPar(S))}}}}}return _.isPlaying()&&E.currentPar.audio.src&&E.currentPar.audio.src==_.currentSmilSrc()&&e>=E.currentPar.audio.clipBegin&&e<=E.currentPar.audio.clipEnd?void y():void f()}}}function p(t){if(!G||G[0].ownerDocument!==t[0].ownerDocument){var i=".tts_on{background-color:red;color:white;} .tts_off{}";$head=e("head",t[0].ownerDocument.documentElement),G=e("<style type='text/css'> </style>").appendTo($head),G.append(i)}}function g(){v();var e=function(){if(E&&E.currentPar){var e=E.smil;if(e.mo){var t=U-E.currentPar.audio.clipBegin;if(!(0>=t)){for(var i=e.mo.smil_models.indexOf(e),n=new o(e),r=-1;n.currentPar&&(r++,n.currentPar!=E.currentPar);)n.next();d({playPosition:t,smilIndex:i,parIndex:r})}}}};setTimeout(e,500),j=setInterval(e,1500)}function v(){U=0,void 0!==j&&clearInterval(j),j=void 0}function I(){return v(),F?void(F=!1):E&&E.currentPar?void m(E.currentPar.audio.clipEnd+.1,5):void D.reset()}function y(){if(E&&E.currentPar){if(E.currentPar.text.srcFragmentId&&E.currentPar.text.srcFragmentId.length>0){if(E.currentPar.element)return void(N.isElementHighlighted(E.currentPar)||(N.highlightElement(E.currentPar,x.media_overlay.activeClass,x.media_overlay.playbackActiveClass),q||s.insureElementVisibility(E.currentPar.getSmil().spineItemId,E.currentPar.element,D)));if(E.currentPar.cfi)return void(N.isCfiHighlighted(E.currentPar)||(N.highlightCfi(E.currentPar,x.media_overlay.activeClass,x.media_overlay.playbackActiveClass),q||s.insureElementVisibility(E.currentPar.getSmil().spineItemId,E.currentPar.cfi.cfiTextParent,D)))}if(!E.currentPar.element){var e=E.currentPar.text.src,t=E.smil.href;E=void 0,s.openContentUrl(e,t,D)}}}var E=void 0,_=new i(d,m,I,g,v),S=!1,P=void 0,T=!0&&"undefined"!=typeof window.speechSynthesis&&null!=speechSynthesis,w=void 0,b=!1,O=!1,C=void 0;this.isPlaying=function(){return _.isPlaying()||S||O||k};var x=s["package"](),R=s.viewerSettings(),D=this,N=new n(s);s.on(r.Events.READER_VIEW_DESTROYED,function(){D.reset()}),this.applyStyles=function(){N.reDo()},this.onSettingsApplied=function(){_.setRate(R.mediaOverlaysRate),_.setVolume(R.mediaOverlaysVolume/100)},D.onSettingsApplied(),s.on(r.Events.SETTINGS_APPLIED,this.onSettingsApplied,this);var A=!1;this.onDocLoadStart=function(){var e=D.isPlaying();e&&(A=!0,D.pause())};var M=void 0;this.onPageChanged=function(t){M=t;var i=z;z=!1;var n=A;if(A=!1,!t)return void D.reset();var r=void 0,o="/99!",a="epubcfi";if(t.elementId||t.initiator==D){for(var l=s.getLoadedSpineItems(),d=s.spine().isRightToLeft(),c=d?l.length-1:0;d&&c>=0||!d&&c<l.length;c+=d?-1:1){var h=l[c];if(!t.spineItem||t.spineItem==h){if(t.elementId&&0===t.elementId.indexOf(a)){N.reset();var m=t.elementId.substr(a.length+1,t.elementId.length-a.length-2);0===m.indexOf(o)&&(m=m.substr(o.length,m.length-o.length));var p=m.split(",");if(p&&3===p.length)try{var g=p[0]+p[1],v=s.getElementByCfi(h,g,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);if(r=v&&v.length>0?v[0]:void 0){r.nodeType===Node.TEXT_NODE&&(r=r.parentNode);break}}catch(I){console.error(I)}else try{var v=s.getElementByCfi(h,m,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);if(r=v&&v.length>0?v[0]:void 0){r.nodeType===Node.TEXT_NODE&&(r=r.parentNode);break}}catch(I){console.error(I)}}if(!r){if(t.initiator!=D||t.elementId){var v=s.getElementById(h,t.elementId);r=v&&v.length>0?v[0]:void 0}else{var v=s.getElement(h,"body");r=v&&v.length>0?v[0]:void 0}if(r)break}}}r||console.error("paginationData.elementId BUT !element: "+t.elementId)}var _=D.isPlaying()||n;if(!E||!E.currentPar){if(t.initiator!==D)return L=0,D.reset(),void(t.elementId&&r?(_||i)&&(t.elementIdResolved=r,D.toggleMediaOverlayRefresh(t)):(_||i)&&D.toggleMediaOverlay());if(!r)return console.error("!element: "+t.elementId),void(L=0);var S=e(r).data("mediaOverlayData");if(!S)return console.error("!moData: "+t.elementId),void(L=0);var P=S.par?S.par:S.pars[0];if(S.pars)for(var T=0;T<S.pars.length;T++){var w=S.pars[T];if(t.elementId===w.cfi.smilTextSrcCfi){P=w;break}}return void u(P)}var b=!E.currentPar.element&&!E.currentPar.cfi;if(b&&console.error("!! _smilIterator.currentPar.element ??"),t.initiator==D){var O=t.elementId&&t.elementId!==E.currentPar.text.srcFragmentId;if(O&&console.error("!! paginationData.elementId !== _smilIterator.currentPar.text.srcFragmentId"),O||b)return void(L=0);_?y():f()}else{if(!_&&!i)return void D.reset();if(!t.elementId,t.elementId&&!r)return;t.elementId&&(t.elementIdResolved=r),D.toggleMediaOverlayRefresh(t)}};var L=0,k=void 0,F=!1,U=0,V=-999;this.touchInit=function(){var e=_.touchInit();e&&T&&W("o",0)};var B=function(e){var t=["p","div","pagenum","td","table","li","ul","ol"],i=[",",";",".","-","??","??","?","!"],n=function(e,t){if(!(e.word.length<=0)){var i=e.text.length;t.spanMap[i]=e.counter,e.text+=e.word,e.markup+=e.html.substring(0,e.wordStart)+'<span class="tts_off" id="tts_'+e.counter+'">'+e.html.substring(e.wordStart,e.wordEnd)+"</span>"+e.html.substring(e.wordEnd,e.html.length),e.word="",e.html="",e.wordStart=-1,e.wordEnd=-1,e.counter++}},r={element:e,innerHTML_tts:"",spanMap:{},text:"",lastCharIndex:void 0};r.element.innerHTML_original=e.innerHTML;for(var o={inTag:!1,counter:0,wordStart:-1,wordEnd:-1,text:"",markup:"",word:"",html:""},a=r.element.innerHTML_original.length,s=0;a>=s;){if(o.inTag){if(o.html+=r.element.innerHTML_original[s],">"==r.element.innerHTML_original[s]){o.inTag=!1;var l=o.html.match(/<\/(.*?)>$/);l&&t.indexOf(l[1])>-1&&(n(o,r),o.text+=" ")}}else s==a||r.element.innerHTML_original[s].match(/\s/)?(n(o,r),a>s&&(o.text+=r.element.innerHTML_original[s],o.markup+=r.element.innerHTML_original[s])):i.indexOf(r.element.innerHTML_original[s])>-1?(n(o,r),o.wordStart=o.html.length,o.wordEnd=o.html.length+1,o.word+=r.element.innerHTML_original[s],o.html+=r.element.innerHTML_original[s],n(o,r)):"<"==r.element.innerHTML_original[s]?(o.inTag=!0,o.html+=r.element.innerHTML_original[s]):(0==o.word.length&&(o.wordStart=o.html.length),o.wordEnd=o.html.length+1,o.word+=r.element.innerHTML_original[s],o.html+=r.element.innerHTML_original[s]);s++}return r.text=o.text,r.innerHTML_tts=o.markup,r.element.innerHTML=r.innerHTML_tts,r},G=void 0,W=function(t,i){function n(e){e||window.speechSynthesis.pending?(console.debug("TTS cancel before speak"),window.speechSynthesis.cancel(),setTimeout(function(){n(!1)},5)):o()}function o(){w=new SpeechSynthesisUtterance,b&&a&&(w.tokenData=a,w.onboundary=function(e){if(w){console.debug("TTS boundary: "+e.name+" / "+e.charIndex);var t=e.target.tokenData;if(t&&t.spanMap.hasOwnProperty(e.charIndex)){var i;[].forEach.call(t.element.querySelectorAll(".tts_on"),function(e){console.debug("TTS OFF "+e.id),e.className="tts_off"});var i="tts_"+t.spanMap[e.charIndex];console.debug("TTS charIndex ID: "+i);var n=t.element.querySelector("#"+i);n&&(console.debug("TTS ON"),n.className="tts_on"),t.lastCharIndex=e.charIndex}}}),w.onend=function(e){if(w)if(console.debug("TTS ended"),b){var t=e.target.tokenData,i=!e.forceSkipEnd&&w===e.target&&(!t||t.element.innerHTML_original);t&&(t.element.innerHTML_original?t.element.innerHTML=t.element.innerHTML_original:[].forEach.call(t.element.querySelectorAll(".tts_on"),function(e){console.debug("TTS OFF (end)"+e.id),e.className="tts_off"}),t.element.innerHTML_original=void 0),i?D.onTTSEnd():console.debug("TTS end SKIPPED")}else D.onTTSEnd()},w.onerror=function(e){if(w&&(console.error("TTS error"),console.debug(w.text),console.debug(window.speechSynthesis.paused),console.debug(window.speechSynthesis.pending),console.debug(window.speechSynthesis.speaking),b)){var t=e.target.tokenData;t&&(t.element.innerHTML_original?t.element.innerHTML=t.element.innerHTML_original:[].forEach.call(t.element.ownerDocument.querySelectorAll(".tts_on"),function(e){console.debug("TTS OFF (error)"+e.id),e.className="tts_off"}),t.element.innerHTML_original=void 0)}};var e=i||_.getVolume();w.volume=e,w.rate=_.getRate(),w.pitch=1,w.text=f,window.speechSynthesis.speak(w),window.speechSynthesis.paused&&(console.debug("TTS resume"),window.speechSynthesis.resume())}{var a=void 0,l=E&&E.currentPar?E.currentPar:void 0,u=l?l.element:void 0;l?l.cfi:void 0}if((!i||i>0)&&(setTimeout(function(){d({isPlaying:!0})},80),S=!0,b&&u)){var c=e(u);p(c),u.innerHTML_original&&(u.innerHTML=u.innerHTML_original,u.innerHTML_original=void 0),a=B(u)}if(!T)return void s.emit(r.Events.MEDIA_OVERLAY_TTS_SPEAK,{tts:t});if(!t&&window.speechSynthesis.paused)return void window.speechSynthesis.resume();var f=t||P;f&&(w&&(b&&(w.onend&&w.onend({forceSkipEnd:!0,target:w}),w.tokenData=void 0,w.onboundary=void 0),w.onend=void 0,w.onerror=void 0,w=void 0),console.debug("paused: "+window.speechSynthesis.paused),console.debug("speaking: "+window.speechSynthesis.speaking),console.debug("pending: "+window.speechSynthesis.pending),n(!0))},H=function(){return d({isPlaying:!1}),S=!1,T?void window.speechSynthesis.pause():void s.emit(r.Events.MEDIA_OVERLAY_TTS_STOP,void 0)},j=void 0;this.onEmbeddedEnd=function(){return U=0,O=!1,E&&E.currentPar?void m(E.currentPar.audio.clipEnd+.1,3):void D.reset()},this.onTTSEnd=function(){return U=0,S=!1,E&&E.currentPar?void m(E.currentPar.audio.clipEnd+.1,4):void D.reset()},this.escape=function(){if(!E||!E.currentPar)return void this.toggleMediaOverlay();if(!D.isPlaying())return void D.play();if(R.mediaOverlaysEscapeEscapables)for(var e=E.currentPar;e;){if(e.isEscapable&&e.isEscapable(R.mediaOverlaysEscapables)){do E.next();while(E.currentPar&&E.currentPar.hasAncestor(e));return E.currentPar?void f():void h(!0)}e=e.parent}this.nextMediaOverlay(!0)},this.playUserPar=function(e){if(D.isPlaying()&&D.pause(),e.element||e.cfi&&e.cfi.cfiTextParent){var t=N.adjustParToSeqSyncGranularity(e);if(t&&t!==e){var i=function(e){if(e.nodeType&&"par"===e.nodeType)return e;if(!e.children||e.children.length<=0)return void 0;for(var t=0;t<e.children.length;t++){var n=e.children[t],r=i(n);if(r)return r}},n=i(t);n&&(e=n)}}u(e)},this.resetTTS=function(){P=void 0,H()},this.resetBlankPage=function(){if(k){var e=k;k=void 0,clearTimeout(e)}k=void 0,d({isPlaying:!1})},this.resetEmbedded=function(){C&&(e(C).off("ended",D.onEmbeddedEnd),C.pause()),C=void 0,d({isPlaying:!1}),O=!1},this.reset=function(){L=0,_.reset(),D.resetTTS(),D.resetEmbedded(),D.resetBlankPage(),N.reset(),E=void 0,F=!1},this.play=function(){if(E&&E.smil&&!E.smil.id)return void c();if(C)O=!0,C.play(),d({isPlaying:!0});else if(P)W(void 0);else if(!_.play())return console.log("Audio player was dead, reactivating..."),this.reset(),void this.toggleMediaOverlay();y()},this.pause=function(){q=!1,k?this.resetBlankPage():O?(O=!1,C&&C.pause(),d({isPlaying:!1})):S?H():_.pause(),N.reset()},this.isMediaOverlayAvailable=function(){var e=s.getFirstVisibleMediaOverlayElement();return"undefined"!=typeof e},this.nextOrPreviousMediaOverlay=function(e){if(D.isPlaying())D.pause();else if(E&&E.currentPar)return void D.play();if(!E)return void this.toggleMediaOverlay();var t=e?V-1:E.currentPar.audio.clipEnd+.1;m(t,6)},this.nextMediaOverlay=function(){this.nextOrPreviousMediaOverlay(!1)},this.previousMediaOverlay=function(){this.nextOrPreviousMediaOverlay(!0)},this.mediaOverlaysOpenContentUrl=function(e,t,i){L=i,E=void 0,s.openContentUrl(e,t,D)},this.toggleMediaOverlay=function(){return D.isPlaying()?void D.pause():E?void D.play():void this.toggleMediaOverlayRefresh(void 0)};var q=!1;this.toggleMediaOverlayRefresh=function(t){var i=s.getLoadedSpineItems(),n=s.spine().isRightToLeft(),r=void 0,a=D.isPlaying();if(a&&E){var d=t.initiator&&t.initiator instanceof l;if(d&&R.mediaOverlaysPreservePlaybackWhenScroll)return void(q=!0);r=E.currentPar,D.pause()}q=!1;var u=t&&t.elementIdResolved?t.elementIdResolved:void 0,c=t&&t.elementId?t.elementId:void 0;if(!u){c&&console.error("[WARN] id did not resolve to element?");for(var h=n?i.length-1:0;n&&h>=0||!n&&h<i.length;h+=n?-1:1){var m=i[h];if(m){if(!t||!t.spineItem||t.spineItem==m){if(c){var p=s.getElementById(m,c);u=p&&p.length>0?p[0]:void 0}else if(m.isFixedLayout()&&t&&t.paginationInfo&&t.paginationInfo.openPages){var g=0;if(t.paginationInfo.openPages[g]&&t.paginationInfo.openPages[g].idref&&t.paginationInfo.openPages[g].idref===m.idref){var p=s.getElement(m,"body");u=p&&p.length>0?p[0]:void 0}}if(u)break}}else console.error("spineItems[i] is undefined??")}}if(u||(u=s.getFirstVisibleMediaOverlayElement()),!u)return void D.reset();var v=e(u).data("mediaOverlayData");if(!v){for(var I=!1,y=function(t){if(!t)return!1;for(var i=0;i<t.length;i++){if(u===t[i]&&(I=!0),I){var n=e(t[i]).data("mediaOverlayData");if(n)return v=n,!0}var r=y(t[i].children);if(r)return!0}return!1},_=u;_&&"body"!==_.nodeName.toLowerCase();)_=_.parentNode;if(!_)return void D.reset();y([_])}if(!v)return void D.reset();var S=v.par?v.par:v.pars[0],P=S.getSmil();return E&&E.smil==P?E.reset():E=new o(P),E.goToPar(S),!E.currentPar&&c&&(E.reset(),E.findTextId(c)),E.currentPar?void(a&&r&&r===E.currentPar?D.play():f()):void D.reset()},this.isPlayingCfi=function(){return E&&E.currentPar&&E.currentPar.cfi};var z=!1,Y=!0;this.setAutomaticNextSmil=function(e){Y=e}};return d}),define("readium_shared_js/models/spine",["./spine_item"],function(e){var t=function(t,i){function n(e){return!d||"no"!==e.linear}function r(e){if(!a(e))return void 0;var t=l.items[e];return n(t)?t:r(t.index+1)}function o(e){if(!a(e))return void 0;var t=l.items[e];return n(t)?t:o(t.index-1)}function a(e){return e>=0&&e<l.items.length}function s(){for(var t=l.items.length,i=!1,n=l.isLeftToRight()?e.SPREAD_LEFT:e.SPREAD_RIGHT,r=0;t>r;r++){var o=l.items[r];if(!o.page_spread){var a=o.isRenditionSpreadAllowed()?i?n:e.alternateSpread(n):e.SPREAD_CENTER;o.setSpread(a)}i=!o.isRenditionSpreadAllowed()||o.page_spread!=n}}var l=this;this.items=[],this.direction="ltr",this["package"]=t;var d=!1;if(this.handleLinear=function(e){d=e},this.isValidLinearItem=function(e){return a(e)?n(this.item(e)):void 0},this.prevItem=function(e){return o(e.index-1)},this.nextItem=function(e){return r(e.index+1)},this.getItemUrl=function(e){return l["package"].resolveRelativeUrl(e.href)},this.first=function(){return r(0)},this.last=function(){return o(this.items.length-1)},this.isFirstItem=function(e){return l.first()===e},this.isLastItem=function(e){return l.last()===e},this.item=function(e){return a(e)?l.items[e]:void 0},this.isRightToLeft=function(){return"rtl"==l.direction},this.isLeftToRight=function(){return!l.isRightToLeft()},this.getItemById=function(e){for(var t=l.items.length,i=0;t>i;i++)if(l.items[i].idref==e)return l.items[i];return void 0},this.getItemByHref=function(e){for(var t=l.items.length,i=0;t>i;i++)if(l.items[i].href==e)return l.items[i];return void 0},i){i.direction&&(this.direction=i.direction);for(var u=i.items.length,c=0;u>c;c++){var f=new e(i.items[c],c,this);this.items.push(f)}s()}};return t}),define("readium_shared_js/models/smil_model",["../helpers"],function(e){var t={};t.SmilNode=function(e){this.parent=e,this.id="",this.getSmil=function(){for(var e=this;e.parent;)e=e.parent;return e},this.hasAncestor=function(e){for(var t=this.parent;t;){if(t==e)return!0;t=t.parent}return!1}},t.TimeContainerNode=function(e){this.parent=e,this.children=void 0,this.index=void 0,this.epubtype="",this.isEscapable=function(e){if(""===this.epubtype)return!1;var t=this.getSmil();if(!t.mo)return!1;var i=t.mo.escapables;e.length>0&&(i=e);for(var n=0;n<i.length;n++)if(this.epubtype.indexOf(i[n])>=0)return!0;return!1},this.isSkippable=function(e){if(""===this.epubtype)return!1;var t=this.getSmil();if(!t.mo)return!1;var i=t.mo.skippables;e.length>0&&(i=e);for(var n=0;n<i.length;n++)if(this.epubtype.indexOf(i[n])>=0)return!0;return!1}},t.TimeContainerNode.prototype=new t.SmilNode,t.MediaNode=function(e){this.parent=e,this.src=""},t.MediaNode.prototype=new t.SmilNode,t.SeqNode=function(e){this.parent=e,this.children=[],this.nodeType="seq",this.textref="",this.durationMilliseconds=function(){for(var e=this.getSmil(),t=0,i=0;i<this.children.length;i++){var n=this.children[i];if("par"===n.nodeType){if(!n.audio)continue;if(n.text&&(!n.text.manifestItemId||n.text.manifestItemId!=e.spineItemId))continue;var r=n.audio.clipDurationMilliseconds();t+=r}else"seq"===n.nodeType&&(t+=n.durationMilliseconds())}return t},this.clipOffset=function(e,t){for(var i=this.getSmil(),n=0;n<this.children.length;n++){var r=this.children[n];if("par"===r.nodeType){if(r==t)return!0;if(!r.audio)continue;if(r.text&&(!r.text.manifestItemId||r.text.manifestItemId!=i.spineItemId))continue;var o=r.audio.clipDurationMilliseconds();e.offset+=o}else if("seq"===r.nodeType){var a=r.clipOffset(e,t);if(a)return!0}}return!1},this.parallelAt=function(e){for(var t=this.getSmil(),i=0,n=0;n<this.children.length;n++){var r=e-i,o=this.children[n];if("par"===o.nodeType){if(!o.audio)continue;if(o.text&&(!o.text.manifestItemId||o.text.manifestItemId!=t.spineItemId))continue;var a=o.audio.clipDurationMilliseconds();if(a>0&&a>=r)return o;i+=a}else if("seq"===o.nodeType){var s=o.parallelAt(r);if(s)return s;i+=o.durationMilliseconds()}}return void 0},this.nthParallel=function(e,t){for(var i=0;i<this.children.length;i++){var n=this.children[i];if("par"===n.nodeType){if(t.count++,t.count==e)return n}else if("seq"===n.nodeType){var r=n.nthParallel(e,t);if(r)return r}}return void 0}},t.SeqNode.prototype=new t.TimeContainerNode,t.ParNode=function(e){this.parent=e,this.children=[],this.nodeType="par",this.text=void 0,this.audio=void 0,this.element=void 0,this.getFirstSeqAncestorWithEpubType=function(e,t){if(!e)return void 0;for(var i=t?this:this.parent;i;){if(i.epubtype&&i.epubtype.indexOf(e)>=0)return i;i=i.parent}return void 0}},t.ParNode.prototype=new t.TimeContainerNode,t.TextNode=function(t){this.parent=t,this.nodeType="text",this.srcFile="",this.srcFragmentId="",this.manifestItemId=void 0,this.updateMediaManifestItemId=function(){var t=this.getSmil();if(t.href&&t.href.length){for(var i=this.srcFile?this.srcFile:this.src,n=e.ResolveContentRef(i,t.href),r=t.mo["package"].resolveRelativeUrlMO(n),o=0;o<t.mo["package"].spine.items.length;o++){var a=t.mo["package"].spine.items[o],s=t.mo["package"].resolveRelativeUrl(a.href);if(s===r)return void(this.manifestItemId=a.idref)}console.error("Cannot set the Media ManifestItemId? "+this.src+" && "+t.href)}}},t.TextNode.prototype=new t.MediaNode,t.AudioNode=function(e){this.parent=e,this.nodeType="audio",this.clipBegin=0,this.MAX=1234567890.1,this.clipEnd=this.MAX,this.clipDurationMilliseconds=function(){var e=1e3*this.clipBegin,t=1e3*this.clipEnd;return this.clipEnd>=this.MAX||e>=t?0:t-e}},t.AudioNode.prototype=new t.MediaNode;var i=function(){this.parent=void 0,this.children=[],this.id=void 0,this.href=void 0,this.duration=void 0,this.mo=void 0,this.parallelAt=function(e){return this.children[0].parallelAt(e)},this.nthParallel=function(e){var t={count:-1};return this.children[0].nthParallel(e,t)},this.clipOffset=function(e){var t={offset:0};return this.children[0].clipOffset(t,e)?t.offset:0},this.durationMilliseconds_Calculated=function(){return this.children[0].durationMilliseconds()};var e=[];this.hasSync=function(t){for(var i=0;i<e.length;i++)if(e[i]===t)return!0;return!1},this.addSync=function(t){if(t)for(var i=t.split(" "),n=0;n<i.length;n++){var r=i[n].trim();r.length>0&&!this.hasSync(r)&&e.push(r)}}};return i.fromSmilDTO=function(e,n){n.DEBUG&&console.debug("Media Overlay DTO import...");var r=0,o=function(){for(var e="",t=0;r>t;t++)e+="   ";return e},a=new i;a.id=e.id,a.spineItemId=e.spineItemId,a.href=e.href,a.smilVersion=e.smilVersion,a.duration=e.duration,a.duration&&a.duration.length&&a.duration.length>0&&(console.error("SMIL duration is string, parsing float... ("+a.duration+")"),a.duration=parseFloat(a.duration)),a.mo=n,a.mo.DEBUG&&(console.log("JS MO smilVersion="+a.smilVersion),console.log("JS MO id="+a.id),console.log("JS MO spineItemId="+a.spineItemId),console.log("JS MO href="+a.href),console.log("JS MO duration="+a.duration));var s=function(e,t,i,n){e in t?(e in i||console.debug("property "+e+" not declared in smil node "+i.nodeType),i[e]=t[e],a.mo.DEBUG&&console.log(o()+"JS MO: ["+e+"="+i[e]+"]")):n&&console.log("Required property "+e+" not found in smil node "+t.nodeType)},l=function(e,i){var n;if("seq"==e.nodeType)a.mo.DEBUG&&console.log(o()+"JS MO seq"),n=new t.SeqNode(i),s("textref",e,n,i&&i.parent?!0:!1),s("id",e,n),s("epubtype",e,n),n.epubtype&&n.getSmil().addSync(n.epubtype),r++,d(e,n),r--;else if("par"==e.nodeType){a.mo.DEBUG&&console.log(o()+"JS MO par"),n=new t.ParNode(i),s("id",e,n),s("epubtype",e,n),n.epubtype&&n.getSmil().addSync(n.epubtype),r++,d(e,n),r--;for(var l=0,u=n.children.length;u>l;l++){var c=n.children[l];"text"==c.nodeType?n.text=c:"audio"==c.nodeType?n.audio=c:console.error("Unexpected smil node type: "+c.nodeType)}var f=!1;if(f||!n.audio){var h=new t.AudioNode(n);h.clipBegin=0,h.clipEnd=h.MAX,h.src=void 0,n.audio=h}}else if("text"==e.nodeType)a.mo.DEBUG&&console.log(o()+"JS MO text"),n=new t.TextNode(i),s("src",e,n,!0),s("srcFile",e,n,!0),s("srcFragmentId",e,n,!1),s("id",e,n),n.updateMediaManifestItemId();
else{if("audio"!=e.nodeType)return void console.error("Unexpected smil node type: "+e.nodeType);a.mo.DEBUG&&console.log(o()+"JS MO audio"),n=new t.AudioNode(i),s("src",e,n,!0),s("id",e,n),s("clipBegin",e,n),n.clipBegin&&n.clipBegin.length&&n.clipBegin.length>0&&(console.error("SMIL clipBegin is string, parsing float... ("+n.clipBegin+")"),n.clipBegin=parseFloat(n.clipBegin)),n.clipBegin<0&&(a.mo.DEBUG&&console.log(o()+"JS MO clipBegin adjusted to ZERO"),n.clipBegin=0),s("clipEnd",e,n),n.clipEnd&&n.clipEnd.length&&n.clipEnd.length>0&&(console.error("SMIL clipEnd is string, parsing float... ("+n.clipEnd+")"),n.clipEnd=parseFloat(n.clipEnd)),n.clipEnd<=n.clipBegin&&(a.mo.DEBUG&&console.log(o()+"JS MO clipEnd adjusted to MAX"),n.clipEnd=n.MAX)}return n},d=function(e,t){for(var i=e.children.length,n=0;i>n;n++){var r=l(e.children[n],t);r.index=n,t.children.push(r)}};return d(e,a),a},i}),define("readium_shared_js/models/media_overlay",["./smil_model"],function(e){var t=function(e){this["package"]=e,this.parallelAt=function(e){for(var t=0,i=0;i<this.smil_models.length;i++){var n=this.smil_models[i],r=e-t,o=n.parallelAt(r);if(o)return o;t+=n.durationMilliseconds_Calculated()}return void 0},this.percentToPosition=function(e,t,i,n){(0>e||e>100)&&(e=0);var r=this.durationMilliseconds_Calculated(),o=r*(e/100);if(i.par=this.parallelAt(o),i.par){var a=i.par.getSmil();if(a){for(var s=0,l=0;l<this.smil_models.length&&(t.smilData=this.smil_models[l],t.smilData!=a);l++)s+=t.smilData.durationMilliseconds_Calculated();n.milliseconds=o-(s+t.smilData.clipOffset(i.par))}}},this.durationMilliseconds_Calculated=function(){for(var e=0,t=0;t<this.smil_models.length;t++){var i=this.smil_models[t];e+=i.durationMilliseconds_Calculated()}return e},this.smilAt=function(e){return 0>e||e>=this.smil_models.length?void 0:this.smil_models[e]},this.positionToPercent=function(e,t,i){if(e>=this.smil_models.length)return-1;for(var n=0,r=0;e>r;r++){var o=this.smil_models[r];n+=o.durationMilliseconds_Calculated()}var a=this.smil_models[e],s=a.nthParallel(t);if(!s)return-1;var l=n+a.clipOffset(s)+i,d=this.durationMilliseconds_Calculated(),u=l/d*100;return u},this.smil_models=[],this.skippables=[],this.escapables=[],this.duration=void 0,this.narrator=void 0,this.activeClass=void 0,this.playbackActiveClass=void 0,this.DEBUG=!1,this.getSmilBySpineItem=function(e){if(!e)return void 0;for(var t=0,i=this.smil_models.length;i>t;t++){var n=this.smil_models[t];if(n.spineItemId===e.idref)return e.media_overlay_id!==n.id&&console.error("SMIL INCORRECT ID?? "+e.media_overlay_id+" /// "+n.id),n}return void 0},this.getNextSmil=function(e){var t=this.smil_models.indexOf(e);return-1==t||t==this.smil_models.length-1?void 0:this.smil_models[t+1]},this.getPreviousSmil=function(e){var t=this.smil_models.indexOf(e);return-1==t||0==t?void 0:this.smil_models[t-1]}};return t.fromDTO=function(i,n){var r=new t(n);if(!i)return console.debug("No Media Overlay."),r;console.debug("Media Overlay INIT..."),r.duration=i.duration,r.duration&&r.duration.length&&r.duration.length>0&&(console.error("SMIL total duration is string, parsing float... ("+r.duration+")"),r.duration=parseFloat(r.duration)),r.DEBUG&&console.debug("Media Overlay Duration (TOTAL): "+r.duration),r.narrator=i.narrator,r.DEBUG&&console.debug("Media Overlay Narrator: "+r.narrator),r.activeClass=i.activeClass,r.DEBUG&&console.debug("Media Overlay Active-Class: "+r.activeClass),r.playbackActiveClass=i.playbackActiveClass,r.DEBUG&&console.debug("Media Overlay Playback-Active-Class: "+r.playbackActiveClass);var o=i.smil_models.length;r.DEBUG&&console.debug("Media Overlay SMIL count: "+o);for(var a=0;o>a;a++){var s=e.fromSmilDTO(i.smil_models[a],r);r.smil_models.push(s),r.DEBUG&&console.debug("Media Overlay Duration (SPINE ITEM): "+s.duration)}o=i.skippables.length,r.DEBUG&&console.debug("Media Overlay SKIPPABLES count: "+o);for(var a=0;o>a;a++)r.skippables.push(i.skippables[a]);o=i.escapables.length,r.DEBUG&&console.debug("Media Overlay ESCAPABLES count: "+o);for(var a=0;o>a;a++)r.escapables.push(i.escapables[a]);return r},t}),define("readium_shared_js/models/package_data",[],function(){var e={rootUrl:"",rootUrlMO:"",rendering_layout:"",spine:{direction:"ltr",items:[{href:"",idref:"",page_spread:"",rendering_layout:""}]}};return e}),define("readium_shared_js/models/package",["../helpers","./spine_item","./spine","./media_overlay","./package_data"],function(e,t,i,n){var r=function(r){var o=this;this.spine=void 0,this.rootUrl=void 0,this.rootUrlMO=void 0,this.media_overlay=void 0,this.rendition_viewport=void 0,this.rendition_flow=void 0,this.rendition_layout=void 0,this.rendition_spread=void 0,this.rendition_orientation=void 0,this.resolveRelativeUrlMO=function(t){return o.rootUrlMO&&o.rootUrlMO.length>0?e.EndsWith(o.rootUrlMO,"/")?o.rootUrlMO+t:o.rootUrlMO+"/"+t:o.resolveRelativeUrl(t)},this.resolveRelativeUrl=function(t){return o.rootUrl?e.EndsWith(o.rootUrl,"/")?o.rootUrl+t:o.rootUrl+"/"+t:t},this.isFixedLayout=function(){return o.rendition_layout===t.RENDITION_LAYOUT_PREPAGINATED},this.isReflowable=function(){return!o.isFixedLayout()},r&&(this.rootUrl=r.rootUrl,this.rootUrlMO=r.rootUrlMO,this.rendition_viewport=r.rendition_viewport,this.rendition_layout=r.rendition_layout,this.rendition_flow=r.rendition_flow,this.rendition_orientation=r.rendition_orientation,this.rendition_spread=r.rendition_spread,this.spine=new i(this,r.spine),this.media_overlay=n.fromDTO(r.media_overlay,this))};return r}),define("readium_shared_js/views/reflowable_view",["jquery","underscore","eventEmitter","../models/bookmark_data","./cfi_navigation_logic","../models/current_pages_info","../helpers","../models/page_open_request","../globals","../models/viewer_settings"],function(e,t,i,n,r,o,a,s,l,d){var u=function(u,c){function f(e){R.css("left",e.left+"px"),R.css("top",e.top+"px"),R.css("right",e.right+"px"),R.css("bottom",e.bottom+"px")}function h(){R&&R.remove();var t=a.loadTemplate("reflowable_book_page_frame",{}),i=e(t);i=N.append(i),R=e("#reflowable-content-frame",i),A=e("#epubContentIframe",i),A.css("left",""),A.css("right",""),A.css("position","relative"),A.css("overflow","hidden"),D=new r(R,A,{rectangleBased:!0,paginationInfo:X})}function m(e){if(C!=e){h(),X.pageOffset=0,X.currentSpreadIndex=0,C=e,q=!0;var t=G["package"].resolveRelativeUrl(e.href);V.emit(l.Events.CONTENT_DOCUMENT_LOAD_START,A,e),A.css("opacity","0.01"),j.loadIframe(A[0],t,v,V,{spineItem:e})}}function p(){M&&a.UpdateHtmlFontSize(M,z)}function g(){M&&M.css("column-gap",X.columnGap+"px")}function v(t){if(q=!1,x&&x.spineItem!=C)return void m(x.spineItem);if(!t)return A.css("opacity","1"),void(x=void 0);V.emit(l.Events.CONTENT_DOCUMENT_LOADED,A,C);var i=A[0].contentDocument;M=e("html",i),L=e("body",M),k=!1,F=!0,U=void 0;var n=A[0].contentDocument.defaultView||A[0].contentWindow,r=n.getComputedStyle(L[0],null);if(r){F="ltr"===r.direction;var o=void 0;o=r.getPropertyValue?r.getPropertyValue("-webkit-writing-mode")||r.getPropertyValue("-moz-writing-mode")||r.getPropertyValue("-ms-writing-mode")||r.getPropertyValue("-o-writing-mode")||r.getPropertyValue("-epub-writing-mode")||r.getPropertyValue("writing-mode"):r.webkitWritingMode||r.mozWritingMode||r.msWritingMode||r.oWritingMode||r.epubWritingMode||r.writingMode,o&&(U=o.indexOf("-lr")>=0,(o.indexOf("vertical")>=0||o.indexOf("tb-")>=0||o.indexOf("bt-")>=0)&&(k=!0))}F&&("rtl"===L[0].getAttribute("dir")||"rtl"===M[0].getAttribute("dir"))&&(F=!1),G.isLeftToRight()||!F||k||(L[0].setAttribute("dir","rtl"),F=!1,U=!1),X.isVerticalWritingMode=k,P(),A.css("opacity","1"),E(),M.css("height",J.height+"px"),M.css("position","relative"),M.css("margin","0"),M.css("padding","0"),M.css("column-axis",k?"vertical":"horizontal"),V.applyBookStyles(),b(),p(),g(),V.applyStyles()}function I(){if(x){var e=x;x=void 0,V.openPage(e)}}function y(){var e=-X.pageOffset+"px";if(k)M.css("top",e);else{var t=F||U;M.css("left",t?e:""),M.css("right",t?"":e)}T()}function E(){var e=R.width(),t=R.height();return J.width!==e||J.height!==t?(J.width=e,J.height=t,!0):!1}function _(e,t,i){X.pageOffset=(X.columnWidth+X.columnGap)*X.visibleColumnCount*X.currentSpreadIndex,y(),V.emit(l.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:V.getPaginationInfo(),initiator:e,spineItem:t,elementId:i})}function S(){var e=550,t=400,i=a.deduceSyntheticSpread(B,C,$),n=i===!1||i===!0;if(0===i&&(i=1),X.visibleColumnCount=i?2:1,k&&(e*=2,i=!1,n=!0,X.visibleColumnCount=1),M){P();var r=parseInt(B.css("border-left-width")),o=parseInt(B.css("border-right-width")),s=X.columnGap/2;s=Math.max(0,s-r);var l=X.columnGap/2;l=Math.max(0,l-o);var d=0;if($.fontSize){var u=.8*$.fontSize/100;e=Math.floor(e*u),t=Math.floor(t*u)}var c=B.width(),f=c-r-o-s-l;i&&(f=.5*(f-X.columnGap)),f>e?d=Math.floor((f-e)*(i?1:.5)):!n&&t>f&&i&&(i=!1,X.visibleColumnCount=1,f=c-r-o-s-l,f>e&&(d=Math.floor(.5*(f-e)))),N.css({left:d+s+"px",right:d+l+"px"}),E(),A.css("width",J.width+"px"),A.css("height",J.height+"px"),M.css("height",J.height+"px"),M.css("min-height",J.height+"px"),M.css("max-height",J.height+"px"),M.css("margin",0),M.css("padding",0),M.css("border",0),L.css("margin",0),L.css("padding",0),X.rightToLeft=G.isRightToLeft(),X.columnWidth=Math.round(((k?J.height:J.width)-X.columnGap*(X.visibleColumnCount-1))/X.visibleColumnCount);var h=X.visibleColumnCount>1;h?(M.css("width",J.width+"px"),M.css("column-count",X.visibleColumnCount)):(M.css("width",(k?J.width:X.columnWidth)+"px"),M.css("column-width",X.columnWidth+"px")),M.css("column-fill","auto"),M.css({left:"0",right:"0",top:"0"}),a.triggerLayout(A),X.columnCount=((k?M[0].scrollHeight:M[0].scrollWidth)+X.columnGap)/(X.columnWidth+X.columnGap),X.columnCount=Math.round(X.columnCount);var m=(X.columnCount-1)*X.columnGap,p=((k?M[0].scrollHeight:M[0].scrollWidth)-m)/X.columnCount;p=Math.round(p),p>X.columnWidth&&(console.debug("ADJUST COLUMN"),console.log(X.columnWidth),console.log(p),X.columnWidth=p),X.spreadCount=Math.ceil(X.columnCount/X.visibleColumnCount),X.currentSpreadIndex>=X.spreadCount&&(X.currentSpreadIndex=X.spreadCount-1),x?I():_(V)}}function P(){-1==Y&&(Y=M.css("opacity"),M.css("opacity","0"))}function T(){-1!=Y&&M.css("opacity",Y),Y=-1}function w(){for(var e=[],t=X.currentSpreadIndex*X.visibleColumnCount,i=0;i<X.visibleColumnCount&&t+i<X.columnCount;i++)e.push(t+i);return e}function b(){if(M){var t;e("img, svg",M).each(function(){t=e(this),t.css("max-width","98%"),t.css("max-height","98%"),t.css("height")||t.css("height","auto"),t.css("width")||t.css("width","auto")})}}function O(){var e=Math.round(X.pageOffset/(X.columnWidth+X.columnGap)),t=e*R.height(),i=t+X.visibleColumnCount*R.height();return{top:t,bottom:i}}t.extend(this,new i);var C,x,R,D,N,A,M,L,k,F,U,V=this,B=u.$viewport,G=u.spine,W=u.userStyles,H=u.bookStyles,j=u.iframeLoader,q=!1,z=100,Y=-1,J={width:void 0,height:void 0},X={visibleColumnCount:2,columnGap:20,spreadCount:0,currentSpreadIndex:0,columnWidth:void 0,pageOffset:0,columnCount:0};this.render=function(){var t=a.loadTemplate("reflowable_book_frame",{});N=e(t),B.append(N);var i=c.viewerSettings();return i&&"undefined"!=typeof i.enableGPUHardwareAccelerationCSS3D||(i=new d({})),i.enableGPUHardwareAccelerationCSS3D&&N.css("transform","translateZ(0)"),h(),V},this.remove=function(){N.remove()},this.isReflowable=function(){return!0},this.onViewportResize=function(){E()&&S()};var $=void 0;this.setViewSettings=function(e){$=e,X.columnGap=e.columnGap,z=e.fontSize,p(),g(),E(),S()},this.applyStyles=function(){a.setStyles(W.getStyles(),N.parent());var e=a.Margins.fromElement(N);f(e.padding),E(),S()},this.applyBookStyles=function(){M&&a.setStyles(H.getStyles(),M)},this.openPage=function(e){if(q)return void(x=e);if(e.spineItem&&e.spineItem!=C)return x=e,void m(e.spineItem);var t=void 0;if(void 0!==e.spineItemPageIndex)t=e.spineItemPageIndex;else if(e.elementId)t=D.getPageForElementId(e.elementId);else if(e.elementCfi)try{t=D.getPageForElementCfi(e.elementCfi,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"])}catch(i){t=0,console.error(i)}else e.firstPage?t=0:e.lastPage?t=X.columnCount-1:(console.debug("No criteria in pageRequest"),t=0);t>=0&&t<X.columnCount?(X.currentSpreadIndex=Math.floor(t/X.visibleColumnCount),_(e.initiator,e.spineItem,e.elementId)):console.log("Illegal pageIndex value: ",t,"column count is ",X.columnCount)},this.openPagePrev=function(e){if(C)if(X.currentSpreadIndex>0)X.currentSpreadIndex--,_(e);else{var t=G.prevItem(C,!0);if(t){var i=new s(t,e);i.setLastPage(),V.openPage(i)}}},this.openPageNext=function(e){if(C)if(X.currentSpreadIndex<X.spreadCount-1)X.currentSpreadIndex++,_(e);else{var t=G.nextItem(C,!0);if(t){var i=new s(t,e);i.setFirstPage(),V.openPage(i)}}},this.getFirstVisibleElementCfi=function(){var e=O();return D.getFirstVisibleElementCfi(e)},this.getPaginationInfo=function(){var e=new o(G,!1);if(!C)return e;for(var t=w(),i=0,n=t.length;n>i;i++)e.addOpenPage(t[i],X.columnCount,C.idref,C.index);return e},this.bookmarkCurrentPage=function(){return C?new n(C.idref,V.getFirstVisibleElementCfi()):new n("","")},this.getLoadedSpineItems=function(){return[C]},this.getElementByCfi=function(e,t,i,n,r){return e!=C?void console.error("spine item is not loaded"):D.getElementByCfi(t,i,n,r)},this.getElementById=function(e,t){return e!=C?void console.error("spine item is not loaded"):D.getElementById(t)},this.getElement=function(e,t){return e!=C?void console.error("spine item is not loaded"):D.getElement(t)},this.getFirstVisibleMediaOverlayElement=function(){var e=O();return D.getFirstVisibleMediaOverlayElement(e)},this.insureElementVisibility=function(t,i,n){var r=e(i);if(!D.isElementVisible(r,O())){var o=D.getPageForElement(r);if(-1!=o){var a=new s(C,n);a.setPageIndex(o);var l=i.id;l||(l=i.getAttribute("id")),l&&a.setElementId(l),V.openPage(a)}}}};return u}),define("readium_shared_js/models/style",[],function(){var e=function(e,t){this.selector=e,this.declarations=t,this.setDeclarations=function(e){for(var t in e)e.hasOwnProperty(t)&&(this.declarations[t]=e[t])}};return e}),define("readium_shared_js/models/style_collection",["./style"],function(e){var t=function(){var t=[];this.clear=function(){t.length=0},this.findStyle=function(e){for(var i=t.length,n=0;i>n;n++)if(t[n].selector===e)return t[n];return void 0},this.addStyle=function(i,n){var r=this.findStyle(i);return r?r.setDeclarations(n):(r=new e(i,n),t.push(r)),r},this.removeStyle=function(e){for(var i=t.length,n=0;i>n;n++)if(t[n].selector===e)return void t.splice(n,1)},this.getStyles=function(){return t},this.resetStyleValues=function(){for(var e=t.length,i=0;e>i;i++){var n=t[i],r=n.declarations;for(var o in r)r.hasOwnProperty(o)&&(r[o]="")}}};return t}),define("readium_shared_js/models/switches",["jquery","underscore"],function(e,t){var i=function(){};return i.apply=function(i){function n(e){var i=e.attributes["required-namespace"];if(!i)return console.log("Encountered a case statement with no required-namespace"),!1;var n=["http://www.w3.org/1998/Math/MathML"];return t.include(n,i)}e("switch",i).each(function(){var t=!1;e("case",this).each(function(){!t&&n(this)?t=!0:e(this).remove()}),t&&e("default",this).remove()})},i}),define("readium_shared_js/models/trigger",["jquery","../helpers"],function(e,t){var i=function(t){var i=e(t);this.action=i.attr("action"),this.ref=i.attr("ref"),this.event=i.attr("ev:event"),this.observer=i.attr("ev:observer"),this.ref=i.attr("ref")};return i.register=function(t){e("trigger",t).each(function(){var e=new i(this);e.subscribe(t)})},i.prototype.subscribe=function(t){var i="#"+this.observer,n=this;e(i,t).on(this.event,function(){n.execute(t)})},i.prototype.execute=function(i){var n=e("#"+t.escapeJQuerySelector(this.ref),i);switch(this.action){case"show":n.css("visibility","visible");break;case"hide":n.css("visibility","hidden");break;case"play":n[0].currentTime=0,n[0].play();break;case"pause":n[0].pause();break;case"resume":n[0].play();break;case"mute":n[0].muted=!0;break;case"unmute":n[0].muted=!1;break;default:console.log("do not no how to handle trigger "+this.action)}},i}),define("readium_shared_js/views/reader_view",["jquery","underscore","eventEmitter","./fixed_view","../helpers","./iframe_loader","./internal_links_support","./media_overlay_data_injector","./media_overlay_player","../models/package","../models/page_open_request","./reflowable_view","./scroll_view","../models/style_collection","../models/switches","../models/trigger","../models/viewer_settings","../globals"],function(e,t,i,n,r,o,a,s,l,d,u,c,f,h,m,p,g,v){var I=function(y){function E(e){return"scroll-doc"==U.scroll?I.VIEW_TYPE_SCROLLED_DOC:"scroll-continuous"==U.scroll?I.VIEW_TYPE_SCROLLED_CONTINUOUS:e.isFixedLayout()?I.VIEW_TYPE_FIXED:e.isFlowScrolledDoc()?I.VIEW_TYPE_SCROLLED_DOC:e.isFlowScrolledContinuous()?I.VIEW_TYPE_SCROLLED_CONTINUOUS:I.VIEW_TYPE_COLUMNIZED}function _(e,t){var i=E(e);if(L){if(M.getCurrentViewType()==i)return void t(!1);S()}var n={$viewport:A,spine:F,userStyles:V,bookStyles:B,iframeLoader:N};L=M.createViewForType(i,n),M.emit(v.Events.READER_VIEW_CREATED,i),L.on(v.Events.CONTENT_DOCUMENT_LOADED,function(e,t){if(r.isIframeAlive(e[0])){D.attachMediaOverlayData(e,t,U),G.processLinkElements(e,t);var i=e[0].contentDocument;p.register(i),m.apply(i),M.emit(v.Events.CONTENT_DOCUMENT_LOADED,e,t)}}),L.on(v.Events.CONTENT_DOCUMENT_LOAD_START,function(e,t){M.emit(v.Events.CONTENT_DOCUMENT_LOAD_START,e,t)}),L.on(v.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,function(e){R.onPageChanged(e),M.emit(v.Events.PAGINATION_CHANGED,e)}),L.on(v.Events.FXL_VIEW_RESIZED,function(){M.emit(v.Events.FXL_VIEW_RESIZED)}),L.render(),L.setViewSettings(U),setTimeout(function(){t(!0)},50)}function S(){L&&(M.emit(v.Events.READER_VIEW_DESTROYED),L.off(v.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED),L.remove(),L=void 0)}function P(e){M.emit(v.Events.MEDIA_OVERLAY_STATUS_CHANGED,e)}function T(e){if(!e)return void console.log("idref parameter value missing!");var t=F.getItemById(e);return t?t:void console.log("Spine item with id "+e+" not found!")}function w(e,t){_(e.spineItem,function(i){i||L.setViewSettings(U),L.openPage(e,t)})}function b(e){r.setStyles(V.getStyles(),A),R&&R.applyStyles(),e||L&&L.applyStyles()}function O(){H=null,j=!1,L&&(L.isReflowable&&L.isReflowable()&&(j=M.isPlayingMediaOverlay(),j&&M.pauseMediaOverlay()),H=L.bookmarkCurrentPage())}function C(){L&&M.handleViewportResize(H)}function x(){C(),j&&M.playMediaOverlay()}t.extend(this,new i);var R,D,N,A,M=this,L=void 0,k=void 0,F=void 0,U=new g({}),V=new h,B=new h,G=new a(this),W=r.extendedThrottle(O,C,x,250,1e3,M);e(window).on("resize.ReadiumSDK.readerView",W),y.el instanceof e?(A=y.el,console.log("** EL is a jQuery selector:"+y.el.attr("id"))):(A=e(y.el),console.log("** EL is a string:"+A.attr("id"))),N=y.iframeLoader?y.iframeLoader:new o({mathJaxUrl:y.mathJaxUrl}),_needsFixedLayoutScalerWorkAround=y.needsFixedLayoutScalerWorkAround,this.needsFixedLayoutScalerWorkAround=function(){return _needsFixedLayoutScalerWorkAround},this.createViewForType=function(e,t){var i;switch(A.css("overflow","hidden"),e){case I.VIEW_TYPE_FIXED:A.css("overflow","auto"),i=new n(t,M);break;case I.VIEW_TYPE_SCROLLED_DOC:i=new f(t,!1,M);break;case I.VIEW_TYPE_SCROLLED_CONTINUOUS:i=new f(t,!0,M);break;default:i=new c(t,M)}return i},this.getCurrentViewType=function(){return L?L instanceof c?I.VIEW_TYPE_COLUMNIZED:L instanceof n?I.VIEW_TYPE_FIXED:L instanceof f?L.isContinuousScroll()?I.VIEW_TYPE_SCROLLED_CONTINUOUS:I.VIEW_TYPE_SCROLLED_DOC:void console.error("Unrecognized view type"):void 0},this.getLoadedSpineItems=function(){return L?L.getLoadedSpineItems():[]},this.viewerSettings=function(){return U},this["package"]=function(){return k},this.spine=function(){return F},this.userStyles=function(){return V},this.openBook=function(t){var i=t["package"]?t["package"]:t;k=new d(i),F=k.spine,F.handleLinear(!0),R&&R.reset(),R=new l(M,e.proxy(P,M)),R.setAutomaticNextSmil(U.mediaOverlaysAutomaticPageTurn?!0:!1),D=new s(k.media_overlay,R),S(),t.settings&&M.updateSettings(t.settings),t.styles&&M.setStyles(t.styles);var n=void 0;t.openPageRequest&&(t.openPageRequest.idref||t.openPageRequest.contentRefUrl&&t.openPageRequest.sourceFileHref?n=t.openPageRequest:console.log("Invalid page request data: idref required!"));var r=!1;if(n){n=t.openPageRequest;try{r=n.idref?n.spineItemPageIndex?!M.openSpineItemPage(n.idref,n.spineItemPageIndex,M):n.elementCfi?!M.openSpineItemElementCfi(n.idref,n.elementCfi,M):!M.openSpineItemPage(n.idref,0,M):!M.openContentUrl(n.contentRefUrl,n.sourceFileHref,M)}catch(o){console.error("openPageRequest fail: fallback to first page!"),console.log(o),r=!0}}else r=!0;if(r){var a=F.first();if(a){var c=new u(a,M);c.setFirstPage(),w(c,0)}}},this.openPageLeft=function(){k.spine.isLeftToRight()?M.openPagePrev():M.openPageNext()},this.openPageRight=function(){k.spine.isLeftToRight()?M.openPageNext():M.openPagePrev()},this.isCurrentViewFixedLayout=function(){return L instanceof n},this.setZoom=function(e){M.isCurrentViewFixedLayout()&&L.setZoom(e)},this.getViewScale=function(){return M.isCurrentViewFixedLayout()?100*L.getViewScale():100},this.updateSettings=function(e){if(U.update(e),R&&R.setAutomaticNextSmil(U.mediaOverlaysAutomaticPageTurn?!0:!1),L&&!e.doNotUpdateView){var t=L.bookmarkCurrentPage();if(t&&t.idref){var i=!1;L.isReflowable&&L.isReflowable()&&(i=M.isPlayingMediaOverlay(),i&&M.pauseMediaOverlay());var n=F.getItemById(t.idref);_(n,function(e){e||L.setViewSettings(U),M.openSpineItemElementCfi(t.idref,t.contentCFI,M),i&&M.playMediaOverlay(),M.emit(v.Events.SETTINGS_APPLIED)})}}M.emit(v.Events.SETTINGS_APPLIED)},this.openPageNext=function(){if(M.getCurrentViewType()===I.VIEW_TYPE_SCROLLED_CONTINUOUS)return void L.openPageNext(M);var e=L.getPaginationInfo();if(0!=e.openPages.length){var t=e.openPages[e.openPages.length-1];if(t.spineItemPageIndex<t.spineItemPageCount-1)return void L.openPageNext(M);var i=F.getItemById(t.idref),n=F.nextItem(i);if(n){var r=new u(n,M);r.setFirstPage(),w(r,2)}}},this.openPagePrev=function(){if(M.getCurrentViewType()===I.VIEW_TYPE_SCROLLED_CONTINUOUS)return void L.openPagePrev(M);var e=L.getPaginationInfo();if(0!=e.openPages.length){var t=e.openPages[0];if(t.spineItemPageIndex>0)return void L.openPagePrev(M);var i=F.getItemById(t.idref),n=F.prevItem(i);if(n){var r=new u(n,M);r.setLastPage(),w(r,1)}}},this.openSpineItemElementCfi=function(e,t,i){var n=T(e);if(!n)return!1;var r=new u(n,i);return t&&r.setElementCfi(t),w(r,0),!0},this.openPageIndex=function(e,t){if(!L)return!1;var i;if(k.isFixedLayout()){var n=F.items[e];if(!n)return!1;i=new u(n,t),i.setPageIndex(0)}else{var r=this.getLoadedSpineItems();r.length>0&&(i=new u(r[0],t),i.setPageIndex(e))}return w(i,0),!0},this.openSpineItemPage=function(e,t,i){var n=T(e);if(!n)return!1;var r=new u(n,i);return t&&r.setPageIndex(t),w(r,0),!0},this.setStyles=function(e,t){for(var i=e.length,n=0;i>n;n++)e[n].declarations?V.addStyle(e[n].selector,e[n].declarations):V.removeStyle(e[n].selector);b(t)},this.setBookStyles=function(e){for(var t=e.length,i=0;t>i;i++)B.addStyle(e[i].selector,e[i].declarations);L&&L.applyBookStyles()},this.getElement=function(e,t){return L?L.getElement(e,t):void 0},this.getElementById=function(e,t){return L?L.getElementById(e,t):void 0},this.getElementByCfi=function(e,t,i,n,r){return L?L.getElementByCfi(e,t,i,n,r):void 0},this.mediaOverlaysOpenContentUrl=function(e,t,i){R.mediaOverlaysOpenContentUrl(e,t,i)},this.openContentUrl=function(e,t,i){var n,o,a=r.ResolveContentRef(e,t),s=a.indexOf("#");s>=0?(n=a.substr(0,s),o=a.substr(s+1)):(n=a,o=void 0);var l=F.getItemByHref(n);if(!l){console.warn("spineItem "+n+" not found");var d=decodeURIComponent(n);if(l=F.getItemByHref(d),!l)return console.warn("decoded spineItem "+d+" missing as well"),!1}return M.openSpineItemElementId(l.idref,o,i)},this.openSpineItemElementId=function(e,t,i){var n=F.getItemById(e);if(!n)return!1;var r=new u(n,i);return t&&r.setElementId(t),w(r,0),!0},this.bookmarkCurrentPage=function(){return JSON.stringify(L.bookmarkCurrentPage())},this.clearStyles=function(){V.resetStyleValues(),b(),V.clear()},this.clearBookStyles=function(){L&&(B.resetStyleValues(),L.applyBookStyles()),B.clear()},this.isMediaOverlayAvailable=function(){return R?R.isMediaOverlayAvailable():!1},this.toggleMediaOverlay=function(){R.toggleMediaOverlay()},this.nextMediaOverlay=function(){R.nextMediaOverlay()},this.previousMediaOverlay=function(){R.previousMediaOverlay()},this.escapeMediaOverlay=function(){R.escape()},this.ttsEndedMediaOverlay=function(){R.onTTSEnd()},this.pauseMediaOverlay=function(){R.pause()},this.playMediaOverlay=function(){R.play()},this.isPlayingMediaOverlay=function(){return R.isPlaying()},this.getFirstVisibleMediaOverlayElement=function(){return L?L.getFirstVisibleMediaOverlayElement():void 0},this.insureElementVisibility=function(e,t,i){L&&L.insureElementVisibility(e,t,i)};var H=null,j=!1;this.handleViewportResize=function(e){if(L){var t=e||L.bookmarkCurrentPage();if(L.isReflowable&&L.isReflowable()&&t&&t.idref){var i=F.getItemById(t.idref);_(i,function(){M.openSpineItemElementCfi(t.idref,t.contentCFI,M)})}else L.onViewportResize()}},this.addIFrameEventListener=function(e,t,i){N.addIFrameEventListener(e,t,i)};var q=function(){var t={},i=!1,n=void 0;this.setCallback_PlayPause=function(e){n=e};var r=void 0;this.setCallback_IsAvailable=function(e){r=e},this.playPause=function(e){o(e)};var o=function(i){n&&n(i);try{var r=void 0;for(var o in t)if(t.hasOwnProperty(o)){var a=t[o];if(a&&a.active&&(r&&console.error("More than one active iframe?? (pagination)"),r=a.$iframe)){var s=e("audio",r[0].contentDocument);e.each(s,function(){var e=this.getAttribute("epub:type")||this.getAttribute("type");return e?e.indexOf("ibooks:soundtrack")<0&&e.indexOf("media:soundtrack")<0&&e.indexOf("media:background")<0?!0:(i&&this.play?this.play():this.pause&&this.pause(),!0):!0})}}}catch(l){console.error(l)}};this.setPlayState=function(e){i=e},M.on(v.Events.CONTENT_DOCUMENT_LOADED,function(e,i){try{i&&i.idref&&e&&e[0]&&(t[i.idref]={$iframe:e,href:i.href})}catch(n){console.error(n)}}),M.on(v.Events.PAGINATION_CHANGED,function(n){var a=!1;try{for(var s in t)if(t.hasOwnProperty(s)){var l=n.spineItem&&n.spineItem.idref===s,d=!1;if(n.paginationInfo&&n.paginationInfo.openPages.length){for(var u=!0,c=0;c<n.paginationInfo.openPages.length;c++)n.paginationInfo.openPages[c].idref===s?d=!0:u=!1;!l&&u&&(l=!0)}if(l||d){var f=t[s];if(!f)continue;t[s].active=l;var h=f.$iframe,m=(f.href,e("audio",h[0].contentDocument));e.each(m,function(){var e=this.getAttribute("epub:type")||this.getAttribute("type");return e?e.indexOf("ibooks:soundtrack")<0&&e.indexOf("media:soundtrack")<0&&e.indexOf("media:background")<0?!0:(this.setAttribute("loop","loop"),this.removeAttribute("autoplay"),l||this.pause&&this.pause(),a=!0,!0):!0})}else t[s]&&(t[s].$iframe=void 0),t[s]=void 0}}catch(p){console.error(p)}r&&r(a),o(a?i?!0:!1:!1)}),M.on(v.Events.MEDIA_OVERLAY_STATUS_CHANGED,function(e){if(e.smilIndex){var n=M["package"](),r=n.media_overlay.smilAt(e.smilIndex);if(r&&r.spineItemId){var a=!1;for(var s in t)if(t.hasOwnProperty(s)){var l=t[s];l&&l.active&&s!==r.spineItemId&&(o(!1),l.active=!1,a=!0)}if(a){for(var s in t)if(t.hasOwnProperty(s)){var l=t[s];l&&(l.active||s===r.spineItemId&&(l.active=!0))}i&&o(!0)}}}})};this.backgroundAudioTrackManager=new q};return I.VIEW_TYPE_COLUMNIZED=1,I.VIEW_TYPE_FIXED=2,I.VIEW_TYPE_SCROLLED_DOC=3,I.VIEW_TYPE_SCROLLED_CONTINUOUS=4,I}),define("readium-shared-js",function(){}),require(["readium_shared_js/globalsSetup"]);
//# sourceMappingURL=readium-shared-js.js.map