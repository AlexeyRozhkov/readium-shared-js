!function(t){var e="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;if("function"==typeof define&&define.amd)define("backbone",["underscore","jquery","exports"],function(i,n,r){e.Backbone=t(e,r,i,n)});else if("undefined"!=typeof exports){var i,n=require("underscore");try{i=require("jquery")}catch(r){}t(e,exports,n,i)}else e.Backbone=t(e,{},e._,e.jQuery||e.Zepto||e.ender||e.$)}(function(t,e,i,n){var r=t.Backbone,s=[],o=s.slice;e.VERSION="1.2.0",e.$=n,e.noConflict=function(){return t.Backbone=r,this},e.emulateHTTP=!1,e.emulateJSON=!1;var a=e.Events={},h=/\s+/,l=function(t,e,n,r,s){var o,a=0;if(n&&"object"==typeof n)for(o=i.keys(n);a<o.length;a++)e=t(e,o[a],n[o[a]],s);else if(n&&h.test(n))for(o=n.split(h);a<o.length;a++)e=t(e,o[a],r,s);else e=t(e,n,r,s);return e};a.on=function(t,e,i){return u(this,t,e,i)};var u=function(t,e,i,n,r){if(t._events=l(c,t._events||{},e,i,{context:n,ctx:t,listening:r}),r){var s=t._listeners||(t._listeners={});s[r.id]=r}return t};a.listenTo=function(t,e,n){if(!t)return this;var r=t._listenId||(t._listenId=i.uniqueId("l")),s=this._listeningTo||(this._listeningTo={}),o=s[r];if(!o){var a=this._listenId||(this._listenId=i.uniqueId("l"));o=s[r]={obj:t,objId:r,id:a,listeningTo:s,count:0}}return u(t,e,n,this,o),this};var c=function(t,e,i,n){if(i){var r=t[e]||(t[e]=[]),s=n.context,o=n.ctx,a=n.listening;a&&a.count++,r.push({callback:i,context:s,ctx:s||o,listening:a})}return t};a.off=function(t,e,i){return this._events?(this._events=l(d,this._events,t,e,{context:i,listeners:this._listeners}),this):this},a.stopListening=function(t,e,n){var r=this._listeningTo;if(!r)return this;for(var s=t?[t._listenId]:i.keys(r),o=0;o<s.length;o++){var a=r[s[o]];if(!a)break;a.obj.off(e,n,this)}return i.isEmpty(r)&&(this._listeningTo=void 0),this};var d=function(t,e,n,r){if(t){var s,o=0,a=r.context,h=r.listeners;if(e||n||a){for(var l=e?[e]:i.keys(t);o<l.length;o++){e=l[o];var u=t[e];if(!u)break;for(var c=[],d=0;d<u.length;d++){var g=u[d];n&&n!==g.callback&&n!==g.callback._callback||a&&a!==g.context?c.push(g):(s=g.listening,s&&0===--s.count&&(delete h[s.id],delete s.listeningTo[s.objId]))}c.length?t[e]=c:delete t[e]}return i.size(t)?t:void 0}for(var f=i.keys(h);o<f.length;o++)s=h[f[o]],delete h[s.id],delete s.listeningTo[s.objId]}};a.once=function(t,e,n){var r=l(g,{},t,e,i.bind(this.off,this));return this.on(r,void 0,n)},a.listenToOnce=function(t,e,n){var r=l(g,{},e,n,i.bind(this.stopListening,this,t));return this.listenTo(t,r)};var g=function(t,e,n,r){if(n){var s=t[e]=i.once(function(){r(e,s),n.apply(this,arguments)});s._callback=n}return t};a.trigger=function(t){if(!this._events)return this;for(var e=Math.max(0,arguments.length-1),i=Array(e),n=0;e>n;n++)i[n]=arguments[n+1];return l(f,this._events,t,void 0,i),this};var f=function(t,e,i,n){if(t){var r=t[e],s=t.all;r&&s&&(s=s.slice()),r&&m(r,n),s&&m(s,[e].concat(n))}return t},m=function(t,e){var i,n=-1,r=t.length,s=e[0],o=e[1],a=e[2];switch(e.length){case 0:for(;++n<r;)(i=t[n]).callback.call(i.ctx);return;case 1:for(;++n<r;)(i=t[n]).callback.call(i.ctx,s);return;case 2:for(;++n<r;)(i=t[n]).callback.call(i.ctx,s,o);return;case 3:for(;++n<r;)(i=t[n]).callback.call(i.ctx,s,o,a);return;default:for(;++n<r;)(i=t[n]).callback.apply(i.ctx,e);return}},p=function(t,e,n){switch(t){case 1:return function(){return i[e](this[n])};case 2:return function(t){return i[e](this[n],t)};case 3:return function(t,r){return i[e](this[n],t,r)};case 4:return function(t,r,s){return i[e](this[n],t,r,s)};default:return function(){var t=o.call(arguments);return t.unshift(this[n]),i[e].apply(i,t)}}},v=function(t,e,n){i.each(e,function(e,r){i[r]&&(t.prototype[r]=p(e,r,n))})};a.bind=a.on,a.unbind=a.off,i.extend(e,a);var b=e.Model=function(t,e){var n=t||{};e||(e={}),this.cid=i.uniqueId(this.cidPrefix),this.attributes={},e.collection&&(this.collection=e.collection),e.parse&&(n=this.parse(n,e)||{}),n=i.defaults({},n,i.result(this,"defaults")),this.set(n,e),this.changed={},this.initialize.apply(this,arguments)};i.extend(b.prototype,a,{changed:null,validationError:null,idAttribute:"id",cidPrefix:"c",initialize:function(){},toJSON:function(){return i.clone(this.attributes)},sync:function(){return e.sync.apply(this,arguments)},get:function(t){return this.attributes[t]},escape:function(t){return i.escape(this.get(t))},has:function(t){return null!=this.get(t)},matches:function(t){return!!i.iteratee(t,this)(this.attributes)},set:function(t,e,n){var r,s,o,a,h,l,u,c;if(null==t)return this;if("object"==typeof t?(s=t,n=e):(s={})[t]=e,n||(n={}),!this._validate(s,n))return!1;o=n.unset,h=n.silent,a=[],l=this._changing,this._changing=!0,l||(this._previousAttributes=i.clone(this.attributes),this.changed={}),c=this.attributes,u=this._previousAttributes,this.idAttribute in s&&(this.id=s[this.idAttribute]);for(r in s)e=s[r],i.isEqual(c[r],e)||a.push(r),i.isEqual(u[r],e)?delete this.changed[r]:this.changed[r]=e,o?delete c[r]:c[r]=e;if(!h){a.length&&(this._pending=n);for(var d=0;d<a.length;d++)this.trigger("change:"+a[d],this,c[a[d]],n)}if(l)return this;if(!h)for(;this._pending;)n=this._pending,this._pending=!1,this.trigger("change",this,n);return this._pending=!1,this._changing=!1,this},unset:function(t,e){return this.set(t,void 0,i.extend({},e,{unset:!0}))},clear:function(t){var e={};for(var n in this.attributes)e[n]=void 0;return this.set(e,i.extend({},t,{unset:!0}))},hasChanged:function(t){return null==t?!i.isEmpty(this.changed):i.has(this.changed,t)},changedAttributes:function(t){if(!t)return this.hasChanged()?i.clone(this.changed):!1;var e,n=!1,r=this._changing?this._previousAttributes:this.attributes;for(var s in t)i.isEqual(r[s],e=t[s])||((n||(n={}))[s]=e);return n},previous:function(t){return null!=t&&this._previousAttributes?this._previousAttributes[t]:null},previousAttributes:function(){return i.clone(this._previousAttributes)},fetch:function(t){t=t?i.clone(t):{},void 0===t.parse&&(t.parse=!0);var e=this,n=t.success;return t.success=function(i){return e.set(e.parse(i,t),t)?(n&&n.call(t.context,e,i,t),void e.trigger("sync",e,i,t)):!1},U(this,t),this.sync("read",this,t)},save:function(t,e,n){var r,s,o,a,h=this.attributes;if(null==t||"object"==typeof t?(r=t,n=e):(r={})[t]=e,n=i.extend({validate:!0},n),a=n.wait,r&&!a){if(!this.set(r,n))return!1}else if(!this._validate(r,n))return!1;r&&a&&(this.attributes=i.extend({},h,r)),void 0===n.parse&&(n.parse=!0);var l=this,u=n.success;return n.success=function(t){l.attributes=h;var e=n.parse?l.parse(t,n):t;return a&&(e=i.extend(r||{},e)),i.isObject(e)&&!l.set(e,n)?!1:(u&&u.call(n.context,l,t,n),void l.trigger("sync",l,t,n))},U(this,n),s=this.isNew()?"create":n.patch?"patch":"update","patch"!==s||n.attrs||(n.attrs=r),o=this.sync(s,this,n),r&&a&&(this.attributes=h),o},destroy:function(t){t=t?i.clone(t):{};var e=this,n=t.success,r=t.wait,s=function(){e.stopListening(),e.trigger("destroy",e,e.collection,t)};t.success=function(i){r&&s(),n&&n.call(t.context,e,i,t),e.isNew()||e.trigger("sync",e,i,t)};var o=!1;return this.isNew()?i.defer(t.success):(U(this,t),o=this.sync("delete",this,t)),r||s(),o},url:function(){var t=i.result(this,"urlRoot")||i.result(this.collection,"url")||O();if(this.isNew())return t;var e=this.id||this.attributes[this.idAttribute];return t.replace(/([^\/])$/,"$1/")+encodeURIComponent(e)},parse:function(t){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(t){return this._validate({},i.extend(t||{},{validate:!0}))},_validate:function(t,e){if(!e.validate||!this.validate)return!0;t=i.extend({},this.attributes,t);var n=this.validationError=this.validate(t,e)||null;return n?(this.trigger("invalid",this,n,i.extend(e,{validationError:n})),!1):!0}});var k={keys:1,values:1,pairs:1,invert:1,pick:0,omit:0,chain:1,isEmpty:1};v(b,k,"attributes");var C=e.Collection=function(t,e){e||(e={}),e.model&&(this.model=e.model),void 0!==e.comparator&&(this.comparator=e.comparator),this._reset(),this.initialize.apply(this,arguments),t&&this.reset(t,i.extend({silent:!0},e))},w={add:!0,remove:!0,merge:!0},_={add:!0,remove:!1};i.extend(C.prototype,a,{model:b,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return e.sync.apply(this,arguments)},add:function(t,e){return this.set(t,i.extend({merge:!1},e,_))},remove:function(t,e){var n,r=!i.isArray(t);return t=r?[t]:i.clone(t),e||(e={}),n=this._removeModels(t,e),!e.silent&&n&&this.trigger("update",this,e),r?t[0]:t},set:function(t,e){e=i.defaults({},e,w),e.parse&&(t=this.parse(t,e));var n=!i.isArray(t);t=n?t?[t]:[]:t.slice();var r,s,o,a,h,l=e.at;null!=l&&(l=+l),0>l&&(l+=this.length+1);for(var u=this.comparator&&null==l&&e.sort!==!1,c=i.isString(this.comparator)?this.comparator:null,d=[],g=[],f={},m=e.add,p=e.merge,v=e.remove,b=!u&&m&&v?[]:!1,k=!1,C=0;C<t.length;C++){if(o=t[C],a=this.get(o))v&&(f[a.cid]=!0),p&&o!==a&&(o=this._isModel(o)?o.attributes:o,e.parse&&(o=a.parse(o,e)),a.set(o,e),u&&!h&&a.hasChanged(c)&&(h=!0)),t[C]=a;else if(m){if(s=t[C]=this._prepareModel(o,e),!s)continue;d.push(s),this._addReference(s,e)}s=a||s,s&&(r=this.modelId(s.attributes),!b||!s.isNew()&&f[r]||(b.push(s),k=k||!this.models[C]||s.cid!==this.models[C].cid),f[r]=!0)}if(v){for(var C=0;C<this.length;C++)f[(s=this.models[C]).cid]||g.push(s);g.length&&this._removeModels(g,e)}if(d.length||k)if(u&&(h=!0),this.length+=d.length,null!=l)for(var C=0;C<d.length;C++)this.models.splice(l+C,0,d[C]);else{b&&(this.models.length=0);for(var _=b||d,C=0;C<_.length;C++)this.models.push(_[C])}if(h&&this.sort({silent:!0}),!e.silent){for(var y=null!=l?i.clone(e):e,C=0;C<d.length;C++)null!=l&&(y.index=l+C),(s=d[C]).trigger("add",s,this,y);(h||k)&&this.trigger("sort",this,e),(d.length||g.length)&&this.trigger("update",this,e)}return n?t[0]:t},reset:function(t,e){e=e?i.clone(e):{};for(var n=0;n<this.models.length;n++)this._removeReference(this.models[n],e);return e.previousModels=this.models,this._reset(),t=this.add(t,i.extend({silent:!0},e)),e.silent||this.trigger("reset",this,e),t},push:function(t,e){return this.add(t,i.extend({at:this.length},e))},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t),e},unshift:function(t,e){return this.add(t,i.extend({at:0},e))},shift:function(t){var e=this.at(0);return this.remove(e,t),e},slice:function(){return o.apply(this.models,arguments)},get:function(t){if(null==t)return void 0;var e=this.modelId(this._isModel(t)?t.attributes:t);return this._byId[t]||this._byId[e]||this._byId[t.cid]},at:function(t){return 0>t&&(t+=this.length),this.models[t]},where:function(t,e){var n=i.matches(t);return this[e?"find":"filter"](function(t){return n(t.attributes)})},findWhere:function(t){return this.where(t,!0)},sort:function(t){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return t||(t={}),i.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(i.bind(this.comparator,this)),t.silent||this.trigger("sort",this,t),this},pluck:function(t){return i.invoke(this.models,"get",t)},fetch:function(t){t=t?i.clone(t):{},void 0===t.parse&&(t.parse=!0);var e=t.success,n=this;return t.success=function(i){var r=t.reset?"reset":"set";n[r](i,t),e&&e.call(t.context,n,i,t),n.trigger("sync",n,i,t)},U(this,t),this.sync("read",this,t)},create:function(t,e){e=e?i.clone(e):{};var n=e.wait;if(!(t=this._prepareModel(t,e)))return!1;n||this.add(t,e);var r=this,s=e.success;return e.success=function(t,e,i){n&&r.add(t,i),s&&s.call(i.context,t,e,i)},t.save(null,e),t},parse:function(t){return t},clone:function(){return new this.constructor(this.models,{model:this.model,comparator:this.comparator})},modelId:function(t){return t[this.model.prototype.idAttribute||"id"]},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(t,e){if(this._isModel(t))return t.collection||(t.collection=this),t;e=e?i.clone(e):{},e.collection=this;var n=new this.model(t,e);return n.validationError?(this.trigger("invalid",this,n.validationError,e),!1):n},_removeModels:function(t,e){for(var i,n,r,s=!1,i=0,o=0;i<t.length;i++){var r=t[i]=this.get(t[i]);if(r){var a=this.modelId(r.attributes);null!=a&&delete this._byId[a],delete this._byId[r.cid];var n=this.indexOf(r);this.models.splice(n,1),this.length--,e.silent||(e.index=n,r.trigger("remove",r,this,e)),t[o++]=r,this._removeReference(r,e),s=!0}}return t.length!==o&&(t=t.slice(0,o)),s},_isModel:function(t){return t instanceof b},_addReference:function(t){this._byId[t.cid]=t;var e=this.modelId(t.attributes);null!=e&&(this._byId[e]=t),t.on("all",this._onModelEvent,this)},_removeReference:function(t){this===t.collection&&delete t.collection,t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,i,n){if("add"!==t&&"remove"!==t||i===this){if("destroy"===t&&this.remove(e,n),"change"===t){var r=this.modelId(e.previousAttributes()),s=this.modelId(e.attributes);r!==s&&(null!=r&&delete this._byId[r],null!=s&&(this._byId[s]=e))}this.trigger.apply(this,arguments)}}});var y={forEach:3,each:3,map:3,collect:3,reduce:4,foldl:4,inject:4,reduceRight:4,foldr:4,find:3,detect:3,filter:3,select:3,reject:3,every:3,all:3,some:3,any:3,include:2,contains:2,invoke:2,max:3,min:3,toArray:1,size:1,first:3,head:3,take:3,initial:3,rest:3,tail:3,drop:3,last:3,without:0,difference:0,indexOf:3,shuffle:1,lastIndexOf:3,isEmpty:1,chain:1,sample:3,partition:3};v(C,y,"models");var S=["groupBy","countBy","sortBy","indexBy"];i.each(S,function(t){i[t]&&(C.prototype[t]=function(e,n){var r=i.isFunction(e)?e:function(t){return t.get(e)};return i[t](this.models,r,n)})});var x=e.View=function(t){this.cid=i.uniqueId("view"),t||(t={}),i.extend(this,i.pick(t,E)),this._ensureElement(),this.initialize.apply(this,arguments)},I=/^(\S+)\s*(.*)$/,E=["model","collection","el","id","attributes","className","tagName","events"];i.extend(x.prototype,a,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){return this._removeElement(),this.stopListening(),this},_removeElement:function(){this.$el.remove()},setElement:function(t){return this.undelegateEvents(),this._setElement(t),this.delegateEvents(),this},_setElement:function(t){this.$el=t instanceof e.$?t:e.$(t),this.el=this.$el[0]},delegateEvents:function(t){if(!t&&!(t=i.result(this,"events")))return this;this.undelegateEvents();for(var e in t){var n=t[e];if(i.isFunction(n)||(n=this[t[e]]),n){var r=e.match(I);this.delegate(r[1],r[2],i.bind(n,this))}}return this},delegate:function(t,e,i){this.$el.on(t+".delegateEvents"+this.cid,e,i)},undelegateEvents:function(){return this.$el&&this.$el.off(".delegateEvents"+this.cid),this},undelegate:function(t,e,i){this.$el.off(t+".delegateEvents"+this.cid,e,i)},_createElement:function(t){return document.createElement(t)},_ensureElement:function(){if(this.el)this.setElement(i.result(this,"el"));else{var t=i.extend({},i.result(this,"attributes"));this.id&&(t.id=i.result(this,"id")),this.className&&(t["class"]=i.result(this,"className")),this.setElement(this._createElement(i.result(this,"tagName"))),this._setAttributes(t)}},_setAttributes:function(t){this.$el.attr(t)}}),e.sync=function(t,n,r){var s=H[t];i.defaults(r||(r={}),{emulateHTTP:e.emulateHTTP,emulateJSON:e.emulateJSON});var o={type:s,dataType:"json"};if(r.url||(o.url=i.result(n,"url")||O()),null!=r.data||!n||"create"!==t&&"update"!==t&&"patch"!==t||(o.contentType="application/json",o.data=JSON.stringify(r.attrs||n.toJSON(r))),r.emulateJSON&&(o.contentType="application/x-www-form-urlencoded",o.data=o.data?{model:o.data}:{}),r.emulateHTTP&&("PUT"===s||"DELETE"===s||"PATCH"===s)){o.type="POST",r.emulateJSON&&(o.data._method=s);var a=r.beforeSend;r.beforeSend=function(t){return t.setRequestHeader("X-HTTP-Method-Override",s),a?a.apply(this,arguments):void 0}}"GET"===o.type||r.emulateJSON||(o.processData=!1);var h=r.error;r.error=function(t,e,i){r.textStatus=e,r.errorThrown=i,h&&h.call(r.context,t,e,i)};var l=r.xhr=e.ajax(i.extend(o,r));return n.trigger("request",n,l,r),l};var H={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};e.ajax=function(){return e.$.ajax.apply(e.$,arguments)};var A=e.Router=function(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},T=/\((.*?)\)/g,F=/(\(\?)?:\w+/g,$=/\*\w+/g,V=/[\-{}\[\]+?.,\\\^$|#\s]/g;i.extend(A.prototype,a,{initialize:function(){},route:function(t,n,r){i.isRegExp(t)||(t=this._routeToRegExp(t)),i.isFunction(n)&&(r=n,n=""),r||(r=this[n]);var s=this;return e.history.route(t,function(i){var o=s._extractParameters(t,i);s.execute(r,o,n)!==!1&&(s.trigger.apply(s,["route:"+n].concat(o)),s.trigger("route",n,o),e.history.trigger("route",s,n,o))}),this},execute:function(t,e){t&&t.apply(this,e)},navigate:function(t,i){return e.history.navigate(t,i),this},_bindRoutes:function(){if(this.routes){this.routes=i.result(this,"routes");for(var t,e=i.keys(this.routes);null!=(t=e.pop());)this.route(t,this.routes[t])}},_routeToRegExp:function(t){return t=t.replace(V,"\\$&").replace(T,"(?:$1)?").replace(F,function(t,e){return e?t:"([^/?]+)"}).replace($,"([^?]*?)"),new RegExp("^"+t+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(t,e){var n=t.exec(e).slice(1);return i.map(n,function(t,e){return e===n.length-1?t||null:t?decodeURIComponent(t):null})}});var M=e.History=function(){this.handlers=[],i.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},P=/^[#\/]|\s+$/g,B=/^\/+|\/+$/g,R=/#.*$/;M.started=!1,i.extend(M.prototype,a,{interval:50,atRoot:function(){var t=this.location.pathname.replace(/[^\/]$/,"$&/");return t===this.root&&!this.getSearch()},matchRoot:function(){var t=this.decodeFragment(this.location.pathname),e=t.slice(0,this.root.length-1)+"/";return e===this.root},decodeFragment:function(t){return decodeURI(t.replace(/%25/g,"%2525"))},getSearch:function(){var t=this.location.href.replace(/#.*/,"").match(/\?.+/);return t?t[0]:""},getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getPath:function(){var t=this.decodeFragment(this.location.pathname+this.getSearch()).slice(this.root.length-1);return"/"===t.charAt(0)?t.slice(1):t},getFragment:function(t){return null==t&&(t=this._usePushState||!this._wantsHashChange?this.getPath():this.getHash()),t.replace(P,"")},start:function(t){if(M.started)throw new Error("Backbone.history has already been started");if(M.started=!0,this.options=i.extend({root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._hasHashChange="onhashchange"in window,this._useHashChange=this._wantsHashChange&&this._hasHashChange,this._wantsPushState=!!this.options.pushState,this._hasPushState=!(!this.history||!this.history.pushState),this._usePushState=this._wantsPushState&&this._hasPushState,this.fragment=this.getFragment(),this.root=("/"+this.root+"/").replace(B,"/"),this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot()){var e=this.root.slice(0,-1)||"/";return this.location.replace(e+"#"+this.getPath()),!0}this._hasPushState&&this.atRoot()&&this.navigate(this.getHash(),{replace:!0})}if(!this._hasHashChange&&this._wantsHashChange&&!this._usePushState){var n=document.createElement("iframe");n.src="javascript:0",n.style.display="none",n.tabIndex=-1;var r=document.body;this.iframe=r.insertBefore(n,r.firstChild).contentWindow,this.iframe.document.open().close(),this.iframe.location.hash="#"+this.fragment}var s=window.addEventListener||function(t,e){return attachEvent("on"+t,e)};return this._usePushState?s("popstate",this.checkUrl,!1):this._useHashChange&&!this.iframe?s("hashchange",this.checkUrl,!1):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.options.silent?void 0:this.loadUrl()},stop:function(){var t=window.removeEventListener||function(t,e){return detachEvent("on"+t,e)};this._usePushState?t("popstate",this.checkUrl,!1):this._useHashChange&&!this.iframe&&t("hashchange",this.checkUrl,!1),this.iframe&&(document.body.removeChild(this.iframe.frameElement),this.iframe=null),this._checkUrlInterval&&clearInterval(this._checkUrlInterval),M.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(){var t=this.getFragment();return t===this.fragment&&this.iframe&&(t=this.getHash(this.iframe)),t===this.fragment?!1:(this.iframe&&this.navigate(t),void this.loadUrl())},loadUrl:function(t){return this.matchRoot()?(t=this.fragment=this.getFragment(t),i.any(this.handlers,function(e){return e.route.test(t)?(e.callback(t),!0):void 0})):!1},navigate:function(t,e){if(!M.started)return!1;e&&e!==!0||(e={trigger:!!e}),t=this.getFragment(t||"");var i=this.root;(""===t||"?"===t.charAt(0))&&(i=i.slice(0,-1)||"/");var n=i+t;if(t=this.decodeFragment(t.replace(R,"")),this.fragment!==t){if(this.fragment=t,this._usePushState)this.history[e.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getHash(this.iframe)&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,t,e.replace))}return e.trigger?this.loadUrl(t):void 0}},_updateHash:function(t,e,i){if(i){var n=t.href.replace(/(javascript:|#).*$/,"");t.replace(n+"#"+e)}else t.hash="#"+e}}),e.history=new M;var N=function(t,e){var n,r=this;n=t&&i.has(t,"constructor")?t.constructor:function(){return r.apply(this,arguments)},i.extend(n,r,e);var s=function(){this.constructor=n};return s.prototype=r.prototype,n.prototype=new s,t&&i.extend(n.prototype,t),n.__super__=r.prototype,n};b.extend=C.extend=A.extend=x.extend=M.extend=N;var O=function(){throw new Error('A "url" property or function must be specified')},U=function(t,e){var i=e.error;e.error=function(n){i&&i.call(e.context,t,n,e),t.trigger("error",t,n,e)}};return e}),define("readium_plugin_annotations/annotations_module",["backbone"],function(t){var e=function(e,i,n){var r={};r.TextLineInferrer=t.Model.extend({initialize:function(){},inferLines:function(t){for(var e,i,n,r=[],s=t.length,o=0,a=0;s-1>=a;a++){i=t[a],n=!1;for(var h=0;o-1>=h;h++)if(e=r[h],this.includeRectInLine(e,i.top,i.left,i.width,i.height)){this.expandLine(e,i.left,i.top,i.width,i.height),n=!0;break}n||(r.push(this.createNewLine(i.left,i.top,i.width,i.height)),o+=1)}return r},includeRectInLine:function(t,e,i,n,r){return this.rectIsWithinLineVertically(e,r,t.maxTop,t.maxBottom)&&this.rectIsWithinLineHorizontally(i,n,t.left,t.width,t.avgHeight)?!0:!1},rectIsWithinLineVertically:function(t,e,i,n){var r=t+e,s=n-i,o=.75*s/2,a=.75*e/2;return t+=a,r-=a,i+=o,n-=o,t===i&&r===n?!0:i>t&&n>r&&r>i?!0:t>i&&r>n&&n>t?!0:t>i&&n>r?!0:i>t&&r>n?!0:!1},rectIsWithinLineHorizontally:function(t,e,i,n,r){var s=2*r,o=t+e,a=t+n;return i-o>s?!1:t-a>s?!1:!0},createNewLine:function(t,e,i,n){var r=e+n;return{left:t,startTop:e,width:i,avgHeight:n,maxTop:e,maxBottom:r,numRects:1}},expandLine:function(t,e,i,n,r){var s=(t.left+t.width,e+n),o=i+r,a=t.numRects+1,h=t.avgHeight*t.numRects,l=(h+r)/a;return t.avgHeight=l,t.numRects=a,t=this.expandLineVertically(t,i,o),t=this.expandLineHorizontally(t,e,s)},expandLineVertically:function(t,e,i){return e<t.maxTop&&(t.maxTop=e),i>t.maxBottom&&(t.maxBottom=i),t},expandLineHorizontally:function(t,e,i){var n=t.left<=e?t.left:e,r=t.left+t.width,s=r>=i?r:i,o=s-n;return t.left=n,t.width=o,t}}),r.Highlight=t.Model.extend({defaults:{isVisible:!1},initialize:function(){}}),r.HighlightGroup=t.Model.extend({defaults:function(){return{selectedNodes:[],highlightViews:[]}},initialize:function(t){this.set("scale",t.scale),this.constructHighlightViews()},highlightGroupCallback:function(t){var e=this;return"click"===t.type?void e.get("bbPageSetView").trigger("annotationClicked","highlight",e.get("CFI"),e.get("id"),t):"contextmenu"===t.type?void e.get("bbPageSetView").trigger("annotationRightClicked","highlight",e.get("CFI"),e.get("id"),t):void _.each(this.get("highlightViews"),function(e){"mouseenter"===t.type?e.setHoverHighlight():"mouseleave"===t.type&&e.setBaseHighlight()})},constructHighlightViews:function(){var t,e,i=this,n=[];_.each(this.get("selectedNodes"),function(t){var e,i=document.createRange();i.selectNodeContents(t),e=i.getClientRects(),_.each(e,function(t){n.push(t)})}),t=new r.TextLineInferrer,e=t.inferLines(n);var s=this.get("scale");_.each(e,function(t){var e=t.startTop/s,n=t.left/s,o=t.avgHeight/s,a=t.width/s,h=new r.HighlightView({CFI:i.get("CFI"),top:e+i.get("offsetTopAddition"),left:n+i.get("offsetLeftAddition"),height:o,width:a,styles:i.get("styles"),highlightGroupCallback:i.highlightGroupCallback,callbackContext:i});i.get("highlightViews").push(h)})},resetHighlights:function(t,e,i){e&&this.set({offsetTopAddition:e}),i&&this.set({offsetLeftAddition:i}),this.destroyCurrentHighlights(),this.constructHighlightViews(),this.renderHighlights(t)},destroyCurrentHighlights:function(){_.each(this.get("highlightViews"),function(t){t.remove(),t.off()}),this.get("highlightViews").length=0},renderHighlights:function(t){_.each(this.get("highlightViews"),function(e){$(t).append(e.render())})},toInfo:function(){return{id:this.get("id"),type:"highlight",CFI:this.get("CFI")}},setStyles:function(t){var e=this.get("highlightViews");this.set({styles:t}),_.each(e,function(e){e.setStyles(t)})}}),r.Underline=t.Model.extend({defaults:{isVisible:!1},initialize:function(){}}),r.UnderlineGroup=t.Model.extend({defaults:function(){return{selectedNodes:[],underlineViews:[]}},initialize:function(){this.constructUnderlineViews()},underlineGroupCallback:function(t){var e=this;return"click"===t.type?void e.get("bbPageSetView").trigger("annotationClicked","underline",e.get("CFI"),e.get("id"),t):void _.each(this.get("underlineViews"),function(e){"mouseenter"===t.type?e.setHoverUnderline():"mouseleave"===t.type&&e.setBaseUnderline()})},constructUnderlineViews:function(){var t,e,i=this,n=[];_.each(this.get("selectedNodes"),function(t){var e,i=document.createRange();i.selectNodeContents(t),e=i.getClientRects(),_.each(e,function(t){n.push(t)})}),t=new r.TextLineInferrer,e=t.inferLines(n),_.each(e,function(t){var e=t.startTop,n=t.left,s=t.avgHeight,o=t.width,a=new r.UnderlineView({CFI:i.get("CFI"),top:e+i.get("offsetTopAddition"),left:n+i.get("offsetLeftAddition"),height:s,width:o,styles:i.get("styles"),underlineGroupCallback:i.underlineGroupCallback,callbackContext:i});i.get("underlineViews").push(a)})},resetUnderlines:function(t,e,i){e&&this.set({offsetTopAddition:e}),i&&this.set({offsetLeftAddition:i}),this.destroyCurrentUnderlines(),this.constructUnderlineViews(),this.renderUnderlines(t)},destroyCurrentUnderlines:function(){_.each(this.get("underlineViews"),function(t){t.remove(),t.off()}),this.get("underlineViews").length=0},renderUnderlines:function(t){_.each(this.get("underlineViews"),function(e){$(t).append(e.render())})},toInfo:function(){return{id:this.get("id"),type:"underline",CFI:this.get("CFI")}},setStyles:function(t){var e=this.get("underlineViews");this.set({styles:t}),_.each(e,function(e){e.setStyles(t)})}}),r.Bookmark=t.Model.extend({defaults:{isVisible:!1,bookmarkCenteringAdjustment:15,bookmarkTopAdjustment:45},initialize:function(){},getAbsoluteTop:function(){var t=$(this.get("targetElement")).offset().top,e=this.get("offsetTopAddition")+t-this.get("bookmarkTopAdjustment");return e},getAbsoluteLeft:function(){var t=$(this.get("targetElement")).offset().left,e=this.get("offsetLeftAddition")+t-this.get("bookmarkCenteringAdjustment");return e},toInfo:function(){return{id:this.get("id"),type:"bookmark",CFI:this.get("CFI")}}}),r.ReflowableAnnotations=t.Model.extend({initialize:function(){this.epubCFI=EPUBcfi,this.annotations=new r.Annotations({offsetTopAddition:0,offsetLeftAddition:0,readerBoundElement:$("html",this.get("contentDocumentDOM"))[0],scale:0,bbPageSetView:this.get("bbPageSetView")});var t=this.get("annotationCSSUrl");t&&this.injectAnnotationCSS(t);var e=$(this.get("contentDocumentDOM")),i=this;e.on("mouseup",function(t){var e=i.getCurrentSelectionRange();void 0!==e&&e.startOffset-e.endOffset&&i.annotations.get("bbPageSetView").trigger("textSelectionEvent",t)})},redraw:function(){var t=-this.getPaginationLeftOffset();this.annotations.redrawAnnotations(0,t)},removeHighlight:function(t){return this.annotations.removeHighlight(t)},addHighlight:function(t,e,i,n){var r,s,o,a,h,l=this.getRangeStartMarker(t,e),u=this.getRangeEndMarker(t,e),c=$(this.get("contentDocumentDOM")),d=$("html",c).css("-webkit-transform"),g=new WebKitCSSMatrix(d).a;this.set("scale",g);try{return r=this.epubCFI.injectRangeElements(t,this.get("contentDocumentDOM"),l,u,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),o=r.startElement.nextSibling?r.startElement.nextSibling:r.startElement,a=r.endElement.previousSibling?r.endElement.previousSibling:r.endElement,s=document.createRange(),s.setStart(o,0),s.setEnd(a,a.length),selectionInfo=this.getSelectionInfo(s),h=-this.getPaginationLeftOffset(),"highlight"===i?(this.annotations.set("scale",this.get("scale")),this.annotations.addHighlight(t,selectionInfo.selectedElements,e,0,h,r.startElement,r.endElement,n)):"underline"===i&&this.annotations.addUnderline(t,selectionInfo.selectedElements,e,0,h,n),{CFI:t,selectedElements:selectionInfo.selectedElements}}catch(f){console.log(f.message)}},addBookmark:function(t,e,i){var n,r,s=this.getBookmarkMarker(t,e);try{return n=this.epubCFI.injectElement(t,this.get("contentDocumentDOM"),s,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),r=-this.getPaginationLeftOffset(),this.annotations.addBookmark(t,n[0],e,0,r,i),{CFI:t,selectedElements:n[0]}}catch(o){console.log(o.message)}},addImageAnnotation:function(t,e){{var i;this.getBookmarkMarker(t,e)}try{return i=this.epubCFI.getTargetElement(t,this.get("contentDocumentDOM"),["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),this.annotations.addImageAnnotation(t,i[0],e),{CFI:t,selectedElements:i[0]}}catch(n){console.log(n.message)}},getCurrentSelectionCFI:function(){var t,e=this.getCurrentSelectionRange();return e&&(selectionInfo=this.getSelectionInfo(e),t=selectionInfo.CFI),t},getCurrentSelectionOffsetCFI:function(){var t,e=this.getCurrentSelectionRange();return e&&(t=this.generateCharOffsetCFI(e)),t},addSelectionHighlight:function(t,e,i){var n,r,s,o,a="/99!",h=this.getCurrentSelectionRange();if(h)return s=this.getSelectionInfo(h),n=s.CFI,r="epubcfi("+a+n+")","highlight"===e?o=this.addHighlight(r,t,e,i):"underline"===e&&(o=this.addHighlight(r,t,e,i)),o.CFI=n,o;throw new Error("Nothing selected")},addSelectionBookmark:function(t,e){var i,n,r,s="/99!",o=this.getCurrentSelectionRange();if(o)return i=this.generateCharOffsetCFI(o),n="epubcfi("+s+i+")",r=this.addBookmark(n,t,e),r.CFI=i,r;throw new Error("Nothing selected")},addSelectionImageAnnotation:function(t){var e,i,n,r,s,o="/99!",a=this.getCurrentSelectionRange();if(a)return n=this.getSelectionInfo(a,["img"]),s=n.selectedElements[0],e=this.epubCFI.generateElementCFIComponent(s,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),i="epubcfi("+o+e+")",r=this.addImageAnnotation(i,t),r.CFI=e,r;throw new Error("Nothing selected")},updateAnnotationView:function(t,e){var i=this.annotations.updateAnnotationView(t,e);return i},getSelectionInfo:function(t,e){var i=this.generateRangeCFI(t),n={startElementFound:!1,endElementFound:!1},r=[];if(!e)var e=["text"];return this.findSelectedElements(t.commonAncestorContainer,t.startContainer,t.endContainer,n,r,e),{CFI:i,selectedElements:r}},generateRangeCFI:function(t){var e,i,n,r=t.startContainer,s=t.endContainer;if(r.nodeType===Node.TEXT_NODE&&s.nodeType===Node.TEXT_NODE)return e=t.startOffset,i=t.endOffset,n=this.epubCFI.generateCharOffsetRangeComponent(r,e,s,i,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);throw new Error("Selection start and end must be text nodes")},generateCharOffsetCFI:function(t){var e,i=t.startContainer,n=t.startOffset;
return i.nodeType===Node.TEXT_NODE&&(e=this.epubCFI.generateCharacterOffsetCFIComponent(i,n,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"])),e},findSelectedElements:function(t,e,i,n,r,s){return t===e&&(n.startElementFound=!0),n.startElementFound===!0&&this.addElement(t,r,s),t===i?void(n.endElementFound=!0):void(t.firstChild&&(this.findSelectedElements(t.firstChild,e,i,n,r,s),n.endElementFound)||t.nextSibling&&(this.findSelectedElements(t.nextSibling,e,i,n,r,s),n.endElementFound))},addElement:function(t,e,i){_.each(i,function(i){"text"===i?t.nodeType===Node.TEXT_NODE&&e.push(t):$(t).is(i)&&e.push(t)})},getCurrentSelectionRange:function(){var t,e=this.get("contentDocumentDOM");return e.getSelection?(t=e.getSelection(),t&&t.rangeCount&&t.anchorOffset!==t.focusOffset?t.getRangeAt(0):void 0):e.selection?e.selection.createRange():void 0},getPaginationLeftOffset:function(){var t=$("html",this.get("contentDocumentDOM")),e=t.css("left"),i=parseInt(e.replace("px",""));return i},getBookmarkMarker:function(t,e){return"<span class='bookmark-marker cfi-marker' id='"+e+"' data-cfi='"+t+"'></span>"},getRangeStartMarker:function(t,e){return"<span class='range-start-marker cfi-marker' id='start-"+e+"' data-cfi='"+t+"'></span>"},getRangeEndMarker:function(t,e){return"<span class='range-end-marker cfi-marker' id='end-"+e+"' data-cfi='"+t+"'></span>"},injectAnnotationCSS:function(t){var e=$("head",this.get("contentDocumentDOM"));e.append($("<link/>",{rel:"stylesheet",href:t,type:"text/css"}))}}),r.Annotations=t.Model.extend({defaults:function(){return{bookmarkViews:[],highlights:[],markers:{},underlines:[],imageAnnotations:[],annotationHash:{},offsetTopAddition:0,offsetLeftAddition:0,readerBoundElement:void 0}},initialize:function(){},remove:function(){_.each(this.get("highlights"),function(t){t.remove()})},redrawAnnotations:function(t,e){var i=this;_.each(this.get("highlights"),function(n){n.resetHighlights(i.get("readerBoundElement"),t,e)}),_.each(this.get("bookmarkViews"),function(i){i.resetBookmark(t,e)}),_.each(this.get("underlines"),function(n){n.resetUnderlines(i.get("readerBoundElement"),t,e)})},getBookmark:function(t){var e=this.get("annotationHash")[t];return e?e.bookmark.toInfo():void 0},getHighlight:function(t){var e=this.get("annotationHash")[t];return e?e.toInfo():void 0},getUnderline:function(t){var e=this.get("annotationHash")[t];return e?e.toInfo():void 0},getBookmarks:function(){var t=[];return _.each(this.get("bookmarkViews"),function(e){t.push(e.bookmark.toInfo())}),t},getHighlights:function(){var t=[];return _.each(this.get("highlights"),function(e){t.push(e.toInfo())}),t},getUnderlines:function(){var t=[];return _.each(this.get("underlines"),function(e){t.push(e.toInfo())}),t},getImageAnnotations:function(){var t=[];return _.each(this.get("imageAnnotations"),function(e){t.push(e.toInfo())}),t},addBookmark:function(t,e,i,n,s,o){n||(n=this.get("offsetTopAddition")),s||(s=this.get("offsetLeftAddition")),i=i.toString(),this.validateAnnotationId(i);var a=new r.BookmarkView({CFI:t,targetElement:e,offsetTopAddition:n,offsetLeftAddition:s,id:i.toString(),bbPageSetView:this.get("bbPageSetView"),type:o});this.get("annotationHash")[i]=a,this.get("bookmarkViews").push(a),$(this.get("readerBoundElement")).append(a.render())},removeHighlight:function(t){var e=this.get("annotationHash"),i=this.get("highlights"),n=this.get("markers");if(n[t]){var r=n[t].startMarker,s=n[t].endMarker;r.parentNode.removeChild(r),s.parentNode.removeChild(s),delete n[t],delete e[t],i=_.reject(i,function(e){return e.id==t?(e.destroyCurrentHighlights(),!0):!1}),this.set("highlights",i)}},addHighlight:function(t,e,i,n,s,o,a,h){n||(n=this.get("offsetTopAddition")),s||(s=this.get("offsetLeftAddition")),i=i.toString(),this.validateAnnotationId(i);var l=new r.HighlightGroup({CFI:t,selectedNodes:e,offsetTopAddition:n,offsetLeftAddition:s,styles:h,id:i,bbPageSetView:this.get("bbPageSetView"),scale:this.get("scale")});this.get("annotationHash")[i]=l,this.get("highlights").push(l),this.get("markers")[i]={startMarker:o,endMarker:a},l.renderHighlights(this.get("readerBoundElement"))},addUnderline:function(t,e,i,n,s,o){n||(n=this.get("offsetTopAddition")),s||(s=this.get("offsetLeftAddition")),i=i.toString(),this.validateAnnotationId(i);var a=new r.UnderlineGroup({CFI:t,selectedNodes:e,offsetTopAddition:n,offsetLeftAddition:s,styles:o,id:i,bbPageSetView:this.get("bbPageSetView")});this.get("annotationHash")[i]=a,this.get("underlines").push(a),a.renderUnderlines(this.get("readerBoundElement"))},addImageAnnotation:function(t,e,i){i=i.toString(),this.validateAnnotationId(i);var n=new r.ImageAnnotation({CFI:t,imageNode:e,id:i,bbPageSetView:this.get("bbPageSetView")});this.get("annotationHash")[i]=n,this.get("imageAnnotations").push(n),n.render()},updateAnnotationView:function(t,e){var i=this.get("annotationHash")[t];return i.setStyles(e),i},validateAnnotationId:function(t){if(this.get("annotationHash")[t])throw new Error("That annotation id already exists; annotation not added")}}),r.BookmarkView=t.View.extend({el:"<div></div>",events:{mouseenter:"setHoverBookmark",mouseleave:"setBaseBookmark",click:"clickHandler"},initialize:function(t){this.bookmark=new r.Bookmark({CFI:t.CFI,targetElement:t.targetElement,offsetTopAddition:t.offsetTopAddition,offsetLeftAddition:t.offsetLeftAddition,id:t.id,bbPageSetView:t.bbPageSetView,type:t.type})},resetBookmark:function(t,e){t&&this.bookmark.set({offsetTopAddition:t}),e&&this.bookmark.set({offsetLeftAddition:e}),this.setCSS()},render:function(){return this.setCSS(),this.el},setCSS:function(){var t,e;"comment"===this.bookmark.get("type")?(t=this.bookmark.getAbsoluteTop(),e=this.bookmark.getAbsoluteLeft(),this.$el.css({top:t+"px",left:e+"px",width:"50px",height:"50px",position:"absolute"}),this.$el.addClass("comment")):this.$el.addClass("bookmark")},setHoverBookmark:function(t){t.stopPropagation(),this.$el.hasClass("comment")&&(this.$el.removeClass("comment"),this.$el.addClass("hover-comment"))},setBaseBookmark:function(t){t.stopPropagation(),this.$el.hasClass("hover-comment")&&(this.$el.removeClass("hover-comment"),this.$el.addClass("comment"))},clickHandler:function(t){t.stopPropagation();var e;e="comment"===this.bookmark.get("type")?"comment":"bookmark",this.bookmark.get("bbPageSetView").trigger("annotationClicked",e,this.bookmark.get("CFI"),this.bookmark.get("id"),this.$el.css("top"),this.$el.css("left"),t)}}),r.HighlightView=t.View.extend({el:"<div class='highlight'></div>",events:{mouseenter:"highlightEvent",mouseleave:"highlightEvent",click:"highlightEvent",contextmenu:"highlightEvent"},initialize:function(t){this.highlight=new r.Highlight({CFI:t.CFI,top:t.top,left:t.left,height:t.height,width:t.width,styles:t.styles,highlightGroupCallback:t.highlightGroupCallback,callbackContext:t.callbackContext})},render:function(){return this.setCSS(),this.el},resetPosition:function(t,e,i,n){this.highlight.set({top:t,left:e,height:i,width:n}),this.setCSS()},setStyles:function(t){this.highlight.set({styles:t}),this.render()},setCSS:function(){var t=this.highlight.get("styles")||{};this.$el.css({top:this.highlight.get("top")+"px",left:this.highlight.get("left")+"px",height:this.highlight.get("height")+"px",width:this.highlight.get("width")+"px","background-color":t.fill_color||"normal"})},setBaseHighlight:function(){this.$el.addClass("highlight"),this.$el.removeClass("hover-highlight")},setHoverHighlight:function(){this.$el.addClass("hover-highlight"),this.$el.removeClass("highlight")},highlightEvent:function(t){t.stopPropagation();var e=(this.highlight.get("highlightGroupCallback"),this.highlight.get("callbackContext"));e.highlightGroupCallback(t)}}),r.UnderlineView=t.View.extend({el:"<div class='underline-range'>              <div class='transparent-part'></div>              <div class='underline-part'></div>           </div>",events:{mouseenter:"underlineEvent",mouseleave:"underlineEvent",click:"underlineEvent"},initialize:function(t){this.underline=new r.Underline({CFI:t.CFI,top:t.top,left:t.left,height:t.height,width:t.width,styles:t.styles,underlineGroupCallback:t.underlineGroupCallback,callbackContext:t.callbackContext}),this.$transparentElement=$(".transparent-part",this.$el),this.$underlineElement=$(".underline-part",this.$el)},render:function(){return this.setCSS(),this.el},resetPosition:function(t,e,i,n){this.underline.set({top:t,left:e,height:i,width:n}),this.setCSS()},setStyles:function(t){this.underline.set({styles:t}),this.render()},setCSS:function(){var t=this.underline.get("styles")||{};this.$el.css({top:this.underline.get("top")+"px",left:this.underline.get("left")+"px",height:this.underline.get("height")+"px",width:this.underline.get("width")+"px"}),this.$underlineElement.css({"background-color":t.fill_color||"normal"}),this.$underlineElement.addClass("underline")},underlineEvent:function(t){t.stopPropagation();var e=(this.underline.get("underlineGroupCallback"),this.underline.get("callbackContext"));e.underlineGroupCallback(t)},setBaseUnderline:function(){this.$underlineElement.addClass("underline"),this.$underlineElement.removeClass("hover-underline")},setHoverUnderline:function(){this.$underlineElement.addClass("hover-underline"),this.$underlineElement.removeClass("underline")}}),r.ImageAnnotation=t.Model.extend({initialize:function(){var t=this,e=$(this.get("imageNode"));e.on("mouseenter",function(){t.setMouseenterBorder()}),e.on("mouseleave",function(){t.setMouseleaveBorder()}),e.on("click",function(){t.get("bbPageSetView").trigger("annotationClicked","image",t.get("CFI"),t.get("id"),event)})},render:function(){this.setCSS()},setCSS:function(){$(this.get("imageNode")).css({border:"5px solid rgb(255, 0, 0)",border:"5px solid rgba(255, 0, 0, 0.2)","-webkit-background-clip":"padding-box","background-clip":"padding-box"})},setMouseenterBorder:function(){$(this.get("imageNode")).css({border:"5px solid rgba(255, 0, 0, 0.4)"})},setMouseleaveBorder:function(){$(this.get("imageNode")).css({border:"5px solid rgba(255, 0, 0, 0.2)"})}});var s=new r.ReflowableAnnotations({contentDocumentDOM:e,bbPageSetView:i,annotationCSSUrl:n});return{addSelectionHighlight:function(t,e,i){return s.addSelectionHighlight(t,e,i)},addSelectionBookmark:function(t,e){return s.addSelectionBookmark(t,e)},addSelectionImageAnnotation:function(t){return s.addSelectionImageAnnotation(t)},addHighlight:function(t,e,i,n){return s.addHighlight(t,e,i,n)},addBookmark:function(t,e,i){return s.addBookmark(t,e,i)},addImageAnnotation:function(t,e){return s.addImageAnnotation(t,e)},updateAnnotationView:function(t,e){return s.updateAnnotationView(t,e)},redraw:function(){return s.redraw()},getBookmark:function(t){return s.annotations.getBookmark(t)},getBookmarks:function(){return s.annotations.getBookmarks()},getHighlight:function(t){return s.annotations.getHighlight(t)},getHighlights:function(){return s.annotations.getHighlights()},getUnderline:function(t){return s.annotations.getUnderline(t)},getUnderlines:function(){return s.annotations.getUnderlines()},getImageAnnotation:function(){},getImageAnnotations:function(){},removeAnnotation:function(t){return s.remove(t)},getCurrentSelectionCFI:function(){return s.getCurrentSelectionCFI()},getCurrentSelectionOffsetCFI:function(){return s.getCurrentSelectionOffsetCFI()},removeHighlight:function(t){return s.removeHighlight(t)}}};return e}),define("readium_plugin_annotations/annotations_manager",["jquery","underscore","eventEmitter","./annotations_module"],function(t,e,i,n){var r=function(t,r){function s(t){var e=new RegExp("^.*!"),i=t.replace(e,""),n=i.substring(0,i.length-1);return n}var o=this,a={},h={},l=t,u=r.annotationCSSUrl;u||console.warn("WARNING! Annotations CSS not supplied. Highlighting is not going to work."),e.extend(this,new i);var c=o.emit,d=function(){var t=Array.prototype.slice.call(arguments);console.debug(t);var e="annotationClicked";if(t.length&&t[0]===e)for(var i in a){var n=t[4],r=t[3],o=t[2],u=t[1];if(a[i].getHighlight(r)){var d=h[i].idref,g=s(o);t=[e,u,d,g,r,n],console.debug("Corrected CFI:"),console.debug(t)}}c.apply(this,t),c.apply(l,t)};this.trigger=d,this.emit=d,this.attachAnnotations=function(t,e){var i=t[0].contentDocument;a[e.index]=new n(i,o,u),h[e.index]=e;for(var r in a)Math.abs(r-r.index)>3&&delete a[r]},this.getCurrentSelectionCfi=function(){for(var t in a){var e=a[t],i=e.getCurrentSelectionCFI();if(i)return{idref:h[t].idref,cfi:i}}return void 0},this.addSelectionHighlight=function(t,e){for(spine in a){var i=a[spine];if(i.getCurrentSelectionCFI()){var n=i.addSelectionHighlight(t,e);return n.idref=h[spine].idref,n}}return void 0},this.addHighlight=function(t,e,i,n,r){for(var o in a)if(h[o].idref===t){var l="epubcfi(/99!"+e+")",u=a[o],c=u.addHighlight(l,i,n,r);return c.idref=t,c.CFI=s(c.CFI),c}return void 0},this.removeHighlight=function(t){var e=void 0;for(var i in a){var n=a[i];e=n.removeHighlight(t)}return e}};return r}),define("readium_plugin_annotations/main",["readium_shared_js/plugins_controller","./annotations_manager"],function(t,e){var i={};return t.register("annotations",function(t){var i,n,r=!1,s=!1;n=function(){function n(){return r||t.plugin.warn("Not initialized!"),r}var o=this;this.initialize=function(n){return r?void t.plugin.warn("Already initialized!"):(i=new e(o,n),s&&t.plugin.warn("Unable to attach to currently loaded content document.\nInitialize the plugin before loading a content document."),void(r=!0))},this.getCurrentSelectionCfi=function(){return n()?i.getCurrentSelectionCfi():void 0},this.addHighlight=function(t,e,r,s,o){return n()?i.addHighlight(t,e,r,s,o):void 0},this.addSelectionHighlight=function(t,e){return n()?i.addSelectionHighlight(t,e):void 0},this.removeHighlight=function(t){return n()?i.removeHighlight(t):void 0}},t.reader.on(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,function(t,e){r?i.attachAnnotations(t,e):s=!0}),t.extendReader(new n)}),i}),define("readium_plugin_annotations",["readium_plugin_annotations/main"],function(t){return t}),define("readium-plugin-annotations",function(){}),require(["readium_plugin_annotations"]);
//# sourceMappingURL=readium-plugin-annotations.js.map